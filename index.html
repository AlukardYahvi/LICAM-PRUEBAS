<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Evaluaci√≥n de Carteles - Simposio M√©dico</title>
    
    <!-- Tailwind CSS y Tipograf√≠a Inter -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Estilos base de Inter y fondo de la app */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        
        /* Fondo llamativo usando la imagen del simposio (DEBE ESTAR EN assets/) */
        #login-bg { 
            background-image: url('assets/simposio_background.jpg'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
        }
        /* Capa de oscuridad sobre el fondo para mejorar contraste del login */
        #login-bg::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(1, 0, 10, 0.75); 
            backdrop-filter: blur(2px);
        }

        /* Estilos de inputs de evaluaci√≥n */
        .score-input { width:100%; padding:.5rem; border-radius:.5rem; border:1px solid #d1d5db; text-align:center; font-weight:600; transition:all .2s; }
        .score-input:focus { border-color:#059669; box-shadow:0 0 0 3px rgba(5,150,105,.2); }
        .score-option { background:#f3f4f6; border:2px solid transparent; cursor:pointer; }
        .score-option.selected { background:#d1fae5; border-color:#059669; color:#065f46; }
        .score-input.has-value { border-color:#059669; box-shadow:0 0 0 1px rgba(5,150,105,.5); }
        .password-container { position: relative; }
        .toggle-password { position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; color:#6b7280; transition:color .15s; z-index: 10; }
        .toggle-password:hover { color:#10b981; }
        
        /* Estilos para Deducciones y Bonificaciones */
        .deduction-card { background-color: #ffeaea; border-left: 4px solid #ef4444; }
        .bonus-card { background-color: #eef2ff; border-left: 4px solid #8b5cf6; }

        /* Estilos del Admin Dashboard */
        .admin-card {
            background-color: white;
            padding: 1.25rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.3s;
        }
        .admin-card:hover {
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }
        .modal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.75rem;
            width: 90%;
            max-width: 450px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            animation: modal-fade 0.3s ease-out;
        }
        @keyframes modal-fade {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        .admin-grid {
            display: grid;
            gap: 1.5rem;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
    </style>

    <!-- Firebase y L√≥gica de la Aplicaci√≥n -->
    <script type="module">
        // IMPORTACIONES MODULARES DE FIREBASE (Versi√≥n 11.6.1)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, getDocs, onSnapshot, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ------------------ CONFIGURA AQU√ç ------------------
        // Usamos la configuraci√≥n inyectada por el entorno
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        
        // URL de Google Sheets configurada
        const GOOGLE_SHEETS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzatgCyA9JOC5NGiaVhyWzBG9V69-jzlyPAW03HtI-_pMKd3K5N8zxai1dUuKNcf_s0/exec';
        
        // DEBES REEMPLAZAR ESTA CONSTANTE con el UID REAL de tu usuario 'admin' en Firebase.
        const ADMIN_ID_FIREBASE = "admin_id_a_reemplazar"; 
        // ----------------------------------------------------

        // Variables globales
        let app = null;
        let db = null;
        let auth = null;
        let currentUserId = null;
        let judgeData = null;

        const JUDGE_STORAGE_KEY = 'symposium_judge_data';
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'symposium-app';

        // -----------------------------------------------------
        // 1. USUARIOS PREDEFINIDOS Y ASIGNACIONES
        // -----------------------------------------------------
        const predefinedUsers = [
            // Jueces de la lista de Cartel/Oral
            { id: 'juez_a', user: 'juez1', pass: 'cartel2025', name: 'Dr. H√©ctor Hern√°ndez', role: 'judge' },
            { id: 'juez_b', user: 'juez2', pass: 'cartel2025', name: 'Dra. Georgina √Ålvarez', role: 'judge' },
            { id: 'juez_c', user: 'juez3', pass: 'cartel2025', name: 'Dr. Ricardo Soto', role: 'judge' },
            { id: 'juez_d', user: 'juez4', pass: 'cartel2025', name: 'Dra. Laura Beltr√°n', role: 'judge' },
            { id: 'juez_e', user: 'juez5', pass: 'cartel2025', name: 'Dr. Miguel Rivas', role: 'judge' },
            { id: 'juez_f', user: 'juez6', pass: 'cartel2025', name: 'Dra. Ana Cort√©s', role: 'judge' },
            { id: 'juez_g', user: 'juez7', pass: 'cartel2025', name: 'Dr. Javier Ponce', role: 'judge' }, // Usado en Oral
            { id: 'juez_h', user: 'juez8', pass: 'cartel2025', name: 'Dra. Sof√≠a Luna', role: 'judge' },
            { id: 'juez_i', user: 'juez9', pass: 'cartel2025', name: 'Dr. Carlos V√©lez', role: 'judge' },
            { id: 'juez_j', user: 'juez10', pass: 'cartel2025', name: 'Dra. Elena Cruz', role: 'judge' },
            { id: 'juez_k', user: 'juez11', pass: 'cartel2025', name: 'Dr. Ra√∫l P√©rez', role: 'judge' },
            { id: 'juez_araceli', user: 'juez_araceli', pass: 'cartel2025', name: 'Araceli Hern√°ndez Zavala', role: 'judge' },
            { id: 'juez_marycarmen', user: 'juez_marycarmen', pass: 'cartel2025', name: 'Marycarmen Godinez Victoria', role: 'judge' },
            { id: 'juez_claudia', user: 'juez_claudia', pass: 'cartel2025', name: 'Claudia Camelia Calzada Mendoza', role: 'judge' },
            { id: 'juez_paola', user: 'juez_paola', pass: 'cartel2025', name: 'Paola Berenice Zarate Segura', role: 'judge' },
            { id: 'juez_ivonne', user: 'juez_ivonne', pass: 'cartel2025', name: 'Ivonne Maciel Arciniega Mart√≠nez', role: 'judge' },
            { id: 'juez_aldo', user: 'juez_aldo', pass: 'cartel2025', name: 'Aldo Arturo Res√©ndiz Albor', role: 'judge' },
            { id: 'juez_javier', user: 'juez_javier', pass: 'cartel2025', name: 'Javier P√©rez Dur√°n', role: 'judge' },
            { id: 'juez_paula', user: 'juez_paula', pass: 'cartel2025', name: 'Paula Salda√±a', role: 'judge' },
            { id: 'juez_elena', user: 'juez_elena', pass: 'cartel2025', name: 'Elena de La Cruz Herrera Cogco', role: 'judge' },
            { id: 'juez_nury', user: 'juez_nury', pass: 'cartel2025', name: 'Nury P√©rez Hern√°ndez', role: 'judge' },
            { id: 'juez_enrique', user: 'juez_enrique', pass: 'cartel2025', name: 'Enrique M√©ndez-Bolaina', role: 'judge' },
            { id: 'juez_edgar', user: 'juez_edgar', pass: 'cartel2025', name: 'Edgar Cano Europa', role: 'judge' },
            { id: 'juez_flores', user: 'juez_flores', pass: 'cartel2025', name: 'Javier Flores Estrada', role: 'judge' },
            { id: 'juez_montoya', user: 'juez_montoya', pass: 'cartel2025', name: 'Araceli Montoya Estrada', role: 'judge' },
            // Admin
            { id: 'admin', user: 'admin', pass: 'admin2025', name: 'Administrador General', role: 'admin', firebaseId: ADMIN_ID_FIREBASE },
        ];

        // 2. TRABAJOS DE EJEMPLO
        const predefinedPosters = [
            // Modalidad Oral (Evaluaci√≥n Conjunta) - Asignados para aparecer en el dashboard de cada juez del grupo
            // Grupo 1: Aldo, Enrique, Elena
            { id: 'II-017-PL-NT', title: 'Mar√≠a Fernanda Cordero Mayorga (Oral)', assignedTo: 'juez_aldo', assignedToGroup: ['juez_aldo', 'juez_enrique', 'juez_elena'], type: 'oral' },
            { id: 'II-021-PL-NT', title: 'Anarely Ram√≠rez Hern√°ndez (Oral)', assignedTo: 'juez_aldo', assignedToGroup: ['juez_aldo', 'juez_enrique', 'juez_elena'], type: 'oral' },
            { id: 'II-030-PL-ET', title: 'Mar√≠a Jos√© Cruz P√©rez (Oral)', assignedTo: 'juez_aldo', assignedToGroup: ['juez_aldo', 'juez_enrique', 'juez_elena'], type: 'oral' },
            { id: 'II-034-PL-MC', title: 'Nadia Ortiz Rosales (Oral)', assignedTo: 'juez_aldo', assignedToGroup: ['juez_aldo', 'juez_enrique', 'juez_elena'], type: 'oral' },
            { id: 'II-040-PL-NT', title: 'Ana Romina Robles Guzm√°n (Oral)', assignedTo: 'juez_aldo', assignedToGroup: ['juez_aldo', 'juez_enrique', 'juez_elena'], type: 'oral' },
            { id: 'II-041-PL-NT', title: 'Natalia Edith Ram√≠rez L√≥pez (Oral)', assignedTo: 'juez_aldo', assignedToGroup: ['juez_aldo', 'juez_enrique', 'juez_elena'], type: 'oral' },
            { id: 'II-042-PL-NT', title: 'Paola Alejandra Regules Cruz (Oral)', assignedTo: 'juez_aldo', assignedToGroup: ['juez_aldo', 'juez_enrique', 'juez_elena'], type: 'oral' },
            { id: 'II-056-PL-NT', title: 'Alan Israel Cruz Bernab√© (Oral)', assignedTo: 'juez_aldo', assignedToGroup: ['juez_aldo', 'juez_enrique', 'juez_elena'], type: 'oral' },
            // Grupo 2: Enrique, Claudia, Juez G
            { id: 'II-037-PP-NT', title: 'Zuri Abigail Gaspar Guti√©rrez (Oral)', assignedTo: 'juez_enrique', assignedToGroup: ['juez_enrique', 'juez_claudia', 'juez_g'], type: 'oral' },
            { id: 'II-052-PP-NT', title: 'Yanai Hern√°ndez Avenda√±o (Oral)', assignedTo: 'juez_enrique', assignedToGroup: ['juez_enrique', 'juez_claudia', 'juez_g'], type: 'oral' },
            { id: 'II-065-PP-MC', title: 'Tahiri Alitzel Mendoza Hern√°ndez (Oral)', assignedTo: 'juez_enrique', assignedToGroup: ['juez_enrique', 'juez_claudia', 'juez_g'], type: 'oral' },
            { id: 'II-073-PP-NT', title: 'Grisle Pe√±aloza Ram√≠rez (Oral)', assignedTo: 'juez_enrique', assignedToGroup: ['juez_enrique', 'juez_claudia', 'juez_g'], type: 'oral' },
            { id: 'II-074-PP-MC', title: 'Iza Fernanda P√©rez Ram√≠rez (Oral)', assignedTo: 'juez_enrique', assignedToGroup: ['juez_enrique', 'juez_claudia', 'juez_g'], type: 'oral' },
            { id: 'II-079-PP-NT', title: 'Samuel Salinas Ramos (Oral)', assignedTo: 'juez_enrique', assignedToGroup: ['juez_enrique', 'juez_claudia', 'juez_g'], type: 'oral' },
            { id: 'II-084-PP-MC', title: 'Carla Arceo Cerna (Oral)', assignedTo: 'juez_enrique', assignedToGroup: ['juez_enrique', 'juez_claudia', 'juez_g'], type: 'oral' },
            { id: 'II-087-PP-NT', title: 'Tabatta Gabriela Orejel Feria (Oral)', assignedTo: 'juez_enrique', assignedToGroup: ['juez_enrique', 'juez_claudia', 'juez_g'], type: 'oral' },
            
            // Modalidad Cartel (Asignaciones exactas)
            { id: 'II-008-PL-MC', title: 'Monserrat Andrea Ortiz Cortes', assignedTo: 'juez_araceli', type: 'cartel' },
            { id: 'II-039-PL-MC', title: 'Ana Camila Ram√≠rez Ortiz', assignedTo: 'juez_araceli', type: 'cartel' },
            
            { id: 'II-009-PL-MC', title: 'Castillo Olvera Itzel Jimena', assignedTo: 'juez_marycarmen', type: 'cartel' },
            { id: 'II-043-PL-NT', title: 'Dilan Rodr√≠guez Lagos', assignedTo: 'juez_marycarmen', type: 'cartel' },
            { id: 'II-047-PP-NT', title: 'V√≠ctor Jes√∫s Escudero Huerta', assignedTo: 'juez_marycarmen', type: 'cartel' },
            { id: 'II-088-PP-MC', title: 'Karen Nayeli Hern√°ndez V√°zquez', assignedTo: 'juez_marycarmen', type: 'cartel' },
            
            { id: 'II-010-PL-NT', title: 'Edgar Valeria de la Cruz', assignedTo: 'juez_claudia', type: 'cartel' },
            { id: 'II-045-PL-NT', title: 'Arianys Carolina Tovar Escobar', assignedTo: 'juez_claudia', type: 'cartel' },
            { id: 'II-049-PP-ET', title: 'Ernesto Santill√°n Arcos', assignedTo: 'juez_claudia', type: 'cartel' },
            { id: 'II-092-PP-GE', title: 'Pahola del Carmen Rodr√≠guez P√©rez', assignedTo: 'juez_claudia', type: 'cartel' },
            
            { id: 'II-012-PL-MC', title: 'Marisol Garay Contreras', assignedTo: 'juez_paola', type: 'cartel' },
            { id: 'II-048-PL-MC', title: 'Anel Camacho Dorantes', assignedTo: 'juez_paola', type: 'cartel' },
            { id: 'II-068-PL-PG', title: 'Mar√≠a Elizabeth S√°nchez Romero', assignedTo: 'juez_paola', type: 'cartel' },
            { id: 'II-004-PP-NT', title: 'Romina Mar√≠a Valladares Ocampo', assignedTo: 'juez_paola', type: 'cartel' },
            { id: 'II-053-PP-GE', title: 'Sally Silva Castro', assignedTo: 'juez_paola', type: 'cartel' },
            { id: 'II-093-PP-NT', title: 'Miguel Andr√©s Vald√©s Guevara', assignedTo: 'juez_paola', type: 'cartel' },
            
            { id: 'II-016-PL-NT', title: 'Natalia Valeria Sillerico Illanes', assignedTo: 'juez_ivonne', type: 'cartel' },
            { id: 'II-050-PL-NT', title: 'Alberto Jaret Mej√≠a Meza', assignedTo: 'juez_ivonne', type: 'cartel' },
            { id: 'II-075-PL-NT', title: 'Negrete Ch√°vez Dalia Isamar', assignedTo: 'juez_ivonne', type: 'cartel' },
            { id: 'II-006-PP-GE', title: 'Juan Pablo Gonz√°lez Dom√≠nguez', assignedTo: 'juez_ivonne', type: 'cartel' },
            { id: 'II-055-PP-MC', title: 'Angelica Casta√±eda de la Fuente', assignedTo: 'juez_ivonne', type: 'cartel' },
            { id: 'II-097-PP-ET', title: 'Lourdes Astrid Serrano Quilant√°n', assignedTo: 'juez_ivonne', type: 'cartel' },

            { id: 'II-020-PL-NT', title: 'Daniela Torres Velasco', assignedTo: 'juez_aldo', type: 'cartel' },
            { id: 'II-051-PL-GE', title: 'Yuleny Cervantes Fosado', assignedTo: 'juez_aldo', type: 'cartel' },
            { id: 'II-076-PL-NT', title: 'Axel Emanuel Moctezuma Garc√≠a', assignedTo: 'juez_aldo', type: 'cartel' },
            { id: 'II-007-PP-NT', title: 'Israel Lara Vega', assignedTo: 'juez_aldo', type: 'cartel' },
            { id: 'II-057-PP-NT', title: 'Goretti Araneth L√≥pez Villafa√±a', assignedTo: 'juez_aldo', type: 'cartel' },
            
            { id: 'II-022-PL-NT', title: 'Astrid Adamari De la rosa Cordero', assignedTo: 'juez_javier', type: 'cartel' },
            { id: 'II-054-PL-NT', title: 'Monserrat Bracho', assignedTo: 'juez_javier', type: 'cartel' },
            { id: 'II-086-PL-ET', title: 'Erick Santiago Mendoza Palacios', assignedTo: 'juez_javier', type: 'cartel' },
            { id: 'II-011-PP-PG', title: 'Ivonne del Socorro Guti√©rrez Ruiz', assignedTo: 'juez_javier', type: 'cartel' },
            { id: 'II-061-PP-NT', title: 'Luis Armando Garc√≠a Pedraza', assignedTo: 'juez_javier', type: 'cartel' },
            
            { id: 'II-024-PL-NT', title: 'Sara Gabriela Guadarrama Tovar', assignedTo: 'juez_paula', type: 'cartel' },
            { id: 'II-058-PL-NT', title: 'Xaris L√≥pez Sol√≠s', assignedTo: 'juez_paula', type: 'cartel' },
            { id: 'II-089-PL-ET', title: 'Jessamyn Reyna Crespo Sandoval', assignedTo: 'juez_paula', type: 'cartel' },
            { id: 'II-013-PP-GE', title: 'Giselle Barrera Z√°rate', assignedTo: 'juez_paula', type: 'cartel' },
            { id: 'II-069-PP-NT', title: 'Guillermina Chavaro Francisco', assignedTo: 'juez_paula', type: 'cartel' },
            
            { id: 'II-025-PL-NT', title: 'Astrid Sophia Careaga Arceo', assignedTo: 'juez_elena', type: 'cartel' },
            { id: 'II-059-PL-NT', title: 'Gillian Yazm√≠n Sosa Maldonado', assignedTo: 'juez_elena', type: 'cartel' },
            { id: 'II-070-PP-NT', title: 'Mar√≠a de los √Ångeles Rodr√≠guez Garc√≠a', assignedTo: 'juez_elena', type: 'cartel' },
            { id: 'II-091-PL-ET', title: 'Joslay Cabrera Caballero', assignedTo: 'juez_elena', type: 'cartel' },
            { id: 'II-014-PP-GE', title: 'Jos√© Luis Marroqu√≠n Caratachea', assignedTo: 'juez_elena', type: 'cartel' },
            
            { id: 'II-027-PL-MC', title: 'Elena Abigail P√©rez Ham', assignedTo: 'juez_nury', type: 'cartel' },
            { id: 'II-060-PL-GE', title: 'Jos√© Juli√°n L√≥pez Hern√°ndez', assignedTo: 'juez_nury', type: 'cartel' },
            { id: 'II-094-PL-NT', title: 'Anaya Herrera Vania Paola', assignedTo: 'juez_nury', type: 'cartel' },
            { id: 'II-015-PP-PG', title: 'Ram√≥n L√≥pez Ocampo', assignedTo: 'juez_nury', type: 'cartel' },
            { id: 'II-072-PP-NT', title: 'Karla Reyes Alvarado', assignedTo: 'juez_nury', type: 'cartel' },
            
            { id: 'II-029-PL-ET', title: 'F√°tima Monserrat √Åvila Quintero', assignedTo: 'juez_enrique', type: 'cartel' },
            { id: 'II-062-PL-NT', title: 'Laura Alessandra Ram√≠rez V√°zquez', assignedTo: 'juez_enrique', type: 'cartel' },
            { id: 'II-095-PL-ET', title: 'Merary Jael Diaz Espinoza', assignedTo: 'juez_enrique', type: 'cartel' },
            { id: 'II-019-PP-ET', title: 'Rogelio Iv√°n G√≥mez Escobedo', assignedTo: 'juez_enrique', type: 'cartel' },
            { id: 'II-081-PP-NT', title: 'Stefany Alamilla Cuellar', assignedTo: 'juez_enrique', type: 'cartel' },
            
            { id: 'II-032-PL-NT', title: 'Paz Pe√±a Dana Paola', assignedTo: 'juez_edgar', type: 'cartel' },
            { id: 'II-064-PL-NT', title: 'Anayeli Panzo Mayahua', assignedTo: 'juez_edgar', type: 'cartel' },
            { id: 'II-096-PL-ET', title: 'Nadia Meritxell Vargas Freyre', assignedTo: 'juez_edgar', type: 'cartel' },
            { id: 'II-023-PP-GE', title: 'Itzel Feria Figueroa', assignedTo: 'juez_edgar', type: 'cartel' },
            { id: 'II-082-PP-NT', title: 'Marcos Uriel Gonz√°lez P√©rez', assignedTo: 'juez_edgar', type: 'cartel' },
            
            { id: 'II-033-PL-ET', title: 'Mariana Berenice L√≥pez Arenas', assignedTo: 'juez_flores', type: 'cartel' },
            { id: 'II-066-PL-NT', title: 'Valery Rosales Rojas', assignedTo: 'juez_flores', type: 'cartel' },
            { id: 'II-098-PL-NT', title: 'Valeria Yareli Salazar Segura', assignedTo: 'juez_flores', type: 'cartel' },
            { id: 'II-036-PP-NT', title: 'Luis Jos√© Pinto Garc√≠a', assignedTo: 'juez_flores', type: 'cartel' },
            { id: 'II-083-PP-NT', title: 'Andrea Capaceta Osuna', assignedTo: 'juez_flores', type: 'cartel' },
            
            { id: 'II-001-PP-NT', title: 'Alexis Alejandro Garc√≠a Rivero', assignedTo: 'juez_montoya', type: 'cartel' },
            { id: 'II-044-PP-ET', title: 'Luis Mario S√°nchez Palestino', assignedTo: 'juez_montoya', type: 'cartel' },
            { id: 'II-085-PP-NT', title: 'Citlali G√≥mez M√°rquez', assignedTo: 'juez_montoya', type: 'cartel' },
        ];
        
        // 3. CRITERIOS DE EVALUACI√ìN (CARTEL) - Max 100 Base
        const evaluationCriteriaCartel = [
            // I. Fondo (Contenido Cient√≠fico) - Max 55 puntos
            { id: 'titulo', category: 'I. Fondo (Contenido Cient√≠fico)', max: 5, type: '3-point', options: [0,3,5], name: 'T√≠tulo y Congruencia de Contenido', desc: 'Claridad, pertinencia, y correcta identificaci√≥n de autores y afiliaci√≥n.' },
            { id: 'introduccion', category: 'I. Fondo (Contenido Cient√≠fico)', max: 15, type: 'full', name: 'Introducci√≥n y Antecedentes', desc: 'Contextualizaci√≥n, justificaci√≥n y revisi√≥n actualizada de la literatura.' },
            { id: 'metodologia', category: 'I. Fondo (Contenido Cient√≠fico)', max: 15, type: 'full', name: 'Metodolog√≠a', desc: 'Claridad en el dise√±o, selecci√≥n de muestra, procedimientos, y cumplimiento √©tico.' },
            { id: 'resultados', category: 'I. Fondo (Contenido Cient√≠fico)', max: 15, type: 'full', name: 'Resultados', desc: 'Presentaci√≥n l√≥gica, objetiva y completa de datos primarios o secundarios.' },
            { id: 'conclusiones', category: 'I. Fondo (Contenido Cient√≠fico)', max: 5, type: '3-point', options: [0,3,5], name: 'Conclusiones', desc: 'Conclusiones claras, derivadas y consistentes con los resultados obtenidos.' },
            
            // II. Forma (Dise√±o y Formato) - Max 35 puntos
            { id: 'banner', category: 'II. Forma (Dise√±o y Formato)', max: 5, type: 'yes-no', options: [0,5], name: 'Banner y Elementos Mandatorios', desc: 'Inclusi√≥n de logos y cumplimiento de requisitos de formato del simposio. (0 o 5 puntos)' },
            { id: 'diseno', category: 'II. Forma (Dise√±o y Formato)', max: 15, type: 'full', name: 'Dise√±o y Congruencia Visual', desc: 'Equilibrio de texto/gr√°ficos, tipograf√≠a legible y uso eficiente del espacio.' },
            { id: 'graficas', category: 'II. Forma (Dise√±o y Formato)', max: 15, type: 'full', name: 'Uso de Tablas y Gr√°ficas', desc: 'Claridad, calidad de las figuras y correcta citaci√≥n.' }, 

            // III. Referencias y Presentaci√≥n - Max 10 puntos
            { id: 'referencias', category: 'III. Referencias y Presentaci√≥n', max: 5, type: 'yes-no', options: [0,5], name: 'Referencias Bibliogr√°ficas', desc: 'Formato de referencias consistente y adecuado (ej. Vancouver, APA). (0 o 5 puntos)' },
            { id: 'defensa', category: 'III. Referencias y Presentaci√≥n', max: 5, type: 'full', name: 'Defensa y S√≠ntesis', desc: 'Dominio del tema por el autor y capacidad de s√≠ntesis durante la presentaci√≥n.' },

            // IV. BONIFICACI√ìN (Puntos Extra) - Max +15 puntos
            { id: 'innovacion', category: 'IV. Bonificaci√≥n y Deducci√≥n', max: 15, type: 'bonus', name: 'Innovaci√≥n y Originalidad', desc: 'Aporta nuevo conocimiento o utiliza un enfoque metodol√≥gico altamente original.' },

            // V. DEDUCCI√ìN (Restan Puntos) - Max -20 puntos
            { id: 'tiempo', category: 'V. Deducci√≥n (Restan Puntos)', max: 10, type: 'deduction', name: 'Manejo del Tiempo', desc: 'Excedi√≥ o no utiliz√≥ el tiempo de presentaci√≥n asignado. (Hasta -10 puntos)' },
            { id: 'ortografia', category: 'V. Deducci√≥n (Restan Puntos)', max: 10, type: 'deduction', name: 'Redacci√≥n y Ortograf√≠a', desc: 'Errores gramaticales o de sintaxis significativos en el cartel. (Hasta -10 puntos)' },
        ];
        
        // 4. CRITERIOS DE EVALUACI√ìN (ORAL) - Max 100 Base
        const evaluationCriteriaOral = [
            // I. Contenido (Max 60 puntos)
            { id: 'relevancia', category: 'I. Contenido Cient√≠fico', max: 20, type: 'full', name: 'Relevancia y Originalidad', desc: 'Aporte de nuevo conocimiento e impacto potencial.' },
            { id: 'disenocientifico', category: 'I. Contenido Cient√≠fico', max: 20, type: 'full', name: 'Dise√±o Metodol√≥gico', desc: 'Claridad, rigor y adecuaci√≥n del m√©todo a los objetivos.' },
            { id: 'conclusionesoral', category: 'I. Contenido Cient√≠fico', max: 20, type: 'full', name: 'An√°lisis y Conclusiones', desc: 'Profundidad en el an√°lisis de resultados y solidez de las conclusiones.' },
            
            // II. Presentaci√≥n (Max 40 puntos)
            { id: 'dominio', category: 'II. Presentaci√≥n Oral', max: 15, type: 'full', name: 'Dominio y Seguridad', desc: 'Manejo del tema, respuesta a preguntas y seguridad al exponer.' },
            { id: 'estructuraoral', category: 'II. Presentaci√≥n Oral', max: 15, type: 'full', name: 'Claridad y Estructura', desc: 'Organizaci√≥n l√≥gica de la exposici√≥n y claridad de las diapositivas.' },
            { id: 'referenciasoral', category: 'II. Presentaci√≥n Oral', max: 10, type: 'full', name: 'Referencias y Citaci√≥n', desc: 'Uso correcto de la citaci√≥n y calidad de las referencias mostradas.' },
            
            // V. DEDUCCI√ìN (Restan Puntos) - Max -20 puntos
            { id: 'tiempooral', category: 'V. Deducci√≥n (Restan Puntos)', max: 10, type: 'deduction', name: 'Manejo del Tiempo', desc: 'Excedi√≥ o no utiliz√≥ el tiempo asignado. (Hasta -10 puntos)' },
            { id: 'ortografiaoral', category: 'V. Deducci√≥n (Restan Puntos)', max: 10, type: 'deduction', name: 'Redacci√≥n y Ortograf√≠a', desc: 'Errores gramaticales o de sintaxis en las diapositivas. (Hasta -10 puntos)' },
        ];


        // ---------- Utilidades de Sesi√≥n Local ----------
        const saveJudgeDataToLocal = (data) => {
            try { localStorage.setItem(JUDGE_STORAGE_KEY, JSON.stringify(data)); }
            catch(e) { console.error("Error saving judge data:", e); }
        };
        const loadJudgeDataFromLocal = () => {
            try {
                const d = localStorage.getItem(JUDGE_STORAGE_KEY);
                if (!d) return null;
                return JSON.parse(d);
            } catch(e) { console.error("Error loading judge data:", e); return null; }
        };
        const clearJudgeDataLocal = () => {
            try { localStorage.removeItem(JUDGE_STORAGE_KEY); }
            catch(e) { console.error("Error clearing judge data:", e); }
        };
        // -----------------------------------------------

        // Inicializar Firebase
        const initFirebase = () => {
            if (!firebaseConfig) {
                console.warn("Firebase config NO proporcionado. Las funciones de la nube no funcionar√°n.");
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                const signInUser = async () => {
                    try {
                        const authToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (authToken) {
                            await signInWithCustomToken(auth, authToken);
                        } else {
                            // Se utiliza signInAnonymously si no hay token (esto produce un UID √∫nico de Firebase)
                            await signInAnonymously(auth);
                        }
                    } catch (e) {
                        console.error("Error en la autenticaci√≥n Firebase:", e);
                    }
                };
                signInUser();
                
                console.log("Firebase inicializado y autenticaci√≥n intentada.");
            } catch (err) {
                console.error("Error inicializando Firebase:", err);
            }
        };

        // ---------------- INICIO DE LA APLICACI√ìN ----------------
        const mainInit = () => {
            initFirebase();
            
            if (auth) {
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // El UID de Firebase (importante para las reglas)
                        currentUserId = user.uid; 
                    }
                    startAppFlow();
                });
            } else {
                startAppFlow(); // Flujo sin Firebase Auth (solo usa IDs locales)
            }
        };

        const startAppFlow = () => {
            judgeData = loadJudgeDataFromLocal();
            
            if (judgeData && judgeData.id) {
                if (judgeData.role === 'admin') {
                    showAdminDashboard();
                } else {
                    showDashboard(judgeData.id);
                }
            } else {
                // Mostrar Login al cargar
                showLogin();
            }
        }

        document.addEventListener('DOMContentLoaded', mainInit);


        // ---------------- AUTENTICACI√ìN LOCAL ----------------
        const handleLogin = async () => {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            const loginBtn = document.getElementById('login-btn');
            const errorMsg = document.getElementById('login-error');

            errorMsg.textContent = '';
            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando...';

            const userEntry = predefinedUsers.find(u => u.user === user && u.pass === pass);

            if (userEntry) {
                
                const firebaseUid = auth.currentUser?.uid;

                const newJudgeData = {
                    id: userEntry.id, // ID local (juez_a, juez_b)
                    name: userEntry.name,
                    role: userEntry.role,
                    // Usamos el UID de Firebase para la ruta de Firestore
                    firebaseId: firebaseUid, 
                    lastLogin: new Date().toISOString()
                };
                
                // Actualizar el estado global y local
                judgeData = newJudgeData;
                currentUserId = userEntry.id; // Mantenemos el ID local para la asignaci√≥n de trabajos
                saveJudgeDataToLocal(newJudgeData);
                
                // Redirigir seg√∫n el rol
                if (userEntry.role === 'admin') {
                    showAdminDashboard();
                } else {
                    showDashboard(currentUserId);
                }
                
                loginBtn.textContent = '√âxito';
            } else {
                errorMsg.textContent = 'Usuario o contrase√±a incorrectos.';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesi√≥n';
            }
        };

        const handleLogout = async () => {
            clearJudgeDataLocal();
            judgeData = null;
            currentUserId = null;
            if (auth) {
                try {
                    await signOut(auth); // Intenta cerrar sesi√≥n en Firebase si est√° configurado
                } catch(e) {
                    console.error("Error al cerrar sesi√≥n de Firebase:", e);
                }
            }
            showLogin();
        };

        const togglePasswordVisibility = () => {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.getElementById('toggle-password'); 
            
            if (!passwordInput || !toggleBtn) return;
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'üëÅÔ∏è';
            }
        };


        // ---------------- UI: Login ----------------
        const showLogin = () => {
            document.getElementById('app-container').innerHTML = `
                <!-- HERO / LOGIN LAYER (fondo y overlay) -->
                <section id="login-bg" class="min-h-screen flex items-center justify-center p-4">
                    <!-- Contenedor central -->
                    <div class="relative z-10 w-full max-w-4xl mx-4">
                        <div class="bg-white/95 backdrop-blur-md rounded-xl shadow-2xl overflow-hidden grid grid-cols-1 md:grid-cols-2">

                            <!-- LADO IZQUIERDO: Informaci√≥n y logos -->
                            <div class="p-8 md:p-10 bg-white">
                                <div class="flex items-center gap-3 mb-6">
                                    <!-- Logos alineados - Rutas corregidas para tu GitHub -->
                                    <img src="assets/logo_ipn.png" onerror="this.src='https://placehold.co/40x40/7e22ce/FFFFFF/png?text=IPN'" alt="Logo IPN" class="h-10 w-auto object-contain">
                                    <img src="assets/logo_esm.jpg" onerror="this.src='https://placehold.co/40x40/059669/FFFFFF/png?text=ESM'" alt="Logo ESM" class="h-10 w-10 rounded-full shadow-md object-cover">
                                    <img src="assets/logo_licam.png" onerror="this.src='https://placehold.co/40x40/34d399/000000/png?text=LICAM'" alt="Logo LICAM" class="h-10 w-auto object-contain">
                                </div>

                                <h1 class="text-2xl md:text-3xl font-extrabold text-gray-800 mb-2">2¬∞ Simposio de Investigaci√≥n</h1>
                                <p class="text-sm md:text-base text-gray-600 mb-6">Plataforma para la evaluaci√≥n de trabajos libres ‚Äî gesti√≥n de jueces y administraci√≥n central.</p>

                                <div class="p-4 rounded-lg bg-gradient-to-r from-purple-50 to-white border border-purple-100 mb-4">
                                    <p class="text-sm text-gray-700"><strong>Instrucciones r√°pidas:</strong></p>
                                    <ul class="text-sm text-gray-600 mt-2 list-disc list-inside">
                                        <li>La evaluaci√≥n solo se bloquea al guardar el trabajo.</li>
                                        <li>Los jueces solo ven sus trabajos asignados.</li>
                                        <li>La evaluaci√≥n se guarda en Firestore y Google Sheets.</li>
                                    </ul>
                                </div>
                                <div class="text-xs text-gray-500">
                                    <p><strong>Nota:</strong> Aseg√∫rate de cambiar el **ADMIN_ID_FIREBASE** en el c√≥digo.</p>
                                </div>
                            </div>

                            <!-- LADO DERECHO: Formulario de Login -->
                            <div class="p-8 md:p-10 bg-white/90 flex items-center">
                                <div class="w-full">
                                    <h2 class="text-lg font-bold text-gray-800 mb-4">Iniciar sesi√≥n</h2>

                                    <label class="block text-sm text-gray-600 mb-1" for="username">Usuario</label>
                                    <input id="username" type="text" placeholder="ej. juez1" class="w-full mb-4 px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:outline-none" value="juez_araceli">

                                    <label class="block text-sm text-gray-600 mb-1" for="password">Contrase√±a</label>
                                    <div class="relative mb-4">
                                        <input id="password" type="password" placeholder="********" class="w-full px-4 py-3 rounded-lg border border-gray-200 focus:ring-2 focus:ring-purple-500 focus:outline-none" value="cartel2025">
                                        <button id="toggle-password" type="button" class="absolute right-3 top-3 text-gray-400 hover:text-gray-700" aria-label="Mostrar contrase√±a">üëÅÔ∏è</button>
                                    </div>

                                    <div id="login-error" class="text-sm text-red-600 mb-3 hidden"></div>

                                    <button id="login-btn" class="w-full py-3 rounded-lg bg-gradient-to-r from-purple-700 to-purple-500 text-white font-semibold hover:from-purple-800 hover:to-purple-600 transition shadow transform hover:scale-[1.02]">
                                        Iniciar sesi√≥n
                                    </button>

                                    <div class="mt-6 text-xs text-gray-400 text-center">
                                        <p>Versi√≥n 1.0 ‚Ä¢ &copy; Simposio 2025</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </section>
            `;
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('toggle-password').addEventListener('click', togglePasswordVisibility);
        };

        // ---------------- UI: JUEZ DASHBOARD ----------------
        const showDashboard = (userId) => {
            if (!judgeData || judgeData.role !== 'judge') return showLogin();

            document.getElementById('app-container').innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
                        <div class="flex justify-between items-center max-w-6xl mx-auto">
                            <h1 class="text-xl font-bold text-purple-800">Panel de Evaluaci√≥n - Juez</h1>
                            <div class="flex items-center space-x-4">
                                <span class="hidden sm:inline text-sm text-gray-600">Juez: ${judgeData.name} (${judgeData.id})</span>
                                <button id="export-csv-btn" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full hover:bg-blue-700 transition shadow-sm">
                                    Exportar Mis Evaluaciones (CSV)
                                </button>
                                <button id="logout-btn" class="text-sm bg-red-600 text-white px-3 py-1 rounded-full hover:bg-red-700 transition shadow-sm">Salir</button>
                            </div>
                        </div>
                    </header>
                    <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2">Mis Trabajos Asignados</h2>
                        <div id="poster-list" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">Cargando trabajos...</div>
                        </div>
                    </main>
                </div>
            `;

            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('export-csv-btn').addEventListener('click', exportEvaluationsToCSV);
            loadAssignedPosters(userId);
        };

        // ---------------- UI: ADMIN DASHBOARD ----------------
        const showAdminDashboard = () => {
            if (!judgeData || judgeData.role !== 'admin') return showLogin();
            
            document.getElementById('app-container').innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
                        <div class="flex justify-between items-center max-w-6xl mx-auto">
                            <h1 class="text-xl font-bold text-purple-800">Panel de Administraci√≥n</h1>
                            <div class="flex items-center space-x-4">
                                <span class="hidden sm:inline text-sm text-gray-600">Admin: ${judgeData.name}</span>
                                <button id="admin-export-all-btn" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full hover:bg-blue-700 transition shadow-sm">
                                    Exportar TODAS las Evaluaciones (CSV)
                                </button>
                                <button id="logout-btn" class="text-sm bg-red-600 text-white px-3 py-1 rounded-full hover:bg-red-700 transition shadow-sm">Salir</button>
                            </div>
                        </div>
                    </header>
                    <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
                        
                        <p class="text-red-600 bg-red-50 p-3 rounded-lg border border-red-300 font-semibold mb-6">
                            üö® **ACCI√ìN REQUERIDA:** Aseg√∫rate de que tu **ADMIN_ID_FIREBASE** est√© configurado en el c√≥digo y que tus **Reglas de Seguridad** de Firestore permitan la lectura de las colecciones de los jueces.
                        </p>

                        <!-- Resumen de Progreso -->
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2">Resumen de Progreso de Evaluaci√≥n</h2>
                        <div id="admin-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500">
                                <p class="text-sm font-medium text-gray-500">Total de Trabajos</p>
                                <p id="total-posters" class="text-3xl font-bold text-gray-800">...</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                                <p class="text-sm font-medium text-gray-500">Evaluaciones Completadas</p>
                                <p id="completed-evals" class="text-3xl font-bold text-green-600">...</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                                <p class="text-sm font-medium text-gray-500">Promedio de Jueces/Trabajo</p>
                                <p id="avg-judgments" class="text-3xl font-bold text-yellow-600">...</p>
                            </div>
                        </div>

                        <!-- Estado Detallado de los Jueces -->
                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Estado Detallado de los Jueces</h3>
                        <div id="judge-status-list" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">Cargando datos de jueces...</div>
                        </div>
                    </main>
                </div>
            `;
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('admin-export-all-btn').addEventListener('click', exportAllEvaluationsToCSV);
            loadAdminData();
        };
        
        // ---------------- UTILIDADES DE ADMINISTRADOR ----------------
        
        const loadAdminData = async () => {
            const judgeStatusList = document.getElementById('judge-status-list');
            
            // CORRECCI√ìN: Si Firebase no se inicializ√≥, mostramos un error CLARO y no intentamos acceder a 'db'
            if (!db) {
                document.getElementById('total-posters').textContent = predefinedPosters.length;
                document.getElementById('completed-evals').textContent = '0 (Offline)';
                document.getElementById('avg-judgments').textContent = '0.00';
                judgeStatusList.innerHTML = `
                    <div class="bg-red-100 p-4 rounded-lg text-red-700 font-medium">
                        <p>‚ö†Ô∏è **ERROR DE CONEXI√ìN:** Firestore no se inicializ√≥. Aseg√∫rate de que **__firebase_config** est√© disponible.</p>
                        <p class="text-sm">Si est√°s viendo este error, la reasignaci√≥n y los reportes globales no funcionar√°n.</p>
                    </div>
                `;
                return;
            }
            
            const assignments = {};
            predefinedUsers.filter(u => u.role === 'judge').forEach(judge => {
                assignments[judge.id] = { assigned: 0, completed: 0, judgeName: judge.name, id: judge.id, firebaseId: judge.firebaseId, posters: [] };
            });
            predefinedPosters.forEach(poster => {
                if (assignments[poster.assignedTo]) {
                    assignments[poster.assignedTo].assigned++;
                    assignments[poster.assignedTo].posters.push(poster.id);
                }
            });
            
            const judgesToTrack = predefinedUsers.filter(u => u.role === 'judge');
            let totalCompletedEvals = 0;

            const judgePromises = judgesToTrack.map(async (judge) => {
                const judgeAssignment = assignments[judge.id] || { assigned: 0, completed: 0, judgeName: judge.name, id: judge.id, firebaseId: judge.firebaseId };
                
                try {
                    // Nota: Esta consulta requiere la Regla de Seguridad 2 (lectura del Admin en todas las colecciones de usuarios)
                    const evalsColRef = collection(db, `artifacts/${appId}/users/${judge.firebaseId}/evaluations`);
                    const querySnapshot = await getDocs(evalsColRef);
                    
                    judgeAssignment.completed = querySnapshot.size;
                    totalCompletedEvals += querySnapshot.size;

                } catch (error) {
                    console.error(`Error fetching evals for ${judge.id}: ${error.message}`);
                    // Mostrar un error de permisos solo en la tarjeta si falla
                    judgeAssignment.error = true;
                }
                return judgeAssignment;
            });

            const results = await Promise.all(judgePromises);
            
            // Renderizar resumen
            document.getElementById('total-posters').textContent = predefinedPosters.length;
            document.getElementById('completed-evals').textContent = totalCompletedEvals;
            document.getElementById('avg-judgments').textContent = (totalCompletedEvals / predefinedPosters.length).toFixed(2);
            
            // Renderizar la lista de jueces (con bot√≥n de reasignaci√≥n)
            judgeStatusList.innerHTML = results.map(judge => {
                const percentage = judge.assigned > 0 ? ((judge.completed / judge.assigned) * 100).toFixed(0) : 100;
                const progressColor = percentage == 100 ? 'bg-green-500' : (percentage > 0 ? 'bg-yellow-500' : 'bg-red-500');
                
                return `
                    <div class="bg-white p-4 rounded-lg shadow-md flex items-center justify-between transform transition duration-200 hover:shadow-xl hover:scale-[1.01]">
                        <div class="flex flex-col">
                            <p class="font-bold text-gray-700">${judge.judgeName} (${judge.id})</p>
                            ${judge.error ? '<p class="text-xs text-red-500 font-semibold">ERROR: Verifique reglas de lectura.</p>' : ''}
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-sm font-semibold text-gray-600">${judge.completed} / ${judge.assigned} completados</div>
                            <div class="w-24 bg-gray-200 rounded-full h-2.5">
                                <div class="h-2.5 rounded-full ${progressColor} transition-all duration-500" style="width: ${percentage}%;"></div>
                            </div>
                            <span class="text-sm font-bold text-purple-700">${percentage}%</span>
                            <button onclick="openReassignModal('${judge.id}')" class="bg-indigo-500 text-white text-xs px-3 py-1 rounded-full hover:bg-indigo-600 transition">
                                Reasignar Pendientes
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        };
        
        /* ============================================================
           MODAL UNIVERSAL (para administrador)
        ============================================================ */

        const openModal = (html) => {
            const modal = document.createElement("div");
            modal.className = "modal-bg fade-in";
            modal.innerHTML = `
                <div class="modal-content">
                    ${html}
                    <button class="w-full mt-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition" onclick="closeModal()">Cerrar</button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        const closeModal = () => {
            const m = document.querySelector(".modal-bg");
            if (m) m.remove();
        }

        const showAlert = (message, type = "info") => {
            const box = document.createElement("div");
            box.className = `fixed top-5 right-5 px-4 py-3 rounded shadow-lg text-white transform transition duration-300 ease-out z-50`;
            
            const colors = {
                success: "bg-green-500",
                error: "bg-red-500",
                info: "bg-indigo-500"
            };

            box.classList.add(colors[type] || colors.info);
            box.innerText = message;

            document.body.appendChild(box);

            setTimeout(() => {
                box.classList.remove('top-5');
                box.classList.add('top-0', 'opacity-0');
                setTimeout(() => box.remove(), 500);
            }, 3500);
        }

        /* ============================================================
           REASIGNACI√ìN MASIVA
        ============================================================ */

        async function getJudgePendingWorks(juezId) {
            const pendientes = [];

            if (!db) return pendientes;
            
            const judge = predefinedUsers.find(u => u.id === juezId);
            if (!judge || !judge.firebaseId) return pendientes;

            // Buscamos en la lista local de asignaciones para obtener los IDs
            const assignedPosters = predefinedPosters.filter(p => p.assignedTo === juezId || (p.assignedToGroup && p.assignedToGroup.includes(juezId)));
            
            for (const work of assignedPosters) {
                // Verificamos si ya existe una evaluaci√≥n para ese trabajo por parte de ese juez
                const snap = await getDoc(doc(db, `artifacts/${appId}/users/${judge.firebaseId}/evaluations`, work.id));

                if (!snap.exists()) {
                    pendientes.push(work.id);
                }
            }

            return pendientes; 
        }

        async function reassignWorkToJudge(oldJudge, newJudge, workId) {
             if (!db) return;
             
             const newJudgeUser = predefinedUsers.find(u => u.id === newJudge);
             if (!newJudgeUser || !newJudgeUser.firebaseId) {
                console.error("UID de Firebase del nuevo juez no encontrado.");
                showAlert("Error: UID del nuevo juez no encontrado.", "error");
                return;
             }

             // El documento de reasignaci√≥n debe ir a la colecci√≥n del nuevo juez
             return setDoc(doc(db, `artifacts/${appId}/users/${newJudgeUser.firebaseId}/evaluations`, workId), {
                reasignadoDesde: oldJudge,
                estado: "reasignado",
                fechaReasignado: new Date().toISOString()
            }, { merge: true });
        }

        async function reassignAllPendingWorks(oldJudge, newJudge) {
            const pendientes = await getJudgePendingWorks(oldJudge);

            if (pendientes.length === 0) {
                 showAlert(`El juez ${oldJudge} no tiene trabajos pendientes de reasignaci√≥n.`, "info");
                 return;
            }

            for (const workId of pendientes) {
                await reassignWorkToJudge(oldJudge, newJudge, workId);
            }

            showAlert(
                `Se reasignaron ${pendientes.length} trabajos de ${oldJudge} a ${newJudge}`,
                "success"
            );
            // Esto dispara la recarga del dashboard en la funci√≥n confirmMassReassign
        }

        function openReassignModal(oldJudge) {
            // Filtrar solo jueces y excluir al juez actual
            const listaJueces = predefinedUsers
                .filter(u => u.role === "judge" && u.id !== oldJudge)
                .map(j => `<option value="${j.id}">${j.name} (${j.id})</option>`)
                .join("");

            openModal(`
                <h2 class="text-xl font-bold text-gray-800 mb-3">Reasignar trabajos de ${oldJudge}</h2>
                <p class="text-sm mb-4 text-gray-600">Selecciona a qu√© juez deseas transferir todos los trabajos **pendientes** de **${oldJudge}**.</p>

                <label class="font-semibold text-sm block mb-1">Nuevo juez asignado:</label>
                <select id="newJudgeSelect" class="w-full p-2 border border-gray-300 rounded-lg">
                    <option value="">Selecciona un juez</option>
                    ${listaJueces}
                </select>

                <button class="w-full py-2 px-4 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition mt-4"
                    onclick="confirmMassReassign('${oldJudge}')">
                    Reasignar TODOS los pendientes
                </button>
            `);
        }
        
        async function confirmMassReassign(oldJudge) {
            const newJudge = document.getElementById("newJudgeSelect").value;

            if (!newJudge) {
                showAlert("Debes seleccionar un juez.", "error");
                return;
            }
            
            closeModal();
            
            await reassignAllPendingWorks(oldJudge, newJudge);
            
            // Recargar datos para reflejar los cambios en el panel de admin
            loadAdminData(); 
        }

        /* ============================================================
           FIN REASIGNACI√ìN MASIVA
        ============================================================ */


        // ---------------- CARGAR TRABAJOS ASIGNADOS (Juez) ----------------
        const loadAssignedPosters = (judgeId) => {
            const listContainer = document.getElementById('poster-list');
            const staticJudgeId = judgeData?.id;

            if (!staticJudgeId) {
                listContainer.innerHTML = '<div class="text-center py-8 text-red-500">Error: No se encontr√≥ la ID de asignaci√≥n del juez.</div>';
                return;
            }

            // Filtramos solo los trabajos asignados a este juez (ya sea por asignaci√≥n directa o por grupo oral)
            const assignedPosters = predefinedPosters.filter(p => p.assignedTo === staticJudgeId || (p.assignedToGroup && p.assignedToGroup.includes(staticJudgeId)));
            
            if (assignedPosters.length === 0) {
                listContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No tiene trabajos asignados para evaluar.</div>';
                return;
            }
            
            listContainer.innerHTML = ''; 

            assignedPosters.forEach(poster => {
                const docRef = (db && typeof doc === 'function' && judgeData.firebaseId) 
                    ? doc(db, `artifacts/${appId}/users/${judgeData.firebaseId}/evaluations`, poster.id) 
                    : null;

                if (docRef && typeof onSnapshot === 'function') {
                    // Usamos onSnapshot para mantener el estado de la tarjeta en tiempo real
                    onSnapshot(docRef, (docSnap) => {
                        const evaluationData = docSnap.exists() ? docSnap.data() : null;
                        renderOrUpdatePosterCard(poster, evaluationData);
                    }, (error) => {
                        console.warn(`Error fetching evaluation for poster ${poster.id}:`, error);
                        renderOrUpdatePosterCard(poster, null, true);
                    });
                } else {
                    // Si Firestore no est√° disponible, mostrar el bot√≥n de evaluar sin conexi√≥n
                    renderOrUpdatePosterCard(poster, null); 
                }
            });
        };

        const renderOrUpdatePosterCard = (poster, evaluationData, hasError=false) => {
            const listContainer = document.getElementById('poster-list');
            if (!listContainer) return;

            // La evaluaci√≥n est√° hecha si existe el documento Y tiene un totalScore
            const totalScore = evaluationData?.totalScore !== undefined ? evaluationData.totalScore : 'N/A';
            // isEvaluated es TRUE si tenemos un documento con un score v√°lido.
            const isEvaluated = !!evaluationData && totalScore !== 'N/A'; 
            let statusText;
            let btnClass;
            
            if (isEvaluated) {
                btnClass = 'bg-gray-400 cursor-not-allowed';
                statusText = `Finalizada (${totalScore} Pts)`; // Muestra el puntaje en el bot√≥n finalizado
            } else {
                // Si no est√° evaluado:
                statusText = 'Evaluar'; 
                btnClass = 'bg-purple-600 hover:bg-purple-700';
                if (hasError) {
                    // Si hay un error de carga de Firestore (ej. Missing permissions)
                    btnClass = 'bg-yellow-600 hover:bg-yellow-700';
                    statusText = 'Evaluar (Verificar)';
                }
            }

            const scoreColor = isEvaluated ? 'bg-green-600 text-white' : 'bg-yellow-500 text-gray-800'; 

            let card = document.getElementById(`poster-card-${poster.id}`);
            if (!card) {
                const newCardHTML = `
                    <div id="poster-card-${poster.id}" class="bg-white p-5 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-start sm:items-center transform transition duration-200 hover:shadow-xl hover:scale-[1.01] cursor-pointer ${isEvaluated ? 'border-l-4 border-green-600' : 'border-l-4 border-purple-400'}">
                        <div>
                            <p class="text-sm font-medium text-gray-500">${poster.id} ${poster.type === 'oral' ? '<span class="text-xs font-bold text-red-500">(ORAL)</span>' : ''}</p>
                            <h3 class="text-lg font-semibold text-gray-800">${poster.title}</h3>
                        </div>
                        <div class="mt-3 sm:mt-0 flex items-center space-x-4">
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${scoreColor}">
                                Puntaje: ${totalScore} / 100
                            </span>
                            <button class="evaluate-btn text-white px-4 py-2 rounded-full font-medium transition ${btnClass}"
                                    data-poster-id="${poster.id}" 
                                    data-poster-title="${poster.title}" 
                                    data-evaluation='${JSON.stringify(evaluationData || {})}'
                                    data-is-evaluated="${isEvaluated}"
                                    data-type="${poster.type || 'cartel'}"
                                    ${isEvaluated ? 'disabled' : ''}>
                                ${statusText}
                            </button>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', newCardHTML);
            } else {
                // Actualizar la tarjeta existente
                card.className = `bg-white p-5 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-start sm:items-center transform transition duration-200 hover:shadow-xl hover:scale-[1.01] cursor-pointer ${isEvaluated ? 'border-l-4 border-green-600' : 'border-l-4 border-purple-400'}`;
                const span = card.querySelector('span');
                if (span) {
                    span.className = `px-3 py-1 text-xs font-medium rounded-full ${scoreColor}`;
                    span.textContent = `Puntaje: ${totalScore} / 100`;
                }
                const btn = card.querySelector('.evaluate-btn');
                if (btn) {
                    btn.textContent = statusText;
                    btn.dataset.evaluation = JSON.stringify(evaluationData || {});
                    btn.dataset.isEvaluated = isEvaluated;

                    // Bloqueo final si ya est√° evaluado.
                    btn.disabled = isEvaluated;
                    btn.classList.remove('bg-purple-600', 'hover:bg-purple-700', 'bg-green-600', 'hover:bg-green-700', 'bg-gray-400', 'cursor-not-allowed', 'bg-red-600', 'bg-yellow-600', 'hover:bg-yellow-700');
                    
                    if (isEvaluated) {
                        btn.classList.add('bg-gray-400', 'cursor-not-allowed');
                    } else {
                        btn.classList.add(btnClass);
                    }
                }
            }

            // reasignar manejadores
            document.querySelectorAll('.evaluate-btn').forEach(btn => {
                btn.removeEventListener('click', handleEvaluateClick);
                btn.addEventListener('click', handleEvaluateClick);
            });
        };
        

        // ---------------- L√≥gica de Evaluaci√≥n ----------------
        const handleEvaluateClick = (event) => {
            const posterId = event.currentTarget.dataset.posterId;
            const posterTitle = event.currentTarget.dataset.posterTitle;
            const evaluationData = JSON.parse(event.currentTarget.dataset.evaluation || '{}');
            const isEvaluated = event.currentTarget.dataset.isEvaluated === 'true';
            const evaluationType = event.currentTarget.dataset.type || 'cartel';

            showEvaluationForm(posterId, posterTitle, evaluationData, isEvaluated, evaluationType);
        };

        const handleInputVisualFeedback = (event) => {
            const input = event.target;
            const name = input.name;
            const isRadio = input.type === 'radio';
            const isNumber = input.type === 'number';

            if (isRadio) {
                document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
                    const label = document.querySelector(`label[for="${radio.id}"]`);
                    if (label) label.classList.remove('selected');
                });
            } else if (isNumber) {
                input.classList.remove('has-value');
            }

            if (isRadio && input.checked) {
                const label = document.querySelector(`label[for="${input.id}"]`);
                if (label) label.classList.add('selected');
            } else if (isNumber) {
                const value = parseInt(input.value);
                if (!isNaN(value) && value >= 0 && value <= parseInt(input.max)) {
                    input.classList.add('has-value');
                }
            }
            
            calculateScore();
        };

        const showEvaluationForm = (posterId, title, evaluation = {}, isEvaluated = false, evaluationType = 'cartel') => {
            const formContainer = document.getElementById('app-container');
            
            const criteriaSet = evaluationType === 'oral' ? evaluationCriteriaOral : evaluationCriteriaCartel;
            const categoryHeaders = criteriaSet.reduce((acc,curr)=> { if(!acc.includes(curr.category)) acc.push(curr.category); return acc; }, []);
            
            const saveButtonText = 'Guardar Evaluaci√≥n';
            const isReadOnly = isEvaluated; 
            const maxScoreDisplay = evaluationType === 'oral' ? '/ 100 (Oral)' : '/ 100 (Cartel)';


            let formHTML = `
                <div class="min-h-screen bg-gray-50 p-4 sm:p-6 lg:p-8">
                    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
                        <header class="mb-6 border-b pb-4">
                            <button id="back-to-dashboard" class="text-purple-600 hover:text-purple-800 flex items-center mb-4 text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                                Volver al Panel
                            </button>
                            <h2 class="text-2xl font-bold text-gray-800">${title}</h2>
                            <p class="text-md text-gray-500">ID del Trabajo: ${posterId} 
                                <span class="font-bold text-sm text-red-500 ml-2">(${evaluationType.toUpperCase()})</span>
                            </p>
                            ${isReadOnly ? '<p class="text-sm text-gray-600 font-semibold mt-1">Este trabajo ya fue calificado y no se puede modificar.</p>' : 
                             '<p class="text-sm text-green-600 font-semibold mt-1">Ingresa la calificaci√≥n. Se bloquear√° al guardar (Finalizar).</p>'}
                        </header>

                        <form id="evaluation-form" data-poster-id="${posterId}" data-type="${evaluationType}">
                            <div id="criteria-list" class="space-y-6 opacity-${isReadOnly ? '50' : '100'}" ${isReadOnly ? 'style="pointer-events: none;"' : ''}>
                                ${categoryHeaders.map(category => `
                                    <div class="border-t pt-4">
                                        <h3 class="text-xl font-semibold text-purple-700 mb-4">${category}</h3>
                                        ${criteriaSet.filter(c => c.category === category).map(c => {
                                            const savedScore = evaluation.scores?.[c.id] !== undefined ? evaluation.scores[c.id] : '';
                                            const isDeductionOrBonus = c.type === 'deduction' || c.type === 'bonus';
                                            const maxScoreText = c.type === 'deduction' ? `DEDUCCI√ìN (M√°x: ${c.max})` : (c.type === 'bonus' ? `BONUS (M√°x: ${c.max})` : `M√°x: ${c.max}`);
                                            const isMarked = savedScore !== '';

                                            let inputField = '';
                                            let cardClass = isDeductionOrBonus ? (c.type === 'deduction' ? 'deduction-card' : 'bonus-card') : 'bg-gray-50';
                                            
                                            // L√≥gica para tipo 3-point
                                            if (c.type === '3-point' && c.options) {
                                                inputField = `
                                                    <div class="grid grid-cols-3 gap-2">
                                                        ${c.options.map(option => {
                                                            const isChecked = savedScore == option;
                                                            return `
                                                            <div class="col-span-1">
                                                                <input type="radio" id="${c.id}-score-${option}" name="${c.id}" value="${option}" class="hidden peer" ${isChecked ? 'checked' : ''} data-max="${c.max}" data-type="${c.type}" required ${isReadOnly ? 'disabled' : ''}/>
                                                                <label for="${c.id}-score-${option}" class="score-option block p-3 text-center rounded-lg font-bold text-gray-700 hover:bg-purple-50 peer-checked:selected transition duration-150 ${isChecked ? 'selected' : ''}">
                                                                    ${option} Pts
                                                                </label>
                                                            </div>
                                                            `;
                                                        }).join('')}
                                                    </div>
                                                `;
                                            // L√≥gica para tipo yes-no
                                            } else if (c.type === 'yes-no' && c.options) {
                                                const scoreYes = c.options[1];
                                                const scoreNo = c.options[0];
                                                inputField = `
                                                    <div class="grid grid-cols-2 gap-2">
                                                        <div class="col-span-1">
                                                            <input type="radio" id="${c.id}-score-${scoreYes}" name="${c.id}" value="${scoreYes}" class="hidden peer" ${savedScore == scoreYes ? 'checked' : ''} data-max="${c.max}" data-type="${c.type}" required ${isReadOnly ? 'disabled' : ''}/>
                                                            <label for="${c.id}-score-${scoreYes}" class="score-option block p-3 text-center rounded-lg font-bold text-green-700 hover:bg-green-50 peer-checked:selected transition duration-150 ${savedScore == scoreYes ? 'selected' : ''}">
                                                                S√≠ (${scoreYes} Pts)
                                                            </label>
                                                        </div>
                                                        <div class="col-span-1">
                                                            <input type="radio" id="${c.id}-score-${scoreNo}" name="${c.id}" value="${scoreNo}" class="hidden peer" ${savedScore == scoreNo ? 'checked' : ''} data-max="${c.max}" data-type="${c.type}" required ${isReadOnly ? 'disabled' : ''}/>
                                                            <label for="${c.id}-score-${scoreNo}" class="score-option block p-3 text-center rounded-lg font-bold text-red-700 hover:bg-red-50 peer-checked:selected transition duration-150 ${savedScore == scoreNo ? 'selected' : ''}">
                                                                No (${scoreNo} Pts)
                                                            </label>
                                                        </div>
                                                    </div>
                                                `;
                                            // L√≥gica para tipo full, bonus y deduction
                                            } else {
                                                inputField = `
                                                    <input type="number" id="${c.id}-score" name="${c.id}" class="score-input ${c.type === 'deduction' ? 'border-red-400 text-red-700' : 'border-purple-400 text-purple-700'} ${isMarked ? 'has-value' : ''}" 
                                                        min="0" max="${c.max}" value="${savedScore}" data-max="${c.max}" data-type="${c.type}" required ${isReadOnly ? 'disabled' : ''}/>
                                                `;
                                            }

                                            return `
                                                <div class="p-4 rounded-lg shadow-inner ${cardClass}">
                                                    <div class="flex justify-between items-center mb-2">
                                                        <h4 class="text-lg font-medium text-gray-700">${c.name}</h4>
                                                        <span class="text-sm font-semibold ${c.type === 'deduction' ? 'text-red-600' : (c.type === 'bonus' ? 'text-blue-600' : 'text-purple-600')}">${maxScoreText}</span>
                                                    </div>
                                                    <p class="text-xs text-gray-500 mb-3">${c.desc}</p>
                                                    ${inputField}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `).join('')}
                            </div>

                            <div class="mt-8 pt-6 border-t border-gray-200">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Puntuaci√≥n Final: <span id="total-score" class="text-3xl text-purple-600">${evaluation.totalScore || '0'}</span> ${maxScoreDisplay}</h3>
                                
                                <div class="bg-gray-100 p-4 rounded-lg text-sm text-gray-700 mb-6 border border-gray-200">
                                    <p class="font-bold text-lg mb-1">C√°lculo de Puntaje (Base 100)</p>
                                    <ul class="list-disc list-inside mt-2 text-xs">
                                        <li>**Puntos Base (${evaluationType.toUpperCase()}):** M√°ximo 100 puntos.</li>
                                        <li>**Puntos de Bonificaci√≥n (IV):** Se <span class="font-bold text-blue-600">suman</span> al total (M√°x +15).</li>
                                        <li>**Puntos de Deducci√≥n (V):** Se <span class="font-bold text-red-600">restan</span> del total (M√°x -20).</li>
                                    </ul>
                                </div>

                                <label for="observations" class="block text-md font-medium text-gray-700 mb-2">Observaciones y Comentarios Adicionales (Opcional)</label>
                                <textarea id="observations" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500" ${isReadOnly ? 'disabled' : ''}>${evaluation.observations || ''}</textarea>

                                <button type="submit" id="save-evaluation-btn" class="mt-6 w-full p-4 rounded-lg font-semibold text-lg transition duration-150 shadow-lg transform hover:scale-[1.01] 
                                    ${isReadOnly ? 'bg-gray-400 cursor-not-allowed' : 'bg-green-600 hover:bg-green-700'}"
                                    ${isReadOnly ? 'disabled' : ''}>
                                    ${isReadOnly ? 'No Modificable' : saveButtonText}
                                </button>
                                <p id="save-status" class="text-center mt-3 text-sm font-medium"></p>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            formContainer.innerHTML = formHTML;
            setupFormHandlers(posterId);
            
            // Forzar actualizaci√≥n de estilos al cargar el formulario
            document.querySelectorAll('#criteria-list input').forEach(input => {
                if (input.type === 'radio' && input.checked) {
                    const label = document.querySelector(`label[for="${input.id}"]`);
                    if (label) label.classList.add('selected');
                }
                if (input.type === 'number' && input.value !== "") {
                    input.classList.add('has-value');
                }
            });
        };

        const calculateScore = () => {
            const form = document.getElementById('evaluation-form');
            if (!form) return 0;

            const evaluationType = form.dataset.type || 'cartel';
            const criteriaSet = evaluationType === 'oral' ? evaluationCriteriaOral : evaluationCriteriaCartel;
            
            let totalScore = 0;
            const currentScores = {};

            criteriaSet.forEach(c => {
                const criteriaId = c.id;
                let score = 0;
                let inputElement;

                if (c.type === '3-point' || c.type === 'yes-no') {
                    const checkedRadio = document.querySelector(`input[name="${criteriaId}"]:checked`);
                    if (checkedRadio) {
                        score = parseInt(checkedRadio.value) || 0;
                        inputElement = checkedRadio;
                    }
                } else {
                    const numberInput = document.getElementById(`${criteriaId}-score`);
                    if (numberInput) {
                        score = parseInt(numberInput.value) || 0;
                        inputElement = numberInput;
                    }
                }
                
                if (inputElement) {
                    currentScores[criteriaId] = { score, criteriaType: c.type, input: inputElement };
                }
            });

            // 1. Calcular puntos base (M√°x 100)
            let baseScore = 0;
            let totalBonus = 0;
            let totalDeduction = 0;
            
            for (const criteriaId in currentScores) {
                const { score, criteriaType, input } = currentScores[criteriaId];
                const max = parseInt(input.dataset.max) || 0;
                const safeScore = Math.min(score, max); // Asegura que no exceda el m√°ximo

                if (criteriaType === 'bonus') {
                    totalBonus += safeScore;
                } else if (criteriaType === 'deduction') {
                    totalDeduction += safeScore;
                } else {
                    // Criterios Base (full, 3-point, yes-no)
                    baseScore += safeScore;
                }
            }
            
            // 2. C√°lculo Final: Base + Bonus - Deducci√≥n
            totalScore = baseScore + totalBonus - totalDeduction;

            const scoreDisplay = document.getElementById('total-score');
            if (scoreDisplay) scoreDisplay.textContent = totalScore;
            
            return totalScore;
        };

        // ENVIAR A GOOGLE SHEETS
        const sendDataToGoogleSheets = async (evaluationData) => {
            
            const SHEETS_WEBAPP_URL = GOOGLE_SHEETS_WEB_APP_URL;

            const payload = {
                timestamp: new Date().toISOString(),
                staticJudgeId: judgeData?.id || currentUserId || 'unknown',
                judgeName: judgeData?.name || currentUserId || 'unknown',
                posterId: evaluationData.posterId || 'N/A',
                posterTitle: evaluationData.posterTitle || 'N/A',
                totalScore: evaluationData.totalScore || 0,
                scores: evaluationData.scores || {},
                observations: evaluationData.observations || ''
            };
            
            if (!SHEETS_WEBAPP_URL || SHEETS_WEBAPP_URL.includes('YOUR_WEB_APP_ID')) {
                console.warn("URL de Google Sheets no configurada. Saltando env√≠o.");
                return;
            }

            try {
                // Usamos fetch con 'no-cors' para enviar datos a GAS
                await fetch(SHEETS_WEBAPP_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                console.log("Intentado guardar en Google Sheets (no-cors).");
            } catch (error) {
                console.warn("Error al enviar a Google Sheets:", error);
                // No lanzamos error aqu√≠ para no bloquear el guardado en Firestore
            }
        };

        const saveEvaluation = async (event) => {
            event.preventDefault();
            const posterId = document.getElementById('evaluation-form').dataset.posterId;
            const saveBtn = document.getElementById('save-evaluation-btn');
            const statusMsg = document.getElementById('save-status');

            if (!judgeData || !judgeData.id || !judgeData.firebaseId) {
                statusMsg.textContent = 'Error: Usuario juez no detectado o no autenticado con Firebase UID.';
                statusMsg.className = 'text-center mt-3 text-sm font-medium text-red-600';
                return;
            }

            // Si ya est√° evaluado (aunque el bot√≥n est√© deshabilitado), no hacemos nada
            if (saveBtn.disabled) return;

            const scores = {};
            
            // Recoger todos los criterios posibles
            const allCriteria = [...evaluationCriteriaCartel, ...evaluationCriteriaOral];
            
            allCriteria.forEach(c => {
                const criteriaId = c.id;
                // Intentar obtener de radios (3-point, yes-no)
                const radioValue = document.querySelector(`input[name="${criteriaId}"]:checked`)?.value;
                if (radioValue !== undefined) {
                    scores[criteriaId] = parseInt(radioValue);
                } else {
                    // Intentar obtener de number input (full, bonus, deduction)
                    const numberInput = document.getElementById(`${criteriaId}-score`);
                    if (numberInput) scores[criteriaId] = parseInt(numberInput.value) || 0;
                }
            });

            const totalScore = calculateScore();
            const observations = document.getElementById('observations').value.trim();

            const evaluationData = {
                judgeId: judgeData.id,
                judgeName: judgeData.name,
                posterId: posterId,
                posterTitle: (predefinedPosters.find(p=>p.id===posterId)?.title) || 'T√≠tulo Desconocido',
                totalScore,
                scores,
                observations,
                timestamp: new Date().toISOString()
            };

            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            statusMsg.textContent = '';

            try {
                let savedToCloud = false;

                // 1. Guardar en Firestore (AQU√ç ES DONDE SE USA EL FIREBASE UID)
                if (db && typeof setDoc === 'function') {
                    // El UID de Firebase (judgeData.firebaseId) DEBE coincidir con el 'userId' en la regla de seguridad.
                    const docRef = doc(db, `artifacts/${appId}/users/${judgeData.firebaseId}/evaluations`, posterId); 
                    await setDoc(docRef, evaluationData);
                    savedToCloud = true;
                } else {
                    console.warn("Firestore no inicializado. La evaluaci√≥n NO se guardar√° en la nube de Firebase.");
                }

                // 2. Enviar a Google Sheets (no bloqueante para el flujo principal)
                await sendDataToGoogleSheets(evaluationData); 

                if (savedToCloud) {
                    statusMsg.textContent = 'Evaluaci√≥n guardada y enviada exitosamente.';
                } else {
                    statusMsg.textContent = 'Guardado local (Sin Firebase Cloud) exitoso.';
                }
                
                statusMsg.className = 'text-center mt-3 text-sm font-medium text-green-600';
                saveBtn.textContent = 'Guardado';

                // Redirigir y refrescar el estado de bloqueo.
                setTimeout(()=> showDashboard(judgeData.id), 1200); 
            } catch (error) {
                console.error("Error guardando evaluaci√≥n:", error);
                
                // **** FEEDBACK DE ERROR CR√çTICO ****
                let errorMessage = `Error al guardar: ${error.message}.`;
                if (error.code === 'permission-denied') {
                    // Si el error es de permisos, el mensaje es directo
                    errorMessage = '¬°ERROR DE PERMISOS DE FIREBASE! El juez no puede escribir. Revisa tus Reglas de Seguridad.';
                } else if (error.code === 'unavailable') {
                    errorMessage = 'ERROR: Servicio de Firestore no disponible. Verifique la configuraci√≥n de red.';
                }

                statusMsg.textContent = errorMessage;
                statusMsg.className = 'text-center mt-3 text-sm font-medium text-red-600';
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Evaluaci√≥n';
            }
        };

        const setupFormHandlers = (posterId) => {
            const backBtn = document.getElementById('back-to-dashboard');
            if (backBtn) backBtn.addEventListener('click', ()=> judgeData.role === 'admin' ? showAdminDashboard() : showDashboard(judgeData.id));
            
            document.querySelectorAll('#criteria-list input').forEach(input => {
                input.addEventListener('input', handleInputVisualFeedback);
                input.addEventListener('change', handleInputVisualFeedback);
            });
            
            const form = document.getElementById('evaluation-form');
            if (form) form.addEventListener('submit', saveEvaluation);
            calculateScore(); 
        };

        // ---------------- EXPORTACI√ìN CSV ADMIN (TODAS las evaluaciones) ----------------
        const exportAllEvaluationsToCSV = async () => {
             if (!judgeData || judgeData.role !== 'admin') { 
                showAlert('Solo el Administrador puede realizar esta exportaci√≥n.', 'error'); 
                return; 
             }
             if (!db || typeof collection !== 'function') {
                showAlert('Firestore no configurado. No se pueden exportar los datos.', 'error');
                return;
             }
             
            const exportBtn = document.getElementById('admin-export-all-btn');
            exportBtn.disabled = true; exportBtn.textContent = 'Recolectando datos...';

            // Mapeamos todos los criterios posibles (Cartel + Oral) para el CSV global
            const allCriteria = [...evaluationCriteriaCartel, ...evaluationCriteriaOral.filter(c => !evaluationCriteriaCartel.some(c2 => c2.id === c.id))];
            const criteriaMapping = allCriteria.map(c => ({ 
                id: c.id, 
                name: c.name.replace(/\s/g, '_').replace(/[\(\)]/g, '').replace(/\./g, '') 
            }));

            let csvContent = "data:text/csv;charset=utf-8,";
            let headers = ['Judge_ID','Judge_Name','Poster_ID','Poster_Title','Total_Score','Observations', 'Timestamp', ...criteriaMapping.map(c=>c.name)];
            csvContent += headers.join(',') + '\r\n';

            try {
                const allEvals = [];
                const judgeIds = predefinedUsers.filter(u => u.role === 'judge').map(u => u.id);

                for (const judgeId of judgeIds) {
                    const judge = predefinedUsers.find(u => u.id === judgeId);
                    if (!judge || !judge.firebaseId) continue; // Si no tiene Firebase ID, saltar
                    
                    const evalsColRef = collection(db, `artifacts/${appId}/users/${judge.firebaseId}/evaluations`);
                    // Nota: Esta consulta requiere la Regla de Seguridad 2 (lectura del Admin en todas las colecciones de usuarios)
                    const querySnapshot = await getDocs(evalsColRef);
                    querySnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        allEvals.push(data);
                    });
                }
                
                allEvals.forEach(data => {
                    const poster = predefinedPosters.find(p => p.id === data.posterId);
                    const posterTitle = poster ? poster.title.replace(/,/g,'') : 'Unknown Title';
                    
                    let row = [
                        data.judgeId,
                        `"${data.judgeName.replace(/"/g,'""')}"`,
                        data.posterId,
                        `"${posterTitle}"`,
                        data.totalScore,
                        `"${(data.observations||'').replace(/"/g,'""').replace(/(\r\n|\n|\r)/gm,' ')}"`,
                        data.timestamp
                    ];
                    criteriaMapping.forEach(c => { row.push(data.scores?.[c.id] || 0); });
                    csvContent += row.join(',') + '\r\n';
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `evaluaciones_ADMIN_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                exportBtn.textContent = 'Exportaci√≥n Exitosa';
                exportBtn.classList.replace('bg-blue-600','bg-green-600');
                setTimeout(()=>{ exportBtn.disabled=false; exportBtn.textContent='Exportar TODAS las Evaluaciones (CSV)'; exportBtn.classList.replace('bg-green-600','bg-blue-600'); }, 3000);

            } catch (error) {
                console.error("Error al exportar CSV:", error);
                showAlert('Error al exportar todas las evaluaciones. Revise la consola.', 'error');
                exportBtn.disabled=false; exportBtn.textContent='Exportar TODAS las Evaluaciones (CSV)';
                exportBtn.classList.replace('bg-green-600','bg-blue-600');
            }
        };
        
        // ---------------- EXPORTACI√ìN CSV JUEZ (Mis evaluaciones) ----------------
        const exportEvaluationsToCSV = async () => {
            if (!judgeData || !judgeData.id) { showAlert('Debe iniciar sesi√≥n para exportar datos.', 'error'); return; }
            const exportBtn = document.getElementById('export-csv-btn');
            exportBtn.disabled = true; exportBtn.textContent = 'Generando CSV...';

            // Mapeamos todos los criterios posibles (Cartel + Oral) para el CSV personal
            const allCriteria = [...evaluationCriteriaCartel, ...evaluationCriteriaOral.filter(c => !evaluationCriteriaCartel.some(c2 => c2.id === c.id))];
            const criteriaMapping = allCriteria.map(c => ({ 
                id: c.id, 
                name: c.name.replace(/\s/g, '_').replace(/[\(\)]/g, '').replace(/\./g, '') 
            }));

            let csvContent = "data:text/csv;charset=utf-8,";
            let headers = ['Judge_ID','Judge_Name','Poster_ID','Poster_Title','Total_Score','Observations', 'Timestamp', ...criteriaMapping.map(c=>c.name)];
            csvContent += headers.join(',') + '\r\n';

            try {
                if (db && typeof collection === 'function' && typeof getDocs === 'function') {
                    const judge = predefinedUsers.find(u => u.id === judgeData.id);
                    if (!judge || !judge.firebaseId) {
                         showAlert('Error de autenticaci√≥n: UID de Firebase no encontrado.', 'error');
                         exportBtn.disabled=false; exportBtn.textContent='Exportar Evaluaciones (CSV)';
                         return;
                    }
                    
                    const evaluationsColRef = collection(db, `artifacts/${appId}/users/${judge.firebaseId}/evaluations`);
                    const querySnapshot = await getDocs(evaluationsColRef);
                    querySnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        const poster = predefinedPosters.find(p => p.id === data.posterId);
                        const posterTitle = poster ? poster.title.replace(/,/g,'') : 'Unknown Title';
                        let row = [
                            data.judgeId,
                            `"${data.judgeName.replace(/"/g,'""')}"`,
                            data.posterId,
                            `"${posterTitle}"`,
                            data.totalScore,
                            `"${(data.observations||'').replace(/"/g,'""').replace(/(\r\n|\n|\r)/gm,' ')}"`,
                            data.timestamp
                        ];
                        criteriaMapping.forEach(c => { row.push(data.scores?.[c.id] || 0); });
                        csvContent += row.join(',') + '\r\n';
                    });
                } else {
                    showAlert('Firestore no configurado: la exportaci√≥n solo funcionar√° si los datos est√°n en la nube.', 'error');
                    exportBtn.disabled=false; exportBtn.textContent='Exportar Evaluaciones (CSV)';
                    return;
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `evaluaciones_${judgeData.id}_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                exportBtn.textContent = 'Exportaci√≥n Exitosa';
                exportBtn.classList.replace('bg-blue-600','bg-green-600');
                setTimeout(()=>{ exportBtn.disabled=false; exportBtn.textContent='Exportar Evaluaciones (CSV)'; exportBtn.classList.replace('bg-green-600','bg-blue-600'); }, 3000);
            } catch (error) {
                console.error("Error al exportar CSV:", error);
                showAlert('Error al exportar las evaluaciones.', 'error');
                exportBtn.disabled=false; exportBtn.textContent='Exportar Evaluaciones (CSV)';
            }
        };

        const setupUIHandlers = () => {};
        
    </script>
</head>
<body class="bg-gray-50">
    <div id="app-container" class="min-h-screen">
        <!-- Esqueleto de Carga Inicial -->
        <div class="flex justify-center items-center h-screen">
            <div class="text-xl text-gray-500 animate-pulse">Cargando Sistema de Evaluaci√≥n...</div>
        </div>
    </div>
</body>
</html>
