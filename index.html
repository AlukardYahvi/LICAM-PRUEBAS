<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LICAM Asistente de Laboratorio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9; /* Slate 100 - Fondo m√°s profesional */
        }
        .tab-button {
            transition: all 0.3s ease;
            font-weight: 600;
        }
        .tab-button.active {
            border-color: #1d4ed8; /* Blue 700 para el borde */
            background-color: #eff6ff; /* Blue 50 para el fondo activo */
            color: #1d4ed8; /* Blue 700 para el texto activo */
            border-bottom-width: 3px;
        }
        .well {
            transition: all 0.2s ease;
            border: 3px solid #e2e8f0; /* Color de borde m√°s sutil */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        .well.selected {
            background-color: #bfdbfe; /* Blue 300 */
            border-color: #2563eb; /* Blue 600 */
            transform: scale(1.05); /* Transformaci√≥n m√°s sutil */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .well:not(.configured) .well-label {
            opacity: 0.6;
            font-style: italic;
        }
        /* Well Type Colors: Usamos sombras internas para un mejor efecto */
        .well.control { box-shadow: inset 0 0 0 3px #10b981; } /* Green 500 */
        .well.experimental { box-shadow: inset 0 0 0 3px #ef4444; } /* Red 500 */
        .well.blanco { box-shadow: inset 0 0 0 3px #6366f1; } /* Indigo 500 */
        .well.tratamiento-1 { box-shadow: inset 0 0 0 3px #f97316; } /* Orange 500 */
        .well.tratamiento-2 { box-shadow: inset 0 0 0 3px #8b5cf6; } /* Violet 500 */

        .modal {
            display: none;
            animation: fadeIn 0.3s ease;
            backdrop-filter: blur(5px); /* Efecto de desenfoque al modal */
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .sub-calc {
            display: none;
        }
        /* Estilos para el texto de resultados de calculadoras */
        .calc-result-box {
            background-color: #f0f9ff; /* Blue 50 */
            border-left: 4px solid #3b82f6; /* Blue 500 */
            padding: 1rem;
            border-radius: 0.5rem;
            font-family: monospace;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <header class="bg-white shadow-xl sticky top-0 z-10 border-b border-blue-200">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="logo_licam.png" alt="Logo LICAM" class="h-12 w-auto object-contain">
                <h1 class="text-3xl font-extrabold text-blue-700 tracking-tight">LICAM <span class="text-gray-500 font-semibold text-xl">Asistente de Laboratorio</span></h1>
            </div>
            <div>
                 <img src="logo_ipn.png" alt="Logo IPN" class="h-10 w-auto object-contain">
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 md:p-8">
        <div class="mb-8 border-b border-gray-300 bg-white p-2 rounded-xl shadow-lg">
            <nav class="flex space-x-1" aria-label="Tabs">
                <button onclick="changeTab('planner')" id="tab-planner" class="tab-button active text-lg py-3 px-6 rounded-t-lg border-transparent border-b-3 flex items-center space-x-2">üß™ Organizador de Cultivo</button>
                <button onclick="changeTab('report')" id="tab-report" class="tab-button text-lg py-3 px-6 rounded-t-lg border-transparent border-b-3 flex items-center space-x-2">üìÑ Reporte del Experimento</button>
                <button onclick="changeTab('calculators')" id="tab-calculators" class="tab-button text-lg py-3 px-6 rounded-t-lg border-transparent border-b-3 flex items-center space-x-2">üí° Calculadoras R√°pidas</button>
                <button onclick="changeTab('about')" id="tab-about" class="tab-button text-lg py-3 px-6 rounded-t-lg border-transparent border-b-3 flex items-center space-x-2">‚ÑπÔ∏è Acerca del Proyecto</button>
            </nav>
        </div>

        <div id="content-planner" class="space-y-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-1 bg-white p-6 rounded-3xl shadow-2xl border border-gray-200">
                    <h2 class="text-2xl font-bold mb-5 text-blue-700 flex items-center space-x-2">1. Configuraci√≥n ‚ú®</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="exp-name" class="block text-sm font-medium text-gray-700">Nombre del Experimento:</label>
                            <input type="text" id="exp-name" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2" placeholder="Ej: Curva de dosis PMA/LPS">
                        </div>
                        <div>
                            <label for="plate-type" class="block text-sm font-medium text-gray-700">Tipo de Placa:</label>
                            <select id="plate-type" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2">
                                <option value="6">6 Pozos</option>
                                <option value="12">12 Pozos</option>
                                <option value="24" selected>24 Pozos</option>
                                <option value="48">48 Pozos</option>
                                <option value="96">96 Pozos</option>
                            </select>
                        </div>
                        <button onclick="generatePlate()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition duration-300 shadow-md">Generar Placa</button>
                    </div>
                    
                    <div class="mt-8 pt-4 border-t border-gray-200">
                        <h3 class="text-xl font-bold mb-3 text-gray-700">Guardar / Cargar</h3>
                        <div class="flex space-x-2">
                            <button onclick="saveExperiment()" class="flex-1 bg-green-600 text-white font-bold py-2 px-3 text-sm rounded-xl hover:bg-green-700 transition shadow-md">üíæ Guardar Experimento</button>
                            <label for="load-exp-input" class="flex-1 bg-gray-600 text-white font-bold py-2 px-3 text-sm rounded-xl hover:bg-gray-700 cursor-pointer text-center transition shadow-md">üìÇ Cargar Experimento</label>
                            <input type="file" id="load-exp-input" class="hidden" accept=".json">
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-gray-200">
                        <h3 class="text-xl font-bold mb-3 text-gray-700">Controles de Selecci√≥n</h3>
                        <div class="flex space-x-2 mb-4">
                            <button onclick="selectAllWells()" class="flex-1 bg-gray-200 text-gray-800 py-2 px-3 text-sm rounded-xl hover:bg-gray-300 transition shadow-sm">Seleccionar Todos</button>
                            <button onclick="clearSelection()" class="flex-1 bg-gray-200 text-gray-800 py-2 px-3 text-sm rounded-xl hover:bg-gray-300 transition shadow-sm">Limpiar Selecci√≥n</button>
                        </div>
                       <button onclick="openWellConfigModal()" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-indigo-700 transition duration-300 shadow-lg">‚öôÔ∏è Configurar Pozo(s) Seleccionado(s)</button>
                    </div>
                </div>

                <div class="lg:col-span-2 bg-white p-6 rounded-3xl shadow-2xl border border-gray-200 flex flex-col">
                    <div class="flex justify-between items-center mb-5 border-b pb-3 border-gray-200">
                        <h2 class="text-2xl font-bold text-blue-700">2. Dise√±o de la Placa</h2>
                        <div class="flex flex-wrap gap-x-4 gap-y-1 text-xs items-center justify-end">
                            <span class="flex items-center p-1 rounded-md border border-green-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-green-500 mr-1"></span>Control</span>
                            <span class="flex items-center p-1 rounded-md border border-red-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-red-500 mr-1"></span>Experimental</span>
                            <span class="flex items-center p-1 rounded-md border border-indigo-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-indigo-500 mr-1"></span>Blanco</span>
                            <span class="flex items-center p-1 rounded-md border border-orange-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-orange-500 mr-1"></span>Trat. 1</span>
                            <span class="flex items-center p-1 rounded-md border border-violet-500"><span class="w-3 h-3 rounded-full bg-white border-2 border-violet-500 mr-1"></span>Trat. 2</span>
                        </div>
                    </div>
                    <div id="plate-layout-container" class="p-6 bg-gray-100 rounded-xl overflow-x-auto flex-grow flex items-center justify-center">
                        <div id="plate-layout" class="grid gap-3 p-2 bg-white rounded-lg shadow-inner" style="grid-template-columns: repeat(6, 1fr); display:none;">
                            </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-3xl shadow-2xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-blue-700 flex items-center space-x-2">3. C√°lculo de Mezcla Maestra üíß</h2>
                <div class="flex flex-col md:flex-row items-start md:items-center space-y-4 md:space-y-0 md:space-x-6 mb-4 p-4 bg-purple-50 rounded-xl border border-purple-200">
                    <button onclick="calculateMasterMix()" class="bg-purple-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-purple-700 transition duration-300 shadow-md flex-shrink-0">Calcular Master Mix</button>
                    <div class="flex items-center space-x-2">
                        <label for="extra-volume" class="mr-2 text-sm font-medium text-gray-700 whitespace-nowrap">Volumen extra (% de seguridad):</label>
                        <input type="number" id="extra-volume" value="10" class="w-20 border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 text-center p-2">
                    </div>
                </div>
                <div id="master-mix-results" class="calc-result-box">
                    <p class="text-gray-600 font-normal">Los resultados del c√°lculo para la mezcla maestra aparecer√°n aqu√≠.</p>
                </div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-2xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-blue-700 flex items-center space-x-2">4. Cronograma del Protocolo ‚è∞</h2>
                <div class="text-sm text-gray-700 mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 rounded-lg">
                    <b class="font-extrabold">üö® Alerta de Tiempo:</b> Las alarmas y notificaciones solo funcionar√°n si esta pesta√±a del navegador permanece abierta.
                </div>
                <div id="protocol-schedule-container" class="space-y-4">
                    <p class="text-gray-500">Los eventos del protocolo para los pozos configurados aparecer√°n aqu√≠.</p>
                </div>
            </div>
        </div>

        <div id="content-report" class="hidden space-y-6 bg-white p-8 rounded-3xl shadow-2xl border border-gray-200">
            <h2 class="text-3xl font-bold text-gray-800 border-b pb-4 text-blue-700">üìÑ Reporte del Experimento</h2>
            <div class="flex space-x-4">
                <button onclick="generateReport()" class="bg-teal-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-teal-700 transition shadow-md">Generar Reporte Completo</button>
                <button onclick="exportReportCSV()" id="export-csv-btn" class="bg-blue-600 text-white font-bold py-3 px-6 rounded-xl hover:bg-blue-700 transition shadow-md hidden">‚¨áÔ∏è Descargar Reporte (CSV)</button>
            </div>
            <div id="report-output" class="prose max-w-none mt-6 border-t pt-4">
                <p class="text-gray-500">Haz clic en el bot√≥n para generar un resumen de tu experimento.</p>
            </div>
        </div>

        <div id="content-calculators" class="hidden space-y-8">
            
            <div class="bg-white p-6 rounded-3xl shadow-2xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-blue-700">üî¨ Calculadora de Masa Molar</h2>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <div class="md:col-span-2">
                        <label for="chem-formula" class="block text-sm font-medium text-gray-700">F√≥rmula Qu√≠mica:</label>
                        <input type="text" id="chem-formula" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Ej: C6H12O6, NaCl">
                    </div>
                    <div>
                        <button onclick="calculateMolarMass()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition shadow-md">Calcular</button>
                    </div>
                </div>
                <div id="molar-mass-result" class="mt-4 calc-result-box text-gray-700"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-2xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-blue-700">üîÑ Conversor de Unidades</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 items-end">
                    <div>
                        <label for="uc-value" class="block text-sm font-medium text-gray-700">Valor:</label>
                        <input type="number" id="uc-value" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2">
                    </div>
                    <div>
                        <label for="uc-from" class="block text-sm font-medium text-gray-700">Desde:</label>
                        <select id="uc-from" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                    </div>
                    <div class="hidden md:block text-center text-xl font-bold text-gray-500">=</div>
                    <div>
                        <label for="uc-to" class="block text-sm font-medium text-gray-700">Hasta:</label>
                        <select id="uc-to" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                    </div>
                    <button onclick="convertUnits()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition shadow-md">Convertir</button>
                </div>
                <div id="uc-result" class="mt-4 calc-result-box text-gray-700"></div>
            </div>

            <div class="bg-white p-6 rounded-3xl shadow-2xl border border-gray-200">
                <h2 class="text-2xl font-bold mb-5 text-blue-700">üß™ Calculadora de Diluci√≥n (C‚ÇÅV‚ÇÅ = C‚ÇÇV‚ÇÇ)</h2>
                <div class="space-y-4">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div>
                            <label for="c1" class="block text-sm font-medium text-gray-700">C1 (Stock):</label>
                            <input type="number" id="c1" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Conc. inicial">
                        </div>
                        <div>
                            <label for="c1-unit" class="block text-sm font-medium text-gray-700">Unidad C1:</label>
                            <select id="c1-unit" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                        <div>
                            <label for="v1" class="block text-sm font-medium text-gray-700">V1 (Stock):</label>
                            <input type="number" id="v1" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Vol. inicial">
                        </div>
                        <div>
                            <label for="v1-unit" class="block text-sm font-medium text-gray-700">Unidad V1:</label>
                            <select id="v1-unit" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                        <div>
                            <label for="c2" class="block text-sm font-medium text-gray-700">C2 (Final):</label>
                            <input type="number" id="c2" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Conc. final">
                        </div>
                        <div>
                            <label for="c2-unit" class="block text-sm font-medium text-gray-700">Unidad C2:</label>
                            <select id="c2-unit" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                        <div>
                            <label for="v2" class="block text-sm font-medium text-gray-700">V2 (Final):</label>
                            <input type="number" id="v2" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Vol. final">
                        </div>
                        <div>
                            <label for="v2-unit" class="block text-sm font-medium text-gray-700">Unidad V2:</label>
                            <select id="v2-unit" class="mt-1 block w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
                        </div>
                    </div>
                </div>
                <div class="mt-6">
                    <button onclick="calculateDilution()" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-blue-700 transition shadow-md">Calcular Valor Faltante</button>
                </div>
                <div id="dilution-result" class="mt-4 calc-result-box text-gray-700"></div>
            </div>
        </div>

        <div id="content-about" class="hidden space-y-8 bg-white p-8 rounded-3xl shadow-2xl border border-gray-200">
            <h2 class="text-3xl font-extrabold text-blue-700 border-b pb-4">‚ÑπÔ∏è Acerca del Proyecto LICAM</h2>
            <div class="prose max-w-none text-gray-700">
                <p class="text-lg">Esta aplicaci√≥n es una herramienta de apoyo desarrollada como parte de un proyecto de tesis para optimizar el trabajo en el laboratorio, especialmente en la planificaci√≥n y seguimiento de cultivos celulares.</p>
                
                <h3 class="font-bold text-2xl text-blue-600 mt-8 mb-4 border-b border-blue-100 pb-2">Equipo de Desarrollo y Asesor√≠a</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-indigo-700">Tesista</p>
                        <p class="mt-1 font-semibold">Edsel Yahvi M√©ndez Hern√°ndez</p>
                    </div>
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-indigo-700">Asesora Externa</p>
                        <p class="mt-1 font-semibold">Dra. Nayelli N√°jera Garc√≠a</p>
                    </div>
                    <div class="p-4 bg-gray-50 border border-gray-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-indigo-700">Asesor Docente</p>
                        <p class="mt-1 font-semibold">Dr. Bustos Garc√≠a Juan Roberto Israel</p>
                    </div>
                </div>

                <h3 class="font-bold text-2xl text-blue-600 mt-10 mb-4 border-b border-blue-100 pb-2">Instituci√≥n y Laboratorio</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-blue-700">Instituci√≥n</p>
                        <p class="mt-1 font-semibold">Escuela Superior de Medicina (ESM) - IPN</p>
                    </div>
                    <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl shadow-md transition hover:shadow-lg">
                        <p class="text-xl font-extrabold text-blue-700">Laboratorio Colaborador (LICAM)</p>
                        <p class="mt-1 font-semibold">Investigaci√≥n Integral Cardiometab√≥lica (IPN)</p>
                    </div>
                </div>
                
                <div class="mt-10 pt-6 border-t border-gray-200">
                    <h3 class="font-bold text-2xl text-blue-600">Contacto y Redes</h3>
                    <p class="mt-4">
                        <span class="font-bold">Direcci√≥n:</span> Plan de San Luis y D√≠az Mir√≥n s/n Col. Casco de Santo Tom√°s, Miguel Hidalgo, 11340, Ciudad de M√©xico, CDMX.
                    </p>
                    <p>
                        <span class="font-bold">Correo:</span> nnajerag@ipn.mx
                    </p>
                    <p>
                        <span class="font-bold">Tel√©fono:</span> 55 5729 6300 ext 62820
                    </p>
                    <div class="mt-4 flex space-x-4 text-lg">
                        <a href="https://cemiztli.wixsite.com/cardiometabolismo" target="_blank" class="text-blue-500 hover:text-blue-700 font-semibold transition flex items-center">
                            üåê Website
                        </a>
                        <a href="#" class="text-blue-500 hover:text-blue-700 font-semibold transition flex items-center">
                            üìò Facebook
                        </a>
                        <a href="#" class="text-blue-500 hover:text-blue-700 font-semibold transition flex items-center">
                            üì∏ Instagram
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </main>

    <div id="well-config-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-70 flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-4xl max-h-[95vh] overflow-y-auto p-8 border-4 border-indigo-500/50">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Configurar Pozo(s): <span id="well-ids-display" class="text-indigo-600 font-extrabold"></span></h2>
                <button onclick="closeWellConfigModal()" class="text-3xl text-gray-500 hover:text-gray-800 transition leading-none">&times;</button>
            </div>
            
            <div class="space-y-6">
                <div>
                    <h3 class="font-bold text-xl mb-3 text-indigo-700 border-b border-indigo-100 pb-2">Par√°metros Generales</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 p-4 border rounded-xl bg-indigo-50">
                        <div>
                            <label for="well-type" class="block text-sm font-medium text-gray-700">Tipo de Pozo:</label>
                            <select id="well-type" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2">
                                <option value="default">No Asignado</option>
                                <option value="control">Control</option>
                                <option value="experimental">Experimental</option>
                                <option value="blanco">Blanco</option>
                                <option value="tratamiento-1">Tratamiento 1</option>
                                <option value="tratamiento-2">Tratamiento 2</option>
                            </select>
                        </div>
                        <div>
                            <label for="well-total-volume" class="block text-sm font-medium text-gray-700">Volumen Total Final (¬µL):</label>
                            <input type="number" id="well-total-volume" class="mt-1 w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Ej: 2000">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-gray-700">C√©lulas por Pozo:</label>
                            <div class="flex items-center space-x-2">
                                <input type="number" id="well-cell-count" class="w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Ej: 200000">
                                <button onclick="toggleSubCalc('cell-calc')" class="bg-gray-200 p-2 rounded-lg hover:bg-gray-300 transition">‚öôÔ∏è</button>
                            </div>
                            <div id="cell-calc" class="sub-calc p-3 border rounded-lg bg-white mt-2 space-y-3 shadow-inner">
                                <div class="space-y-2">
                                    <p class="text-xs font-semibold text-gray-700 border-b pb-1">Calcular volumen de stock celular:</p>
                                    <div class="flex items-center space-x-2">
                                        <input type="number" id="cell-stock-conc" placeholder="Conc. stock" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                        <select id="cell-stock-conc-unit" class="text-sm border-gray-300 rounded-lg p-2">
                                            <option value="1">c√©lulas/mL</option>
                                            <option value="1000">c√©lulas/¬µL</option>
                                        </select>
                                    </div>
                                    <button onclick="calculateCellVolume()" class="w-full text-sm bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition shadow-sm">Calcular Volumen (¬µL)</button>
                                    <p id="cell-volume-result" class="text-sm font-medium text-blue-700 bg-blue-100 p-2 rounded-lg"></p>
                                </div>
                                <div class="mt-4 pt-4 border-t border-gray-200 space-y-2">
                                    <p class="text-xs font-semibold text-gray-700 border-b pb-1">Calculadora C√°mara de Neubauer:</p>
                                    <div class="grid grid-cols-2 gap-2">
                                        <input type="number" id="neubauer-q1" placeholder="Cuadrante 1" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                        <input type="number" id="neubauer-q2" placeholder="Cuadrante 2" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                        <input type="number" id="neubauer-q3" placeholder="Cuadrante 3" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                        <input type="number" id="neubauer-q4" placeholder="Cuadrante 4" class="w-full text-sm border-gray-300 rounded-lg p-2">
                                    </div>
                                    <button onclick="calculateNeubauer()" class="w-full text-sm bg-teal-500 text-white py-2 rounded-lg hover:bg-teal-600 transition shadow-sm">Calcular Concentraci√≥n</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <h3 class="font-bold text-xl mb-3 text-indigo-700 border-b border-indigo-100 pb-2">Variables / Reactivos</h3>
                    <div id="variables-container" class="space-y-4">
                        </div>
                    <button onclick="addVariable()" class="mt-4 text-sm bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-xl hover:bg-gray-300 transition shadow-sm">+ A√±adir Variable</button>
                </div>

                <div>
                    <h3 class="font-bold text-xl mb-3 text-indigo-700 border-b border-indigo-100 pb-2">Pasos del Protocolo</h3>
                    <div class="p-4 border rounded-xl bg-indigo-50 space-y-4">
                        <div id="protocol-steps-container" class="space-y-3">
                            </div>
                        <button onclick="addProtocolStep()" class="text-sm bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-xl hover:bg-gray-300 transition shadow-sm">+ A√±adir Paso</button>
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-6 border-t border-gray-200 flex justify-end space-x-4">
                <button onclick="closeWellConfigModal()" class="bg-gray-500 text-white font-bold py-3 px-8 rounded-xl hover:bg-gray-600 transition shadow-lg">Cancelar</button>
                <button onclick="saveWellConfig()" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-xl hover:bg-blue-700 transition shadow-lg">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <div id="variable-template" class="hidden p-4 border rounded-xl bg-gray-50 transition hover:bg-gray-100">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-x-4 gap-y-3 items-center">
            <div class="md:col-span-12 flex justify-between items-center border-b pb-2 mb-2">
                <input type="text" class="variable-name w-full md:w-1/3 border-0 bg-transparent font-extrabold text-gray-800 focus:ring-0 text-lg" placeholder="Nombre (Ej: PMA)">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold transition">üóëÔ∏è Eliminar</button>
            </div>

            <label class="md:col-span-2 text-sm font-medium text-gray-700">Conc. Final:</label>
            <div class="md:col-span-4">
                <input type="number" class="variable-final-conc w-full border-gray-300 rounded-lg shadow-sm p-2" placeholder="Valor">
            </div>
            <div class="md:col-span-4">
                <select class="variable-final-conc-unit w-full border-gray-300 rounded-lg shadow-sm p-2"></select>
            </div>
            <div class="md:col-span-2">
                <button onclick="toggleSubCalc(this.dataset.target)" data-target="stock-calc-X" class="stock-calc-toggle bg-indigo-500 text-white p-2 rounded-lg hover:bg-indigo-600 w-full text-sm transition shadow-sm">‚öôÔ∏è Stock</button>
            </div>

            <div class="sub-calc md:col-span-12 p-3 border rounded-lg bg-white mt-2 space-y-3 shadow-inner">
                <p class="text-xs font-semibold text-gray-700 border-b pb-1">Calcular volumen de stock del reactivo:</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <input type="number" class="variable-stock-conc w-full text-sm border-gray-300 rounded-lg p-2" placeholder="Conc. stock">
                    <select class="variable-stock-conc-unit w-full text-sm border-gray-300 rounded-lg p-2"></select>
                </div>
                <button onclick="calculateStockVolume(this)" class="w-full text-sm bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 transition shadow-sm">Calcular Volumen (¬µL)</button>
                <p class="variable-stock-volume-result text-sm font-medium text-blue-700 bg-blue-100 p-2 rounded-lg"></p>
            </div>
        </div>
    </div>

    <div id="protocol-step-template" class="hidden p-3 border rounded-xl bg-white shadow-sm hover:shadow-md transition">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-center">
            <input type="text" class="protocol-step-name md:col-span-1 border-gray-300 rounded-lg p-2" placeholder="Nombre (Ej: Incubaci√≥n PMA)">
            <div class="flex items-center space-x-2 md:col-span-2">
                <input type="number" class="protocol-step-duration w-1/2 border-gray-300 rounded-lg p-2" placeholder="Duraci√≥n">
                <select class="protocol-step-unit w-1/2 border-gray-300 rounded-lg p-2">
                    <option value="3600000">horas</option>
                    <option value="60000">minutos</option>
                    <option value="86400000">d√≠as</option>
                </select>
            </div>
            <div class="md:col-span-1 flex justify-end">
                <button onclick="this.parentElement.parentElement.parentElement.remove()" class="text-red-500 hover:text-red-700 font-bold transition">üóëÔ∏è Eliminar</button>
            </div>
        </div>
    </div>
    
    <div id="toast" class="toast fixed bottom-5 right-5 bg-green-600 text-white py-4 px-8 rounded-xl shadow-2xl z-50">
        <p id="toast-message" class="font-semibold"></p>
    </div>

    <script>
        // *** TU C√ìDIGO JAVASCRIPT NO HA SIDO MODIFICADO ***
        // Para mantener la funcionalidad intacta, el JavaScript se mantiene
        // igual que en tu c√≥digo original.

        const ATOMIC_WEIGHTS = {
            'H': 1.008, 'He': 4.0026, 'Li': 6.94, 'Be': 9.0122, 'B': 10.81, 'C': 12.011, 'N': 14.007,
            'O': 15.999, 'F': 18.998, 'Ne': 20.180, 'Na': 22.990, 'Mg': 24.305, 'Al': 26.982, 'Si': 28.085,
            'P': 30.974, 'S': 32.06, 'Cl': 35.45, 'Ar': 39.948, 'K': 39.098, 'Ca': 40.078, 'Sc': 44.956,
            'Ti': 47.867, 'V': 50.942, 'Cr': 51.996, 'Mn': 54.938, 'Fe': 55.845, 'Co': 58.933, 'Ni': 58.693,
            'Cu': 63.546, 'Zn': 65.38, 'Ga': 69.723, 'Ge': 72.630, 'As': 74.922, 'Se': 78.971, 'Br': 79.904,
            'Kr': 83.798, 'Rb': 85.468, 'Sr': 87.62, 'Y': 88.906, 'Zr': 91.224, 'Nb': 92.906, 'Mo': 95.96,
            'Tc': 98, 'Ru': 101.07, 'Rh': 102.91, 'Pd': 106.42, 'Ag': 107.87, 'Cd': 112.41, 'In': 114.82,
            'Sn': 118.71, 'Sb': 121.76, 'Te': 127.60, 'I': 126.90, 'Xe': 131.29, 'Cs': 132.91, 'Ba': 137.33,
        };

        const CONVERSION_FACTORS = {
            'mass': { 'g': 1, 'mg': 1e-3, '¬µg': 1e-6, 'ng': 1e-9, 'pg': 1e-12 },
            'volume': { 'L': 1, 'mL': 1e-3, '¬µL': 1e-6, 'nL': 1e-9 },
            'concentration': { 'M': 1, 'mM': 1e-3, '¬µM': 1e-6, 'nM': 1e-9 },
        };
        
        let wellData = {}; 
        let selectedWells = new Set();
        let variableCounter = 0;
        let runningTimers = {};

        // --- TABS & NAVIGATION ---
        function changeTab(tabName) {
            const contents = ['planner', 'report', 'calculators', 'about'];
            contents.forEach(content => {
                document.getElementById(`content-${content}`).style.display = content === tabName ? 'block' : 'none';
                document.getElementById(`tab-${content}`).classList.toggle('active', content === tabName);
            });
        }

        // --- QUICK CALCULATORS ---
        function parseFormula(formula) {
            const regex = /([A-Z][a-z]*)(\d*)|(\()|(\))(\d*)/g;
            let match;
            const stack = [{}];
            while ((match = regex.exec(formula))) {
                const [, element, count, openParen, closeParen, parenCount] = match;
                if (element) {
                    const currentGroup = stack[stack.length - 1];
                    currentGroup[element] = (currentGroup[element] || 0) + (count ? parseInt(count) : 1);
                } else if (openParen) {
                    stack.push({});
                } else if (closeParen) {
                    const completedGroup = stack.pop();
                    const multiplier = parenCount ? parseInt(parenCount) : 1;
                    const currentGroup = stack[stack.length - 1];
                    for (const el in completedGroup) {
                        currentGroup[el] = (currentGroup[el] || 0) + completedGroup[el] * multiplier;
                    }
                }
            }
            return stack[0];
        }

        function calculateMolarMass() {
            const formula = document.getElementById('chem-formula').value;
            const resultDiv = document.getElementById('molar-mass-result');
            if (!formula) {
                resultDiv.innerHTML = `<span class="text-red-500">Por favor, introduce una f√≥rmula.</span>`;
                return;
            }
            try {
                const composition = parseFormula(formula);
                let totalMass = 0;
                let breakdown = [];
                for (const element in composition) {
                    if (!ATOMIC_WEIGHTS[element]) {
                        throw new Error(`Elemento desconocido: ${element}`);
                    }
                    const mass = ATOMIC_WEIGHTS[element] * composition[element];
                    totalMass += mass;
                    breakdown.push(`<b>${element}</b>: ${composition[element]} x ${ATOMIC_WEIGHTS[element]} = ${mass.toFixed(4)}`);
                }
                resultDiv.innerHTML = `<b>Masa Molar Total: <span class="text-blue-600">${totalMass.toFixed(4)} g/mol</span></b><br><small>${breakdown.join('<br>')}</small>`;
            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
            }
        }
        
        function getUnitType(unit) {
            if (!unit) return null;
            if (CONVERSION_FACTORS.mass[unit]) return 'mass';
            if (CONVERSION_FACTORS.volume[unit]) return 'volume';
            if (CONVERSION_FACTORS.concentration[unit]) return 'concentration';
            if (unit.includes('/')) return 'combined';
            return null;
        }

        function _pureConvertCombinedUnits(value, from, to) {
            const [fromMass, fromVol] = from.split('/');
            const [toMass, toVol] = to.split('/');

            if (!CONVERSION_FACTORS.mass[fromMass] || !CONVERSION_FACTORS.volume[fromVol] || !CONVERSION_FACTORS.mass[toMass] || !CONVERSION_FACTORS.volume[toVol]) {
                return NaN;
            }
            const valueInG = value * CONVERSION_FACTORS.mass[fromMass];
            const fromVolInL = 1 * CONVERSION_FACTORS.volume[fromVol];
            const valueInGL = valueInG / fromVolInL;
            const finalValueMass = valueInGL / CONVERSION_FACTORS.mass[toMass];
            const toVolInL = 1 * CONVERSION_FACTORS.volume[toVol];
            const finalValue = finalValueMass * toVolInL;
            return finalValue;
        }

        function _pureConvertUnits(value, from, to) {
            if (isNaN(value) || !from || !to) return NaN;
            if (from === to) return value;

            const fromType = getUnitType(from);
            const toType = getUnitType(to);
            
            if (fromType === 'combined' && toType === 'combined') {
                return _pureConvertCombinedUnits(value, from, to);
            }
            
            if (fromType !== toType || !fromType) {
                return NaN;
            }
            
            const baseValue = value * CONVERSION_FACTORS[fromType][from];
            const finalValue = baseValue / CONVERSION_FACTORS[toType][to];
            return finalValue;
        }


        function convertUnits() {
            const value = parseFloat(document.getElementById('uc-value').value);
            const from = document.getElementById('uc-from').value;
            const to = document.getElementById('uc-to').value;
            const resultDiv = document.getElementById('uc-result');

            const finalValue = _pureConvertUnits(value, from, to);
            
            if (isNaN(finalValue)) {
                resultDiv.innerHTML = `<span class="text-red-500">No se puede convertir entre estas unidades.</span>`;
            } else {
                resultDiv.textContent = `${value} ${from} = ${finalValue.toExponential(4)} ${to}`;
            }
        }

        function calculateDilution() {
            const fields = {
                c1: { val: parseFloat(document.getElementById('c1').value), unit: document.getElementById('c1-unit').value },
                v1: { val: parseFloat(document.getElementById('v1').value), unit: document.getElementById('v1-unit').value },
                c2: { val: parseFloat(document.getElementById('c2').value), unit: document.getElementById('c2-unit').value },
                v2: { val: parseFloat(document.getElementById('v2').value), unit: document.getElementById('v2-unit').value },
            };

            const resultDiv = document.getElementById('dilution-result');
            const emptyFields = Object.keys(fields).filter(k => isNaN(fields[k].val));

            if (emptyFields.length !== 1) {
                resultDiv.innerHTML = `<span class="text-red-500">Por favor, introduce exactamente 3 valores num√©ricos.</span>`;
                return;
            }

            const missingVar = emptyFields[0];
            let result;
            let resultUnit;

            try {
                const c2_conv = _pureConvertUnits(fields.c2.val, fields.c2.unit, fields.c1.unit);
                const v2_conv = _pureConvertUnits(fields.v2.val, fields.v2.unit, fields.v1.unit);
                
                if (isNaN(c2_conv) && !isNaN(fields.c2.val)) throw new Error(`No se puede convertir la unidad de C2 (${fields.c2.unit}) a la de C1 (${fields.c1.unit}).`);
                if (isNaN(v2_conv) && !isNaN(fields.v2.val)) throw new Error(`No se puede convertir la unidad de V2 (${fields.v2.unit}) a la de V1 (${fields.v1.unit}).`);

                let c1_val = fields.c1.val;
                let v1_val = fields.v1.val;

                switch (missingVar) {
                    case 'c1':
                        result = (c2_conv * v2_conv) / v1_val;
                        resultUnit = fields.c1.unit;
                        break;
                    case 'v1':
                        result = (c2_conv * v2_conv) / c1_val;
                        resultUnit = fields.v1.unit;
                        break;
                    case 'c2':
                        const c2_in_c1_units = (c1_val * v1_val) / v2_conv;
                        result = _pureConvertUnits(c2_in_c1_units, fields.c1.unit, fields.c2.unit);
                        resultUnit = fields.c2.unit;
                        break;
                    case 'v2':
                        const v2_in_v1_units = (c1_val * v1_val) / c2_conv;
                        result = _pureConvertUnits(v2_in_v1_units, fields.v1.unit, fields.v2.unit);
                        resultUnit = fields.v2.unit;
                        break;
                }

                if (isNaN(result) || !isFinite(result)) {
                    throw new Error("El resultado es inv√°lido. Revisa los valores.");
                }

                resultDiv.textContent = `Resultado: ${missingVar.toUpperCase()} = ${result.toPrecision(4)} ${resultUnit}`;

            } catch (error) {
                resultDiv.innerHTML = `<span class="text-red-500">Error: ${error.message}</span>`;
            }
        }

        // --- PLATE PLANNER ---
        function generatePlate(restoringData = null) {
            const plateType = restoringData ? restoringData.plateType : document.getElementById('plate-type').value;
            document.getElementById('plate-type').value = plateType;
            const layout = document.getElementById('plate-layout');
            layout.innerHTML = '';
            
            if (!restoringData) {
                wellData = {};
            }
            selectedWells.clear();

            const plateConfigs = {
                '6': { rows: 2, cols: 3 }, '12': { rows: 3, cols: 4 },
                '24': { rows: 4, cols: 6 }, '48': { rows: 6, cols: 8 },
                '96': { rows: 8, cols: 12 },
            };
            const config = plateConfigs[plateType];
            layout.style.gridTemplateColumns = `repeat(${config.cols}, minmax(0, 1fr))`;
            layout.style.display = 'grid';

            for (let r = 0; r < config.rows; r++) {
                for (let c = 0; c < config.cols; c++) {
                    const rowLabel = String.fromCharCode(65 + r);
                    const colLabel = c + 1;
                    const wellId = `${rowLabel}${colLabel}`;
                    
                    const well = document.createElement('div');
                    well.id = `well-${wellId}`;
                    well.className = 'well w-12 h-12 md:w-16 md:h-16 rounded-full flex items-center justify-center cursor-pointer bg-white';
                    well.dataset.id = wellId;
                    
                    const label = document.createElement('span');
                    label.className = 'well-label text-sm md:text-base font-semibold';
                    label.textContent = wellId;
                    well.appendChild(label);

                    well.addEventListener('click', () => toggleWellSelection(wellId));
                    layout.appendChild(well);

                    if (restoringData && restoringData.wellData[wellId]) {
                        const data = restoringData.wellData[wellId];
                        well.classList.add('configured');
                        if (data.wellType && data.wellType !== 'default') {
                            well.classList.add(data.wellType);
                        }
                    }
                }
            }
            updateProtocolSchedule();
        }


        function toggleWellSelection(wellId) {
            const wellEl = document.getElementById(`well-${wellId}`);
            if (selectedWells.has(wellId)) {
                selectedWells.delete(wellId);
                wellEl.classList.remove('selected');
            } else {
                selectedWells.add(wellId);
                wellEl.classList.add('selected');
            }
        }

        function selectAllWells() {
            document.querySelectorAll('.well').forEach(well => {
                const wellId = well.dataset.id;
                if (!selectedWells.has(wellId)) {
                    selectedWells.add(wellId);
                    well.classList.add('selected');
                }
            });
        }
        
        function clearSelection() {
            selectedWells.forEach(wellId => {
                document.getElementById(`well-${wellId}`).classList.remove('selected');
            });
            selectedWells.clear();
        }

        function openWellConfigModal() {
            if (selectedWells.size === 0) {
                showToast('Por favor, selecciona al menos un pozo para configurar.', 'error');
                return;
            }
            const wellIds = Array.from(selectedWells).sort();
            document.getElementById('well-ids-display').textContent = wellIds.join(', ');
            
            const firstWellId = wellIds[0];
            if (wellData[firstWellId]) {
                loadConfigToModal(wellData[firstWellId]);
            } else {
                resetModal();
            }

            document.getElementById('well-config-modal').style.display = 'flex';
        }

        function closeWellConfigModal() {
            document.getElementById('well-config-modal').style.display = 'none';
        }
        
        function resetModal() {
            document.getElementById('well-type').value = 'default';
            document.getElementById('well-total-volume').value = '';
            document.getElementById('well-cell-count').value = '';
            document.getElementById('variables-container').innerHTML = '';
            document.getElementById('protocol-steps-container').innerHTML = '';
            variableCounter = 0;
            addVariable(); 
            addProtocolStep();
        }

        function loadConfigToModal(data) {
            resetModal();
            document.getElementById('well-type').value = data.wellType || 'default';
            document.getElementById('well-total-volume').value = data.totalVolume || '';
            document.getElementById('well-cell-count').value = data.cells.count || '';
            
            const variablesContainer = document.getElementById('variables-container');
            variablesContainer.innerHTML = ''; 
            if (data.variables && data.variables.length > 0) {
                data.variables.forEach(v => addVariable(v));
            } else {
                addVariable();
            }
            
            const stepsContainer = document.getElementById('protocol-steps-container');
            stepsContainer.innerHTML = '';
            if (data.protocol && data.protocol.steps.length > 0) {
                data.protocol.steps.forEach(s => addProtocolStep(s));
            } else {
                addProtocolStep();
            }
        }

        function saveWellConfig() {
            const wellType = document.getElementById('well-type').value;
            const totalVolume = parseFloat(document.getElementById('well-total-volume').value);
            const cellCount = parseFloat(document.getElementById('well-cell-count').value);

            const variables = [];
            document.querySelectorAll('#variables-container > div:not([id="variable-template"])').forEach(varDiv => {
                const variable = {
                    id: varDiv.dataset.id,
                    name: varDiv.querySelector('.variable-name').value,
                    finalConc: parseFloat(varDiv.querySelector('.variable-final-conc').value),
                    finalConcUnit: varDiv.querySelector('.variable-final-conc-unit').value,
                };
                if (variable.name && !isNaN(variable.finalConc)) {
                    variables.push(variable);
                }
            });
            
            const protocolSteps = [];
            document.querySelectorAll('#protocol-steps-container > div:not([id="protocol-step-template"])').forEach(stepDiv => {
                const step = {
                    name: stepDiv.querySelector('.protocol-step-name').value,
                    duration: parseFloat(stepDiv.querySelector('.protocol-step-duration').value),
                    unit: parseInt(stepDiv.querySelector('.protocol-step-unit').value)
                };
                if (step.name && !isNaN(step.duration)) {
                    protocolSteps.push(step);
                }
            });

            const configData = {
                wellType,
                totalVolume,
                cells: { count: cellCount },
                variables,
                protocol: {
                    steps: protocolSteps
                }
            };
            
            selectedWells.forEach(wellId => {
                wellData[wellId] = JSON.parse(JSON.stringify(configData));
                const wellEl = document.getElementById(`well-${wellId}`);
                wellEl.classList.remove('control', 'experimental', 'blanco', 'tratamiento-1', 'tratamiento-2', 'default');
                if(wellType !== 'default') {
                    wellEl.classList.add(wellType);
                }
                wellEl.classList.add('configured');
                wellEl.classList.remove('selected');
            });
            
            updateProtocolSchedule();
            clearSelection();
            closeWellConfigModal();
            showToast('Configuraci√≥n guardada para los pozos seleccionados.');
        }
        
        function addVariable(data = null) {
            const template = document.getElementById('variable-template');
            const clone = template.cloneNode(true);
            clone.id = '';
            clone.classList.remove('hidden');
            
            const uniqueId = `var-${variableCounter++}`;
            clone.dataset.id = uniqueId;

            populateUnitDropdowns(clone);
            
            const stockCalcToggle = clone.querySelector('.stock-calc-toggle');
            const subCalcDiv = clone.querySelector('.sub-calc');
            const subCalcId = `stock-calc-${uniqueId}`;
            stockCalcToggle.dataset.target = subCalcId;
            subCalcDiv.id = subCalcId;
            
            if (data) {
                clone.querySelector('.variable-name').value = data.name || '';
                clone.querySelector('.variable-final-conc').value = data.finalConc || '';
                clone.querySelector('.variable-final-conc-unit').value = data.finalConcUnit || '¬µM';
            }

            document.getElementById('variables-container').appendChild(clone);
        }

        function addProtocolStep(data = null) {
            const template = document.getElementById('protocol-step-template');
            const clone = template.cloneNode(true);
            clone.id = '';
            clone.classList.remove('hidden');
            if (data) {
                clone.querySelector('.protocol-step-name').value = data.name || '';
                clone.querySelector('.protocol-step-duration').value = data.duration || '';
                clone.querySelector('.protocol-step-unit').value = data.unit || '3600000';
            }
            document.getElementById('protocol-steps-container').appendChild(clone);
        }

        function calculateCellVolume() {
            const cellCount = parseFloat(document.getElementById('well-cell-count').value);
            let stockConc = parseFloat(document.getElementById('cell-stock-conc').value); // in cells/mL or cells/uL
            const stockUnit = parseFloat(document.getElementById('cell-stock-conc-unit').value);
            const resultEl = document.getElementById('cell-volume-result');

            if (isNaN(cellCount) || isNaN(stockConc) || stockConc === 0) {
                resultEl.textContent = 'Inputs inv√°lidos.';
                return;
            }
            
            // Convert stock to cells/mL for consistent calculation
            const stockConcInMl = stockConc * stockUnit;

            const volumeInMicroL = (cellCount / stockConcInMl) * 1000;
            resultEl.textContent = `Tomar: ${volumeInMicroL.toFixed(2)} ¬µL`;
        }

        function calculateNeubauer() {
            const q1 = parseFloat(document.getElementById('neubauer-q1').value) || 0;
            const q2 = parseFloat(document.getElementById('neubauer-q2').value) || 0;
            const q3 = parseFloat(document.getElementById('neubauer-q3').value) || 0;
            const q4 = parseFloat(document.getElementById('neubauer-q4').value) || 0;

            const sum = q1 + q2 + q3 + q4;
            if (sum === 0) {
                showToast("Introduce los conteos de los cuadrantes.", "error");
                return;
            }
            const avg = sum / 4;
            const concentration = avg * 10000; // cells/mL
            
            document.getElementById('cell-stock-conc-unit').value = "1"; // Set unit to cells/mL
            document.getElementById('cell-stock-conc').value = concentration;
            showToast(`Concentraci√≥n calculada: ${concentration.toExponential(2)} c√©lulas/mL.`);
        }

        function calculateStockVolume(button) {
            const parent = button.closest('.grid');
            const finalConc = parseFloat(parent.querySelector('.variable-final-conc').value);
            const finalConcUnit = parent.querySelector('.variable-final-conc-unit').value;
            const stockConc = parseFloat(parent.querySelector('.variable-stock-conc').value);
            const stockConcUnit = parent.querySelector('.variable-stock-conc-unit').value;
            const totalVolume = parseFloat(document.getElementById('well-total-volume').value); // in ¬µL
            const resultEl = parent.querySelector('.variable-stock-volume-result');

            if (isNaN(finalConc) || isNaN(stockConc) || isNaN(totalVolume) || stockConc === 0) {
                resultEl.textContent = 'Inputs inv√°lidos.';
                return;
            }
            
            const finalConcConverted = _pureConvertUnits(finalConc, finalConcUnit, stockConcUnit);
            if (isNaN(finalConcConverted)) {
                resultEl.textContent = 'Error de conversi√≥n de unidad.';
                return;
            }

            const V2_in_uL = totalVolume;
            const V1_in_uL = (finalConcConverted * V2_in_uL) / stockConc;

            resultEl.textContent = `Tomar: ${V1_in_uL.toFixed(3)} ¬µL`;
        }
        
        function calculateMasterMix() {
            if (selectedWells.size === 0) {
                showToast("Selecciona los pozos para los que quieres calcular la mezcla.", 'error');
                return;
            }
            
            const numWells = selectedWells.size;
            const extraVolFactor = 1 + (parseFloat(document.getElementById('extra-volume').value) || 0) / 100;
            const totalWellsToPrep = numWells * extraVolFactor;

            const masterMix = {};
            let firstWellId = Array.from(selectedWells)[0];
            const baseConfig = wellData[firstWellId];

            if (!baseConfig) {
                showToast("El primer pozo seleccionado no est√° configurado.", 'error');
                return;
            }

            masterMix['C√©lulas'] = { 
                total: `${(baseConfig.cells.count * totalWellsToPrep).toExponential(2)} c√©lulas`,
                note: 'El volumen a tomar depende de la concentraci√≥n de tu stock celular.'
            };
            
            baseConfig.variables.forEach(v => {
                masterMix[v.name] = {
                    total: `A√±adir para una concentraci√≥n final de ${v.finalConc} ${v.finalConcUnit}`,
                    note: 'El volumen a tomar depende de la concentraci√≥n de tu reactivo stock.'
                };
            });
            
            let html = `<h3 class="font-extrabold mb-3 text-lg text-gray-800">Receta para ${numWells} pozos (+${(extraVolFactor-1)*100}% extra):</h3>`;
            html += `<table class="min-w-full divide-y divide-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-blue-200"><tr>
                            <th class="px-4 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Componente</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Cantidad Total / Objetivo</th>
                            <th class="px-4 py-3 text-left text-xs font-bold text-blue-800 uppercase tracking-wider">Notas</th>
                        </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

            for(const component in masterMix) {
                html += `<tr>
                            <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${component}</td>
                            <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-800">${masterMix[component].total}</td>
                            <td class="px-4 py-3 text-sm text-gray-500">${masterMix[component].note}</td>
                          </tr>`;
            }
            
            html += `<tr class="bg-blue-100">
                        <td class="px-4 py-3 text-sm font-extrabold text-blue-800">Medio de cultivo (completar hasta)</td>
                         <td class="px-4 py-3 text-sm font-extrabold text-blue-800">${(baseConfig.totalVolume * totalWellsToPrep).toFixed(2)} ¬µL</td><td></td>
                     </tr>`;

            html += `</tbody></table><p class="text-xs mt-4 text-gray-600">Usa las sub-calculadoras en la configuraci√≥n de pozos para determinar los vol√∫menes exactos a tomar de tus stocks.</p>`;
            document.getElementById('master-mix-results').innerHTML = html;
        }

        function updateProtocolSchedule() {
            const scheduleContainer = document.getElementById('protocol-schedule-container');
            scheduleContainer.innerHTML = '';
            let allSteps = [];

            for (const wellId in wellData) {
                const data = wellData[wellId];
                if (!data.protocol || !data.protocol.steps) continue;
                
                data.protocol.steps.forEach((step, index) => {
                    allSteps.push({ ...step, wellId, stepIndex: index + 1, eventId: `${wellId}-${step.name.replace(/\s/g, '')}-${index}` });
                });
            }
            
            const uniqueSteps = Object.values(allSteps.reduce((acc, cur) => {
                const key = `${cur.name}-${cur.duration}-${cur.unit}-${cur.stepIndex}`;
                if (!acc[key]) {
                    acc[key] = { ...cur, wells: [cur.wellId] };
                } else {
                    acc[key].wells.push(cur.wellId);
                }
                return acc;
            }, {}));
            
            uniqueSteps.sort((a,b) => a.stepIndex - b.stepIndex);


            if (uniqueSteps.length === 0) {
                scheduleContainer.innerHTML = '<p class="text-gray-500">No hay pasos de protocolo configurados.</p>';
                return;
            }

            uniqueSteps.forEach((step) => {
                const durationMs = step.duration * step.unit;
                const unitText = step.unit === 3600000 ? 'horas' : step.unit === 60000 ? 'minutos' : 'd√≠as';

                const eventEl = document.createElement('div');
                eventEl.className = 'flex flex-col md:flex-row items-start md:items-center justify-between p-4 bg-white border border-gray-200 rounded-xl shadow-sm transition hover:shadow-md';
                eventEl.innerHTML = `
                    <div>
                        <span class="font-extrabold text-lg text-gray-800">Paso ${step.stepIndex}: ${step.name}</span>
                        <span class="text-md text-blue-600 ml-2">(${step.duration} ${unitText})</span>
                        <p class="text-xs text-gray-500 mt-1">Pozos: ${step.wells.join(', ')}</p>
                    </div>
                    <div class="flex items-center space-x-3 mt-3 md:mt-0">
                        <span id="timer-display-${step.eventId}" class="font-mono text-xl text-indigo-700">--:--:--</span>
                        <button id="timer-btn-${step.eventId}" class="bg-green-600 text-white text-sm font-semibold py-2 px-4 rounded-lg hover:bg-green-700 transition shadow-md">Iniciar</button>
                    </div>
                `;
                scheduleContainer.appendChild(eventEl);
                
                document.getElementById(`timer-btn-${step.eventId}`).addEventListener('click', (e) => {
                    handleTimerClick(e, step, durationMs);
                });
            });
        }
        
        function handleTimerClick(e, event, durationMs) {
            const btn = e.target;
            const timerId = `timer-btn-${event.eventId}`;
            const displayId = `timer-display-${event.eventId}`;

            if (runningTimers[timerId]) { // Stop timer
                clearInterval(runningTimers[timerId].interval);
                delete runningTimers[timerId];
                btn.textContent = 'Iniciar';
                btn.classList.add('bg-green-600', 'hover:bg-green-700');
                btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                document.getElementById(displayId).textContent = '--:--:--';
                document.getElementById(displayId).classList.remove('text-red-600');
                document.getElementById(displayId).classList.add('text-indigo-700');
            } else { // Start timer
                const endTime = Date.now() + durationMs;
                btn.textContent = 'Detener';
                btn.classList.remove('bg-green-600', 'hover:bg-green-700');
                btn.classList.add('bg-red-600', 'hover:bg-red-700');

                const interval = setInterval(() => {
                    const remaining = endTime - Date.now();
                    if (remaining <= 60000) { // Menos de 1 minuto, cambia a rojo
                        document.getElementById(displayId).classList.add('text-red-600');
                        document.getElementById(displayId).classList.remove('text-indigo-700');
                    }
                    if (remaining <= 0) {
                        clearInterval(interval);
                        document.getElementById(displayId).textContent = '00:00:00';
                        const notificationMessage = `¬°Paso finalizado: ${event.name}!`;
                        showToast(notificationMessage);
                        if (Notification.permission === 'granted') {
                            new Notification(notificationMessage);
                        }
                        btn.textContent = 'Finalizado';
                        btn.disabled = true;
                        btn.classList.remove('bg-red-600', 'hover:bg-red-700');
                        btn.classList.add('bg-gray-400');
                    } else {
                        const h = String(Math.floor(remaining / 3600000)).padStart(2, '0');
                        const m = String(Math.floor((remaining % 3600000) / 60000)).padStart(2, '0');
                        const s = String(Math.floor((remaining % 60000) / 1000)).padStart(2, '0');
                        document.getElementById(displayId).textContent = `${h}:${m}:${s}`;
                    }
                }, 1000);
                runningTimers[timerId] = { interval, endTime };
            }
        }
        
        function toggleSubCalc(targetId) {
            const el = document.getElementById(targetId);
            if(el) {
                el.style.display = el.style.display === 'block' ? 'none' : 'block';
            }
        }
        
        // --- UTILITIES ---
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.className = 'toast show fixed bottom-5 right-5 text-white py-4 px-8 rounded-xl shadow-2xl z-50';
            toast.classList.add(type === 'error' ? 'bg-red-600' : 'bg-green-600');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        function populateUnitDropdowns(context = document) {
            const massUnits = Object.keys(CONVERSION_FACTORS.mass);
            const volUnits = Object.keys(CONVERSION_FACTORS.volume);
            const concUnits = Object.keys(CONVERSION_FACTORS.concentration);
            const combinedUnits = [];
            massUnits.forEach(m => volUnits.forEach(v => combinedUnits.push(`${m}/${v}`)));
            const allConcUnits = [...concUnits, ...combinedUnits];

            const ucFrom = context.querySelector('#uc-from');
            if (ucFrom) {  
                const allUnits = [...massUnits, ...volUnits, ...allConcUnits];
                ucFrom.innerHTML = allUnits.map(u => `<option value="${u}">${u}</option>`).join('');
                context.querySelector('#uc-to').innerHTML = allUnits.map(u => `<option value="${u}">${u}</option>`).join('');
                
                document.getElementById('c1-unit').innerHTML = allConcUnits.map(u => `<option value="${u}" ${u==='mM' ? 'selected':''}>${u}</option>`).join('');
                document.getElementById('c2-unit').innerHTML = allConcUnits.map(u => `<option value="${u}" ${u==='¬µM' ? 'selected':''}>${u}</option>`).join('');
                document.getElementById('v1-unit').innerHTML = volUnits.map(u => `<option value="${u}" ${u==='mL' ? 'selected':''}>${u}</option>`).join('');
                document.getElementById('v2-unit').innerHTML = volUnits.map(u => `<option value="${u}" ${u==='¬µL' ? 'selected':''}>${u}</option>`).join('');

            }
            
            const finalConcUnitSelects = context.querySelectorAll('.variable-final-conc-unit');
            const stockConcUnitSelects = context.querySelectorAll('.variable-stock-conc-unit');
            
            finalConcUnitSelects.forEach(select => {
                select.innerHTML = allConcUnits.map(u => `<option value="${u}" ${u==='¬µM' ? 'selected':''}>${u}</option>`).join('');
            });
            stockConcUnitSelects.forEach(select => {
                select.innerHTML = allConcUnits.map(u => `<option value="${u}" ${u==='mM' ? 'selected':''}>${u}</option>`).join('');
            });
        }
        
        // --- SAVE / LOAD ---
        function saveExperiment() {
            const experimentState = {
                experimentName: document.getElementById('exp-name').value,
                plateType: document.getElementById('plate-type').value,
                wellData: wellData,
            };

            const jsonString = JSON.stringify(experimentState, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            const fileName = (experimentState.experimentName || 'experimento').replace(/\s+/g, '_');
            a.download = `${fileName}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast('Experimento guardado exitosamente.');
        }

        function loadExperiment(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedState = JSON.parse(e.target.result);
                    
                    document.getElementById('exp-name').value = loadedState.experimentName || '';
                    wellData = loadedState.wellData || {};
                    generatePlate(loadedState);
                    showToast('Experimento cargado exitosamente.');
                } catch (error) {
                    showToast('Error al cargar el archivo. Aseg√∫rate de que es un archivo de experimento v√°lido.', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = ''; 
        }

        // --- REPORTING ---
        function generateReport() {
            const output = document.getElementById('report-output');
            const expName = document.getElementById('exp-name').value || 'Sin nombre';
            const plateType = document.getElementById('plate-type').value;

            if (Object.keys(wellData).length === 0) {
                output.innerHTML = '<p class="text-red-500">No hay datos de experimento para reportar. Por favor, configura al menos un pozo.</p>';
                document.getElementById('export-csv-btn').style.display = 'none';
                return;
            }

            let html = `<h3>Informaci√≥n General</h3>
                        <ul>
                            <li><strong>Nombre del Experimento:</strong> ${expName}</li>
                            <li><strong>Tipo de Placa:</strong> ${plateType} pozos</li>
                        </ul>`;

            const groupedWells = {};
            for (const wellId in wellData) {
                const configKey = JSON.stringify(wellData[wellId]);
                if (!groupedWells[configKey]) {
                    groupedWells[configKey] = {
                        config: wellData[wellId],
                        wells: []
                    };
                }
                groupedWells[configKey].wells.push(wellId);
            }

            html += `<h3>Configuraci√≥n de Pozos</h3>`;
            Object.values(groupedWells).forEach((group, index) => {
                const config = group.config;
                html += `<div class="p-4 mb-4 border rounded-lg bg-gray-50">
                            <h4><strong>Grupo ${index + 1}:</strong> Pozos ${group.wells.join(', ')}</h4>
                            <ul>
                                <li><strong>Tipo:</strong> ${config.wellType}</li>
                                <li><strong>Volumen Total:</strong> ${config.totalVolume || 'N/A'} ¬µL</li>
                                <li><strong>C√©lulas:</strong> ${config.cells?.count || 'N/A'}</li>
                            </ul>`;
                if (config.variables && config.variables.length > 0) {
                    html += `<h5>Variables:</h5>
                             <table class="min-w-full text-sm">
                                 <thead class="bg-gray-100"><tr><th>Nombre</th><th>Conc. Final</th></tr></thead>
                                 <tbody>`;
                    config.variables.forEach(v => {
                        html += `<tr><td>${v.name}</td><td>${v.finalConc} ${v.finalConcUnit}</td></tr>`;
                    });
                    html += `</tbody></table>`;
                }
                if (config.protocol && config.protocol.steps.length > 0) {
                    html += `<h5>Protocolo:</h5><ul>`;
                    config.protocol.steps.forEach((step, i) => {
                        const unitText = {3600000:'horas', 60000:'minutos', 86400000:'d√≠as'}[step.unit];
                        html += `<li><strong>Paso ${i+1}:</strong> ${step.name} (${step.duration} ${unitText})</li>`;
                    });
                    html += `</ul>`;
                }
                html += `</div>`;
            });
            
            output.innerHTML = html;
            document.getElementById('export-csv-btn').style.display = 'inline-block';
        }

        function exportReportCSV() {
            const expName = document.getElementById('exp-name').value || 'Sin nombre';
            const plateType = document.getElementById('plate-type').value;
            let csvContent = "data:text/csv;charset=utf-8,";
            
            const escapeCSV = (str) => `"${(str || '').toString().replace(/"/g, '""')}"`;

            csvContent += "Secci√≥n,Par√°metro,Valor\n";
            csvContent += `Informaci√≥n General,Nombre del Experimento,${escapeCSV(expName)}\n`;
            csvContent += `Informaci√≥n General,Tipo de Placa,${plateType} pozos\n\n`;

            const headers = ['Pozo', 'Tipo de Pozo', 'Volumen Total (uL)', 'Cantidad de C√©lulas'];
            const allVars = new Set();
            const allSteps = new Set();
            let maxSteps = 0;

            Object.values(wellData).forEach(d => {
                d.variables.forEach(v => allVars.add(v.name));
                if(d.protocol?.steps.length > maxSteps) maxSteps = d.protocol.steps.length;
            });
            const varColumns = Array.from(allVars);
            varColumns.forEach(v => headers.push(`Variable: ${v} (Conc. Final)`));
            for(let i=1; i<= maxSteps; i++) {
                headers.push(`Paso ${i}: Nombre`);
                headers.push(`Paso ${i}: Duraci√≥n`);
            }
            csvContent += headers.join(',') + '\n';
            
            for (const wellId in wellData) {
                const d = wellData[wellId];
                const row = [
                    wellId,
                    d.wellType,
                    d.totalVolume,
                    d.cells?.count
                ];
                varColumns.forEach(varName => {
                    const variable = d.variables.find(v => v.name === varName);
                    row.push(variable ? `${variable.finalConc} ${variable.finalConcUnit}` : '');
                });

                for(let i=0; i< maxSteps; i++) {
                    const step = d.protocol?.steps[i];
                    if (step) {
                        const unitText = {3600000:'horas', 60000:'minutos', 86400000:'d√≠as'}[step.unit];
                        row.push(step.name);
                        row.push(`${step.duration} ${unitText}`);
                    } else {
                        row.push('');
                        row.push('');
                    }
                }
                csvContent += row.map(escapeCSV).join(',') + '\n';
            }
            csvContent += '\n';


            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            const fileName = (expName || 'reporte').replace(/\s+/g, '_');
            link.setAttribute("download", `${fileName}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            generatePlate();
            populateUnitDropdowns();
            if (Notification.permission !== 'granted') {
                Notification.requestPermission();
            }
            changeTab('planner');
            document.getElementById('load-exp-input').addEventListener('change', loadExperiment);
        };
    </script>
</body>
</html>
