<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Evaluación de Carteles - Simposio Médico</title>
    
    <!-- Enlaces y Estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        /* Estilos base de Inter y fondo de la app */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        
        /* Fondo llamativo usando la imagen del simposio (DEBE ESTAR EN assets/) */
        #login-bg { 
            background-image: url('assets/simposio_background.jpg'); 
            background-size: cover;
            background-position: center;
            background-attachment: fixed; /* Hace que el fondo se quede fijo */
            position: relative;
        }
        /* Capa de oscuridad sobre el fondo para mejorar contraste del login */
        #login-bg::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(1, 0, 10, 0.75); 
            backdrop-filter: blur(2px);
        }

        /* Estilos de inputs de evaluación */
        .score-input { width:100%; padding:.5rem; border-radius:.5rem; border:1px solid #d1d5db; text-align:center; font-weight:600; transition:all .2s; }
        .score-input:focus { border-color:#059669; box-shadow:0 0 0 3px rgba(5,150,105,.2); }
        .score-option { background:#f3f4f6; border:2px solid transparent; cursor:pointer; }
        .score-option.selected { background:#d1fae5; border-color:#059669; color:#065f46; }
        .score-input.has-value { border-color:#059669; box-shadow:0 0 0 1px rgba(5,150,105,.5); }
        .password-container { position: relative; }
        .toggle-password { position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; color:#6b7280; transition:color .15s; z-index: 10; }
        .toggle-password:hover { color:#10b981; }
        /* Animación para el botón de login */
        .login-btn-active { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(126, 34, 206, 0.4); }
    </style>

    <!-- Firebase y Lógica de la Aplicación -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, getDocs, onSnapshot, query, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ------------------ CONFIGURA AQUÍ ------------------
        const firebaseConfig = null; // Reemplaza null con tu objeto de configuración de Firebase si usas Firestore
        
        // URL de Google Sheets configurada
        const GOOGLE_SHEETS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzatgCyA9JOC5NGiaVhyWzBG9V69-jzlyPAW03HtI-_pMKd3K5N8zxai1dUuKNcf_s0/exec';
        // ----------------------------------------------------

        // Variables globales
        let app = null;
        let db = null;
        let currentUserId = null;
        let judgeData = null;
        const JUDGE_STORAGE_KEY = 'symposium_judge_data';
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'symposium-app';

        // -----------------------------------------------------
        // 1. USUARIOS PREDEFINIDOS (Mínimo 10 Jueces + Admin)
        // -----------------------------------------------------
        const predefinedUsers = [
            { id: 'juez_a', user: 'juez1', pass: 'simposio2025', name: 'Dr. Héctor Hernández', role: 'judge' },
            { id: 'juez_b', user: 'juez2', pass: 'simposio2025', name: 'Dra. Georgina Álvarez', role: 'judge' },
            { id: 'juez_c', user: 'juez3', pass: 'simposio2025', name: 'Dr. Ricardo Soto', role: 'judge' },
            { id: 'juez_d', user: 'juez4', pass: 'simposio2025', name: 'Dra. Laura Beltrán', role: 'judge' },
            { id: 'juez_e', user: 'juez5', pass: 'simposio2025', name: 'Dr. Miguel Rivas', role: 'judge' },
            { id: 'juez_f', user: 'juez6', pass: 'simposio2025', name: 'Dra. Ana Cortés', role: 'judge' },
            { id: 'juez_g', user: 'juez7', pass: 'simposio2025', name: 'Dr. Javier Ponce', role: 'judge' },
            { id: 'juez_h', user: 'juez8', pass: 'simposio2025', name: 'Dra. Sofía Luna', role: 'judge' },
            { id: 'juez_i', user: 'juez9', pass: 'simposio2025', name: 'Dr. Carlos Vélez', role: 'judge' },
            { id: 'juez_j', user: 'juez10', pass: 'simposio2025', name: 'Dra. Elena Cruz', role: 'judge' },
            { id: 'juez_k', user: 'juez11', pass: 'simposio2025', name: 'Dr. Raúl Pérez', role: 'judge' },
            { id: 'admin', user: 'admin', pass: 'admin2025', name: 'Administrador General', role: 'admin' },
        ];

        // -----------------------------------------------------
        // 2. TRABAJOS DE EJEMPLO (22 trabajos asignados a 11 jueces)
        // -----------------------------------------------------
        const predefinedPosters = [
            { id: 'P001', title: 'Impacto de la Inteligencia Artificial en el Diagnóstico de Retinopatía Diabética', assignedTo: 'juez_a', status: 'Pendiente' },
            { id: 'P002', title: 'Análisis Multicéntrico de Terapias Combinadas en Hipertensión Resistente', assignedTo: 'juez_b', status: 'Pendiente' },
            { id: 'P003', title: 'Correlación entre el Estrés Crónico y Marcadores Inflamatorios', assignedTo: 'juez_c', status: 'Pendiente' },
            { id: 'P004', title: 'Eficacia de la Medicina de Precisión en Cáncer de Próstata', assignedTo: 'juez_d', status: 'Pendiente' },
            { id: 'P005', title: 'Revisión Sistemática sobre el Uso de miRNA como Biomarcadores', assignedTo: 'juez_e', status: 'Pendiente' },
            { id: 'P006', title: 'Manejo Anestésico en Cirugía Cardíaca Pediátrica', assignedTo: 'juez_f', status: 'Pendiente' },
            { id: 'P007', title: 'Nuevos Enfoques para la Rehabilitación Post-Stroke', assignedTo: 'juez_g', status: 'Pendiente' },
            { id: 'P008', title: 'Diagnóstico Molecular de la Tuberculosis Resistente a Fármacos', assignedTo: 'juez_h', status: 'Pendiente' },
            { id: 'P009', title: 'Efecto de la Dieta Mediterránea en el Microbioma Intestinal', assignedTo: 'juez_i', status: 'Pendiente' },
            { id: 'P010', title: 'Terapia Génica para Distrofias Musculares: Avances y Desafíos', assignedTo: 'juez_j', status: 'Pendiente' },
            { id: 'P011', title: 'Aplicación de Realidad Virtual en el Tratamiento del Dolor Crónico', assignedTo: 'juez_j', status: 'Pendiente' }, 
            { id: 'P012', title: 'Estudio Farmacocinético de un Nuevo Antiviral en Pacientes Críticos', assignedTo: 'juez_a', status: 'Pendiente' }, 
            { id: 'P013', title: 'Evaluación del Impacto de la Contaminación Ambiental en la Salud Respiratoria', assignedTo: 'juez_b', status: 'Pendiente' }, 
            { id: 'P014', title: 'Avances en Vacunas de ARN Mensajero contra Patógenos Emergentes', assignedTo: 'juez_c', status: 'Pendiente' }, 
            { id: 'P015', title: 'Uso de Células Madre en la Regeneración de Tejido Hepático Dañado', assignedTo: 'juez_d', status: 'Pendiente' }, 
            { id: 'P016', title: 'Modelos Predictivos de Reingreso Hospitalario Basados en Machine Learning', assignedTo: 'juez_e', status: 'Pendiente' }, 
            { id: 'P017', title: 'Desarrollo de Biosensores para la Detección Temprana de Sepsis', assignedTo: 'juez_f', status: 'Pendiente' }, 
            { id: 'P018', title: 'Impacto de la Telemedicina en la Gestión de Enfermedades Crónicas', assignedTo: 'juez_g', status: 'Pendiente' }, 
            { id: 'P019', title: 'Factores de Riesgo Genéticos Asociados a la Enfermedad de Alzheimer', assignedTo: 'juez_h', status: 'Pendiente' }, 
            { id: 'P020', title: 'Optimización de Protocolos de Trasplante de Médula Ósea', assignedTo: 'juez_i', status: 'Pendiente' }, 
            { id: 'P021', title: 'Análisis de Biomarcadores de Estrés Oxidativo en Neonatos Prematuros', assignedTo: 'juez_k', status: 'Pendiente' }, 
            { id: 'P022', title: 'Estudio de la Resistencia a Insulina en Población Adolescente', assignedTo: 'juez_k', status: 'Pendiente' }, 
        ];

        // Criterios de evaluación (Mantenido igual)
        const evaluationCriteria = [
            { id: 'titulo', category: 'I. Fondo (Contenido Científico)', max: 5, type: '3-point', options: [0,3,5], name: 'Título y Afiliación', desc: 'Claridad y correcta identificación. (0, 3, o 5 puntos)' },
            { id: 'introduccion', category: 'I. Fondo (Contenido Científico)', max: 5, type: '3-point', options: [0,3,5], name: 'Introducción y Antecedentes', desc: 'Contextualización, justificación y uso de referencias. (0,3,5)' },
            { id: 'metodologia', category: 'I. Fondo (Contenido Científico)', max: 10, type: 'full', name: 'Metodología', desc: 'Detalle del diseño, muestra y procedimientos éticos.' },
            { id: 'resultados', category: 'I. Fondo (Contenido Científico)', max: 10, type: 'full', name: 'Resultados', desc: 'Presentación objetiva de datos.' },
            { id: 'conclusiones', category: 'I. Fondo (Contenido Científico)', max: 5, type: '3-point', options: [0,3,5], name: 'Conclusiones', desc: 'Derivadas de los resultados.' },
            { id: 'banner', category: 'II. Forma (Diseño y Formato)', max: 5, type: '3-point', options: [0,3,5], name: 'Banner y Elementos Mandatorios', desc: 'Inclusión de logos y requisitos.' },
            { id: 'diseno', category: 'II. Forma (Diseño y Formato)', max: 10, type: 'full', name: 'Diseño y Congruencia Visual', desc: 'Equilibrio, tipografía legible.' },
            { id: 'graficas', category: 'II. Forma (Diseño y Formato)', max: 10, type: 'full', name: 'Uso de Tablas y Gráficas', desc: 'Claridad y calidad.' },
            { id: 'referencias', category: 'II. Forma (Diseño y Formato)', max: 5, type: '3-point', options: [0,3,5], name: 'Referencias Bibliográficas', desc: 'Cumplimiento con estilo.' },
            { id: 'innovacion', category: 'III. Novedad y Presentación', max: 15, type: 'bonus', name: 'Innovación y Originalidad', desc: 'Aporta nuevo conocimiento. (BONUS)' },
            { id: 'defensa', category: 'III. Novedad y Presentación', max: 10, type: 'full', name: 'Defensa y Síntesis', desc: 'Dominio del tema y claridad.' },
            { id: 'tiempo', category: 'III. Novedad y Presentación', max: 10, type: 'deduction', name: 'Manejo del Tiempo', desc: 'Excedió el tiempo (DEDUCCIÓN).' },
            { id: 'ortografia', category: 'III. Novedad y Presentación', max: 10, type: 'deduction', name: 'Redacción y Ortografía', desc: 'Errores significativos (DEDUCCIÓN).' },
            { id: 'impacto', category: 'III. Novedad y Presentación', max: 5, type: 'full', name: 'Impacto Potencial', desc: 'Trascendencia en práctica clínica.' },
        ];


        // ---------- Utilidades de localStorage ----------
        const saveJudgeDataToLocal = (data) => {
            try { localStorage.setItem(JUDGE_STORAGE_KEY, JSON.stringify(data)); }
            catch(e) { console.error("Error saving judge data:", e); }
        };
        const loadJudgeDataFromLocal = () => {
            try {
                const d = localStorage.getItem(JUDGE_STORAGE_KEY);
                if (!d) return null;
                return JSON.parse(d);
            } catch(e) { console.error("Error loading judge data:", e); return null; }
        };
        const clearJudgeDataLocal = () => {
            try { localStorage.removeItem(JUDGE_STORAGE_KEY); }
            catch(e) { console.error("Error clearing judge data:", e); }
        };
        // -----------------------------------------------

        // Inicializar Firebase (solo si firebaseConfig existe)
        const initFirebase = () => {
            if (!firebaseConfig) {
                console.warn("Firebase config no proporcionado. Firestore no estará disponible hasta configurarlo.");
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                console.log("Firebase inicializado correctamente.");
            } catch (err) {
                console.error("Error inicializando Firebase:", err);
            }
        };

        // ---------------- Manejo de Sesión ----------------
        const mainInit = () => {
            initFirebase();
            judgeData = loadJudgeDataFromLocal();
            if (judgeData && judgeData.id) {
                currentUserId = judgeData.id;
                // Redirigir según el rol
                if (judgeData.role === 'admin') {
                    showAdminDashboard();
                } else {
                    showDashboard(currentUserId);
                }
            } else {
                showLogin();
            }
            setupUIHandlers();
        };

        document.addEventListener('DOMContentLoaded', mainInit);


        // ---------------- Autenticación local (Mantenida) ----------------
        const handleLogin = async () => {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            const loginBtn = document.getElementById('login-btn');
            const errorMsg = document.getElementById('login-error');

            errorMsg.textContent = '';
            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando...';
            loginBtn.classList.add('login-btn-active');

            const userEntry = predefinedUsers.find(u => u.user === user && u.pass === pass);

            if (userEntry) {
                const newJudgeData = {
                    id: userEntry.id,
                    name: userEntry.name,
                    role: userEntry.role,
                    pass: userEntry.pass,
                    lastLogin: new Date().toISOString()
                };
                judgeData = newJudgeData;
                currentUserId = newJudgeData.id;
                saveJudgeDataToLocal(newJudgeData);
                
                // Redirigir según el rol
                if (userEntry.role === 'admin') {
                    showAdminDashboard();
                } else {
                    showDashboard(currentUserId);
                }
                
                loginBtn.textContent = 'Éxito';
            } else {
                errorMsg.textContent = 'Usuario o contraseña incorrectos.';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesión';
                loginBtn.classList.remove('login-btn-active');
            }
        };

        const handleLogout = async () => {
            clearJudgeDataLocal();
            judgeData = null;
            currentUserId = null;
            showLogin();
        };

        const togglePasswordVisibility = () => {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('toggle-password-icon');
            if (!passwordInput) return;
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.innerHTML = '&#128065;'; // ojo
            } else {
                passwordInput.type = 'password';
                toggleIcon.innerHTML = '&#128584;';
            }
        };

        // ---------------- UI: Login & Dashboard ----------------
        const showLogin = () => {
            document.getElementById('app-container').innerHTML = `
                <div id="login-bg" class="min-h-screen flex items-center justify-center p-4">
                    <!-- Contenedor del formulario, posicionado sobre la capa oscura -->
                    <div class="relative z-10 w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border-t-8 border-purple-800 transform transition duration-500 hover:scale-[1.01]">
                        <div class="text-center mb-8">
                            <div class="flex justify-center space-x-4 mb-4">
                                <!-- Logos - Asegúrate que los nombres de archivo coincidan en tu carpeta assets/ -->
                                <img src="assets/logo_ipn.png" alt="Logo IPN" class="h-10 w-auto object-contain">
                                <img src="assets/logo_esm.jpg" alt="Logo ESM" class="h-10 w-10 rounded-full shadow-md object-cover">
                                <img src="assets/logo_licam.png" alt="Logo LICAM" class="h-10 w-auto object-contain">
                            </div>
                            <h1 class="text-3xl font-extrabold text-gray-800">2° Simposio de Investigación</h1>
                            <p class="text-gray-500 font-semibold">Evaluación de Trabajos Libres</p>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Usuario Juez</label>
                                <input type="text" id="username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-600 focus:border-purple-600" value="juez1" placeholder="ej. juez1">
                            </div>
                            <div class="password-container">
                                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                                <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-600 focus:border-purple-600 pr-10" value="simposio2025" placeholder="*******">
                                <span id="toggle-password-icon" class="toggle-password" title="Mostrar contraseña" style="user-select:none;">&#128584;</span>
                            </div>
                            <button id="login-btn" class="w-full bg-purple-800 text-white p-3 rounded-lg font-semibold hover:bg-purple-900 transition duration-150 shadow-md transform hover:login-btn-active">
                                Iniciar Sesión
                            </button>
                            <p id="login-error" class="text-sm text-red-600 text-center mt-2"></p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('toggle-password-icon').addEventListener('click', togglePasswordVisibility);
        };

        const showDashboard = (userId) => {
            if (!judgeData || judgeData.role !== 'judge') return showLogin();

            document.getElementById('app-container').innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
                        <div class="flex justify-between items-center max-w-6xl mx-auto">
                            <h1 class="text-xl font-bold text-purple-800">Panel de Evaluación - Juez</h1>
                            <div class="flex items-center space-x-4">
                                <span class="hidden sm:inline text-sm text-gray-600">Juez: ${judgeData.name} (${judgeData.id})</span>
                                <button id="export-csv-btn" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full hover:bg-blue-700 transition shadow-sm">
                                    Exportar Evaluaciones (CSV)
                                </button>
                                <button id="logout-btn" class="text-sm bg-red-600 text-white px-3 py-1 rounded-full hover:bg-red-700 transition shadow-sm">Salir</button>
                            </div>
                        </div>
                    </header>
                    <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2">Mis Trabajos Asignados</h2>
                        <div id="poster-list" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">Cargando trabajos...</div>
                            <!-- La lista de carteles se carga dinámicamente, filtrada por el ID del juez -->
                        </div>
                    </main>
                </div>
            `;

            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('export-csv-btn').addEventListener('click', exportEvaluationsToCSV);
            loadAssignedPosters(userId);
        };

        // ---------------- ADMIN DASHBOARD ----------------
        const showAdminDashboard = () => {
            if (!judgeData || judgeData.role !== 'admin') return showLogin();
            
            document.getElementById('app-container').innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
                        <div class="flex justify-between items-center max-w-6xl mx-auto">
                            <h1 class="text-xl font-bold text-purple-800">Panel de Administración</h1>
                            <div class="flex items-center space-x-4">
                                <span class="hidden sm:inline text-sm text-gray-600">Admin: ${judgeData.name} (${judgeData.id})</span>
                                <button id="admin-export-all-btn" class="text-xs bg-blue-600 text-white px-3 py-1 rounded-full hover:bg-blue-700 transition shadow-sm">
                                    Exportar TODAS las Evaluaciones (CSV)
                                </button>
                                <button id="logout-btn" class="text-sm bg-red-600 text-white px-3 py-1 rounded-full hover:bg-red-700 transition shadow-sm">Salir</button>
                            </div>
                        </div>
                    </header>
                    <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6 border-b pb-2">Resumen de Progreso de Evaluación</h2>
                        <div id="admin-summary" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-purple-500">
                                <p class="text-sm font-medium text-gray-500">Total de Trabajos</p>
                                <p id="total-posters" class="text-3xl font-bold text-gray-800 animate-pulse">...</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-green-500">
                                <p class="text-sm font-medium text-gray-500">Evaluaciones Completadas</p>
                                <p id="completed-evals" class="text-3xl font-bold text-green-600 animate-pulse">...</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-lg border-l-4 border-yellow-500">
                                <p class="text-sm font-medium text-gray-500">Promedio de Jueces/Trabajo</p>
                                <p id="avg-judgments" class="text-3xl font-bold text-yellow-600 animate-pulse">...</p>
                            </div>
                        </div>

                        <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Estado Detallado de los Jueces</h3>
                        <div id="judge-status-list" class="space-y-4">
                            <div class="text-center py-8 text-gray-500">Cargando datos de jueces...</div>
                        </div>
                    </main>
                </div>
            `;
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('admin-export-all-btn').addEventListener('click', exportAllEvaluationsToCSV);
            loadAdminData();
        };
        
        // ---------------- LÓGICA DEL ADMIN DASHBOARD ----------------
        const loadAdminData = async () => {
            const judgeStatusList = document.getElementById('judge-status-list');
            
            if (!db || typeof collection !== 'function') {
                judgeStatusList.innerHTML = '<div class="text-center py-8 text-red-600">Error: Firestore no está configurado para cargar datos administrativos.</div>';
                document.getElementById('total-posters').textContent = predefinedPosters.length;
                document.getElementById('completed-evals').textContent = 'N/A';
                document.getElementById('avg-judgments').textContent = 'N/A';
                return;
            }
            
            // Mapeo de trabajos asignados por Juez
            const assignments = {};
            predefinedPosters.forEach(poster => {
                if (!assignments[poster.assignedTo]) {
                    assignments[poster.assignedTo] = { assigned: 0, completed: 0, judgeName: predefinedUsers.find(u => u.id === poster.assignedTo)?.name || poster.assignedTo, id: poster.assignedTo };
                }
                assignments[poster.assignedTo].assigned++;
            });
            
            const judgesToTrack = predefinedUsers.filter(u => u.role === 'judge');
            let totalCompletedEvals = 0;
            const allEvaluations = [];

            // Obtener el estado de cada juez (asincrónicamente)
            const judgePromises = judgesToTrack.map(async (judge) => {
                const judgeAssignment = assignments[judge.id] || { assigned: 0, completed: 0, judgeName: judge.name, id: judge.id };
                
                // Intentar leer las evaluaciones guardadas por el juez
                try {
                    const evalsColRef = collection(db, `artifacts/${appId}/users/${judge.id}/evaluations`);
                    const querySnapshot = await getDocs(evalsColRef);
                    
                    judgeAssignment.completed = querySnapshot.size;
                    totalCompletedEvals += querySnapshot.size;

                    querySnapshot.forEach(docSnap => allEvaluations.push(docSnap.data()));

                } catch (error) {
                    console.error(`Error fetching evals for ${judge.id}:`, error);
                    judgeAssignment.error = true;
                }
                return judgeAssignment;
            });

            const results = await Promise.all(judgePromises);
            
            // Renderizar resumen
            document.getElementById('total-posters').textContent = predefinedPosters.length;
            document.getElementById('completed-evals').textContent = totalCompletedEvals;
            document.getElementById('avg-judgments').textContent = (totalCompletedEvals / predefinedPosters.length).toFixed(2);
            
            // Renderizar la lista de jueces
            judgeStatusList.innerHTML = results.map(judge => {
                const percentage = judge.assigned > 0 ? ((judge.completed / judge.assigned) * 100).toFixed(0) : 100;
                const progressColor = percentage == 100 ? 'bg-green-500' : (percentage > 0 ? 'bg-yellow-500' : 'bg-red-500');
                
                return `
                    <div class="bg-white p-4 rounded-lg shadow-md flex items-center justify-between">
                        <div class="flex flex-col">
                            <p class="font-bold text-gray-700">${judge.judgeName} (${judge.id})</p>
                            ${judge.error ? '<p class="text-xs text-red-500">Error al cargar evaluaciones</p>' : ''}
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="text-sm font-semibold text-gray-600">${judge.completed} / ${judge.assigned} completados</div>
                            <div class="w-24 bg-gray-200 rounded-full h-2.5">
                                <div class="h-2.5 rounded-full ${progressColor} transition-all duration-500" style="width: ${percentage}%;"></div>
                            </div>
                            <span class="text-sm font-bold text-purple-700">${percentage}%</span>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Guardar todas las evaluaciones para la exportación del Admin (opcional, si es necesario exportar todo)
            window.allEvaluationsData = allEvaluations; 
        };

        // ---------------- CARGAR TRABAJOS ASIGNADOS (Juez) ----------------
        const loadAssignedPosters = (judgeId) => {
            const listContainer = document.getElementById('poster-list');
            const staticJudgeId = judgeData?.id;

            if (!staticJudgeId) {
                listContainer.innerHTML = '<div class="text-center py-8 text-red-500">Error: No se encontró la ID de asignación del juez.</div>';
                return;
            }

            // Filtro CRUCIAL: Solo muestra los trabajos donde assignedTo coincide con el ID del juez
            const assignedPosters = predefinedPosters.filter(p => p.assignedTo === staticJudgeId);
            
            if (assignedPosters.length === 0) {
                listContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No tiene trabajos asignados para evaluar.</div>';
                return;
            }
            
            listContainer.innerHTML = ''; // Limpiar el mensaje de "Cargando"

            assignedPosters.forEach(poster => {
                const docRef = (db && typeof doc === 'function') ? doc(db, `artifacts/${appId}/users/${staticJudgeId}/evaluations`, poster.id) : null;

                if (docRef && typeof onSnapshot === 'function') {
                    // Usar onSnapshot para ver cambios en tiempo real si el juez modifica y vuelve al panel
                    onSnapshot(docRef, (docSnap) => {
                        const evaluationData = docSnap.exists() ? docSnap.data() : null;
                        renderOrUpdatePosterCard(poster, evaluationData);
                    }, (error) => {
                        console.warn(`Error fetching evaluation for poster ${poster.id}:`, error);
                        renderOrUpdatePosterCard(poster, null, true);
                    });
                } else {
                    renderOrUpdatePosterCard(poster, null); // Firestore no configurado
                }
            });
        };

        const renderOrUpdatePosterCard = (poster, evaluationData, hasError=false) => {
            const listContainer = document.getElementById('poster-list');
            if (!listContainer) return;

            const totalScore = evaluationData?.totalScore !== undefined ? evaluationData.totalScore : 'N/A';
            const isEvaluated = !!evaluationData && totalScore !== 'N/A';
            const statusText = isEvaluated ? 'Ver Evaluación' : (hasError ? 'Error' : 'Evaluar');
            const scoreColor = isEvaluated ? 'bg-green-600 text-white' : 'bg-yellow-500 text-gray-800'; // Color ajustado para ser más dinámico

            let card = document.getElementById(`poster-card-${poster.id}`);
            if (!card) {
                const newCardHTML = `
                    <div id="poster-card-${poster.id}" class="bg-white p-5 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-start sm:items-center transform transition duration-200 hover:shadow-xl hover:scale-[1.01] cursor-pointer ${isEvaluated ? 'border-l-4 border-green-600' : 'border-l-4 border-purple-400'}">
                        <div>
                            <p class="text-sm font-medium text-gray-500">${poster.id}</p>
                            <h3 class="text-lg font-semibold text-gray-800">${poster.title}</h3>
                        </div>
                        <div class="mt-3 sm:mt-0 flex items-center space-x-4">
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${scoreColor}">
                                Puntaje: ${totalScore} / 100
                            </span>
                            <button class="evaluate-btn text-white px-4 py-2 rounded-full font-medium transition ${isEvaluated ? 'bg-green-600 hover:bg-green-700' : 'bg-purple-600 hover:bg-purple-700'}"
                                    data-poster-id="${poster.id}" 
                                    data-poster-title="${poster.title}" 
                                    data-evaluation='${JSON.stringify(evaluationData || {})}'
                                    data-is-evaluated="${isEvaluated}">
                                ${statusText}
                            </button>
                        </div>
                    </div>
                `;
                listContainer.insertAdjacentHTML('beforeend', newCardHTML);
            } else {
                // Actualizar la tarjeta existente
                card.className = `bg-white p-5 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-start sm:items-center transform transition duration-200 hover:shadow-xl hover:scale-[1.01] cursor-pointer ${isEvaluated ? 'border-l-4 border-green-600' : 'border-l-4 border-purple-400'}`;
                const span = card.querySelector('span');
                if (span) {
                    span.className = `px-3 py-1 text-xs font-medium rounded-full ${scoreColor}`;
                    span.textContent = `Puntaje: ${totalScore} / 100`;
                }
                const btn = card.querySelector('.evaluate-btn');
                if (btn) {
                    btn.textContent = statusText;
                    btn.dataset.evaluation = JSON.stringify(evaluationData || {});
                    btn.dataset.isEvaluated = isEvaluated;
                    if (isEvaluated) {
                        btn.classList.replace('bg-purple-600','bg-green-600');
                        btn.classList.replace('hover:bg-purple-700','hover:bg-green-700');
                    } else {
                        btn.classList.replace('bg-green-600','bg-purple-600');
                        btn.classList.replace('hover:bg-green-700','hover:bg-purple-700');
                    }
                }
            }

            // reasignar manejadores
            document.querySelectorAll('.evaluate-btn').forEach(btn => {
                btn.removeEventListener('click', handleEvaluateClick);
                btn.addEventListener('click', handleEvaluateClick);
            });
        };

        // ---------------- Lógica de Evaluación se mantiene igual ----------------
        const handleEvaluateClick = (event) => {
            const posterId = event.currentTarget.dataset.posterId;
            const posterTitle = event.currentTarget.dataset.posterTitle;
            const evaluationData = JSON.parse(event.currentTarget.dataset.evaluation || '{}');
            const isEvaluated = event.currentTarget.dataset.isEvaluated === 'true';

            showEvaluationForm(posterId, posterTitle, evaluationData, isEvaluated);
        };

        const handleInputVisualFeedback = (event) => {
            const input = event.target;
            const name = input.name;
            const isRadio = input.type === 'radio';
            const isNumber = input.type === 'number';

            if (isRadio) {
                document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
                    const label = document.querySelector(`label[for="${radio.id}"]`);
                    if (label) label.classList.remove('selected');
                });
            } else if (isNumber) {
                input.classList.remove('has-value');
            }

            if (isRadio && input.checked) {
                const label = document.querySelector(`label[for="${input.id}"]`);
                if (label) label.classList.add('selected');
            } else if (isNumber) {
                const value = parseInt(input.value);
                if (!isNaN(value) && value >= 0 && value <= parseInt(input.max)) {
                    input.classList.add('has-value');
                }
            }
            
            calculateScore();
        };

        const showEvaluationForm = (posterId, title, evaluation = {}, isEvaluated = false) => {
            const formContainer = document.getElementById('app-container');
            const categoryHeaders = evaluationCriteria.reduce((acc,curr)=> { if(!acc.includes(curr.category)) acc.push(curr.category); return acc; }, []);
            const saveButtonText = isEvaluated ? 'Modificar Evaluación' : 'Guardar Evaluación';

            let formHTML = `
                <div class="min-h-screen bg-gray-50 p-4 sm:p-6 lg:p-8">
                    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
                        <header class="mb-6 border-b pb-4">
                            <button id="back-to-dashboard" class="text-purple-600 hover:text-purple-800 flex items-center mb-4 text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                                Volver al Panel
                            </button>
                            <h2 class="text-2xl font-bold text-gray-800">${title}</h2>
                            <p class="text-md text-gray-500">ID del Cartel: ${posterId}</p>
                            ${isEvaluated ? '<p class="text-sm text-green-600 font-semibold mt-1">Esta evaluación ya ha sido guardada.</p>' : ''}
                        </header>

                        <form id="evaluation-form" data-poster-id="${posterId}">
                            <div id="criteria-list" class="space-y-6">
                                ${categoryHeaders.map(category => `
                                    <div class="border-t pt-4">
                                        <h3 class="text-xl font-semibold text-purple-700 mb-4">${category}</h3>
                                        ${evaluationCriteria.filter(c => c.category === category).map(c => {
                                            const savedScore = evaluation.scores?.[c.id] !== undefined ? evaluation.scores[c.id] : '';
                                            const maxScoreText = c.type === 'deduction' ? `DEDUCCIÓN (Máx: ${c.max})` : (c.type === 'bonus' ? `BONUS (Máx: ${c.max})` : `Máx: ${c.max}`);
                                            const isMarked = savedScore !== '';

                                            let inputField = '';
                                            if (c.type === '3-point' && c.options) {
                                                inputField = `
                                                    <div class="grid grid-cols-3 gap-2">
                                                        ${c.options.map(option => {
                                                            const isChecked = savedScore == option;
                                                            return `
                                                            <div class="col-span-1">
                                                                <input type="radio" id="${c.id}-score-${option}" name="${c.id}" value="${option}" class="hidden peer" ${isChecked ? 'checked' : ''} data-max="${c.max}" data-type="${c.type}" required />
                                                                <label for="${c.id}-score-${option}" class="score-option block p-3 text-center rounded-lg font-bold text-gray-700 hover:bg-purple-50 peer-checked:selected transition duration-150 ${isChecked ? 'selected' : ''}">
                                                                    ${option} Pts
                                                                </label>
                                                            </div>
                                                            `;
                                                        }).join('')}
                                                    </div>
                                                `;
                                            } else {
                                                inputField = `
                                                    <input type="number" id="${c.id}-score" name="${c.id}" class="score-input ${c.type === 'deduction' ? 'border-red-400 text-red-700' : 'border-purple-400 text-purple-700'} ${isMarked ? 'has-value' : ''}" 
                                                        min="0" max="${c.max}" value="${savedScore}" data-max="${c.max}" data-type="${c.type}" required />
                                                `;
                                            }

                                            return `
                                                <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
                                                    <div class="flex justify-between items-center mb-2">
                                                        <h4 class="text-lg font-medium text-gray-700">${c.name}</h4>
                                                        <span class="text-sm font-semibold ${c.type === 'deduction' ? 'text-red-600' : (c.type === 'bonus' ? 'text-blue-600' : 'text-purple-600')}">${maxScoreText}</span>
                                                    </div>
                                                    <p class="text-xs text-gray-500 mb-3">${c.desc}</p>
                                                    ${inputField}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `).join('')}
                            </div>

                            <div class="mt-8 pt-6 border-t border-gray-200">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Puntuación Total: <span id="total-score" class="text-3xl text-purple-600">${evaluation.totalScore || '0'}</span> / 100</h3>
                                <div class="bg-purple-50 p-4 rounded-lg text-sm text-purple-800 mb-6">
                                    <p>La **Puntuación Total** se calcula automáticamente (Máximo Base: **100 puntos**):</p>
                                    <ul class="list-disc list-inside mt-2">
                                        <li>Criterios Positivos (Fondo, Forma, Defensa, Impacto): Suman al total.</li>
                                        <li>Innovación: Se agrega como **BONUS**.</li>
                                        <li>Tiempo y Ortografía: Se aplican como **DEDUCCIÓN** (se restan).</li>
                                    </ul>
                                </div>
                                <label for="observations" class="block text-md font-medium text-gray-700 mb-2">Observaciones y Comentarios Adicionales (Opcional)</label>
                                <textarea id="observations" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">${evaluation.observations || ''}</textarea>

                                <button type="submit" id="save-evaluation-btn" class="mt-6 w-full bg-green-600 text-white p-4 rounded-lg font-semibold text-lg hover:bg-green-700 transition duration-150 shadow-lg transform hover:scale-[1.01]">
                                    ${saveButtonText}
                                </button>
                                <p id="save-status" class="text-center mt-3 text-sm font-medium"></p>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            formContainer.innerHTML = formHTML;
            setupFormHandlers(posterId);

            document.querySelectorAll('#criteria-list input').forEach(input => {
                if (input.type === 'radio' && input.checked) {
                    const label = document.querySelector(`label[for="${input.id}"]`);
                    if (label) label.classList.add('selected');
                }
                if (input.type === 'number' && input.value !== "") {
                    input.classList.add('has-value');
                }
            });
        };

        const calculateScore = () => {
            const form = document.getElementById('evaluation-form');
            if (!form) return 0;
            let totalScore = 0;
            const currentScores = {};

            evaluationCriteria.forEach(c => {
                const criteriaId = c.id;
                let score = 0;
                let inputElement;

                if (c.type === '3-point') {
                    const checkedRadio = document.querySelector(`input[name="${criteriaId}"]:checked`);
                    if (checkedRadio) {
                        score = parseInt(checkedRadio.value) || 0;
                        inputElement = checkedRadio;
                    }
                } else {
                    const numberInput = document.getElementById(`${criteriaId}-score`);
                    if (numberInput) {
                        score = parseInt(numberInput.value) || 0;
                        inputElement = numberInput;
                    }
                }
                
                if (inputElement) {
                    currentScores[criteriaId] = { score, criteriaType: c.type, input: inputElement };
                }
            });

            for (const criteriaId in currentScores) {
                const { score, criteriaType, input } = currentScores[criteriaId];
                
                if (criteriaType === 'deduction') {
                    const maxDeduction = parseInt(input.dataset.max) || 0;
                    totalScore -= Math.min(score, maxDeduction);
                } else {
                    const max = parseInt(input.dataset.max) || 0;
                    totalScore += Math.min(score, max);
                }
            }

            document.getElementById('total-score').textContent = totalScore;
            return totalScore;
        };

        // ENVIAR A GOOGLE SHEETS
        const sendDataToGoogleSheets = async (evaluationData) => {
            if (!GOOGLE_SHEETS_WEB_APP_URL || GOOGLE_SHEETS_WEB_APP_URL.includes('YOUR_WEB_APP_ID')) {
                console.warn("URL de Google Sheets no configurada.");
                return;
            }
            try {
                const payload = {
                    ...evaluationData,
                    staticJudgeId: evaluationData.judgeId, 
                };
                delete payload.judgeId; 

                await fetch(GOOGLE_SHEETS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                });
            } catch (error) {
                console.error("Error enviando a Google Sheets:", error);
            }
        };

        const saveEvaluation = async (event) => {
            event.preventDefault();
            const posterId = document.getElementById('evaluation-form').dataset.posterId;
            const saveBtn = document.getElementById('save-evaluation-btn');
            const statusMsg = document.getElementById('save-status');

            if (!judgeData || !judgeData.id) {
                statusMsg.textContent = 'Error: No se ha detectado el usuario juez. Inicia sesión nuevamente.';
                statusMsg.className = 'text-center mt-3 text-sm font-medium text-red-600';
                return;
            }

            const scores = {};
            evaluationCriteria.forEach(c => {
                const criteriaId = c.id;
                if (c.type === '3-point') {
                    const checkedRadio = document.querySelector(`input[name="${criteriaId}"]:checked`);
                    if (checkedRadio) scores[criteriaId] = parseInt(checkedRadio.value);
                } else {
                    const numberInput = document.getElementById(`${criteriaId}-score`);
                    if (numberInput) scores[criteriaId] = parseInt(numberInput.value) || 0;
                }
            });

            const totalScore = calculateScore();
            const observations = document.getElementById('observations').value.trim();

            const evaluationData = {
                judgeId: judgeData.id,
                judgeName: judgeData.name,
                posterId: posterId,
                posterTitle: (predefinedPosters.find(p=>p.id===posterId)?.title) || 'Título Desconocido',
                totalScore,
                scores,
                observations,
                timestamp: new Date().toISOString()
            };

            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            statusMsg.textContent = '';

            try {
                // 1. Guardar en Firestore (si está configurado)
                if (db && typeof setDoc === 'function') {
                    const docRef = doc(db, `artifacts/${appId}/users/${judgeData.id}/evaluations`, posterId);
                    await setDoc(docRef, evaluationData);
                } else {
                    console.warn("Firestore no inicializado. La evaluación NO se guardará en la nube de Firebase.");
                }

                // 2. Enviar a Google Sheets
                await sendDataToGoogleSheets(evaluationData); 

                statusMsg.textContent = 'Evaluación guardada y enviada exitosamente.';
                statusMsg.className = 'text-center mt-3 text-sm font-medium text-green-600';
                saveBtn.textContent = 'Guardado';

                setTimeout(()=> showDashboard(judgeData.id), 1200);
            } catch (error) {
                console.error("Error guardando evaluación:", error);
                statusMsg.textContent = 'Error al guardar la evaluación. Reintente.';
                statusMsg.className = 'text-center mt-3 text-sm font-medium text-red-600';
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Evaluación';
            }
        };

        const setupFormHandlers = (posterId) => {
            const backBtn = document.getElementById('back-to-dashboard');
            // Redirige al panel correcto basado en el rol del juez, aunque solo los jueces llegan aquí
            if (backBtn) backBtn.addEventListener('click', ()=> judgeData.role === 'admin' ? showAdminDashboard() : showDashboard(judgeData.id));
            
            document.querySelectorAll('#criteria-list input').forEach(input => {
                input.addEventListener('input', handleInputVisualFeedback);
                input.addEventListener('change', handleInputVisualFeedback);
            });
            
            const form = document.getElementById('evaluation-form');
            if (form) form.addEventListener('submit', saveEvaluation);
            calculateScore(); 
        };
        
        // ---------------- EXPORTACIÓN CSV ADMIN ----------------
        const exportAllEvaluationsToCSV = async () => {
             if (!judgeData || judgeData.role !== 'admin') { 
                alert('Solo el Administrador puede realizar esta exportación.'); 
                return; 
             }
             if (!db || typeof collection !== 'function') {
                alert('Firestore no configurado. No se pueden exportar los datos.');
                return;
             }
             
            const exportBtn = document.getElementById('admin-export-all-btn');
            exportBtn.disabled = true; exportBtn.textContent = 'Recolectando datos...';

            const criteriaMapping = evaluationCriteria.map(c => ({ 
                id: c.id, 
                name: c.name.replace(/\s/g, '_').replace(/[\(\)]/g, '').replace(/\./g, '') 
            }));

            let csvContent = "data:text/csv;charset=utf-8,";
            let headers = ['Judge_ID','Judge_Name','Poster_ID','Poster_Title','Total_Score','Observations', 'Timestamp', ...criteriaMapping.map(c=>c.name)];
            csvContent += headers.join(',') + '\r\n';

            try {
                const allEvals = [];
                const judgeIds = predefinedUsers.filter(u => u.role === 'judge').map(u => u.id);

                // Recorrer las colecciones de evaluaciones de cada juez
                for (const judgeId of judgeIds) {
                    const evalsColRef = collection(db, `artifacts/${appId}/users/${judgeId}/evaluations`);
                    const querySnapshot = await getDocs(evalsColRef);
                    querySnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        allEvals.push(data);
                    });
                }
                
                allEvals.forEach(data => {
                    const poster = predefinedPosters.find(p => p.id === data.posterId);
                    const posterTitle = poster ? poster.title.replace(/,/g,'') : 'Unknown Title';
                    
                    let row = [
                        data.judgeId,
                        `"${data.judgeName.replace(/"/g,'""')}"`,
                        data.posterId,
                        `"${posterTitle}"`,
                        data.totalScore,
                        `"${(data.observations||'').replace(/"/g,'""').replace(/(\r\n|\n|\r)/gm,' ')}"`,
                        data.timestamp
                    ];
                    criteriaMapping.forEach(c => { row.push(data.scores?.[c.id] || 0); });
                    csvContent += row.join(',') + '\r\n';
                });

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `evaluaciones_ADMIN_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                exportBtn.textContent = 'Exportación Exitosa';
                exportBtn.classList.replace('bg-blue-600','bg-green-600');
                setTimeout(()=>{ exportBtn.disabled=false; exportBtn.textContent='Exportar TODAS las Evaluaciones (CSV)'; exportBtn.classList.replace('bg-green-600','bg-blue-600'); }, 3000);

            } catch (error) {
                console.error("Error al exportar CSV:", error);
                alert('Error al exportar todas las evaluaciones. Revise la consola.');
                exportBtn.disabled=false; exportBtn.textContent='Exportar TODAS las Evaluaciones (CSV)';
                exportBtn.classList.replace('bg-green-600','bg-blue-600');
            }
        };

        // ---------------- EXPORTACIÓN CSV JUEZ ----------------
        const exportEvaluationsToCSV = async () => {
            if (!judgeData || !judgeData.id) { alert('Debe iniciar sesión para exportar datos.'); return; }
            const exportBtn = document.getElementById('export-csv-btn');
            exportBtn.disabled = true; exportBtn.textContent = 'Generando CSV...';

            const criteriaMapping = evaluationCriteria.map(c => ({ 
                id: c.id, 
                name: c.name.replace(/\s/g, '_').replace(/[\(\)]/g, '').replace(/\./g, '') 
            }));

            let csvContent = "data:text/csv;charset=utf-8,";
            let headers = ['Judge_ID','Judge_Name','Poster_ID','Poster_Title','Total_Score','Observations', 'Timestamp', ...criteriaMapping.map(c=>c.name)];
            csvContent += headers.join(',') + '\r\n';

            try {
                if (db && typeof collection === 'function' && typeof getDocs === 'function') {
                    const evaluationsColRef = collection(db, `artifacts/${appId}/users/${judgeData.id}/evaluations`);
                    const querySnapshot = await getDocs(evaluationsColRef);
                    querySnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        const poster = predefinedPosters.find(p => p.id === data.posterId);
                        const posterTitle = poster ? poster.title.replace(/,/g,'') : 'Unknown Title';
                        let row = [
                            data.judgeId,
                            `"${data.judgeName.replace(/"/g,'""')}"`,
                            data.posterId,
                            `"${posterTitle}"`,
                            data.totalScore,
                            `"${(data.observations||'').replace(/"/g,'""').replace(/(\r\n|\n|\r)/gm,' ')}"`,
                            data.timestamp
                        ];
                        criteriaMapping.forEach(c => { row.push(data.scores?.[c.id] || 0); });
                        csvContent += row.join(',') + '\r\n';
                    });
                } else {
                    alert('Firestore no configurado: la exportación solo funcionará si los datos están en la nube.');
                    exportBtn.disabled=false; exportBtn.textContent='Exportar Evaluaciones (CSV)';
                    return;
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `evaluaciones_${judgeData.id}_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                exportBtn.textContent = 'Exportación Exitosa';
                exportBtn.classList.replace('bg-blue-600','bg-green-600');
                setTimeout(()=>{ exportBtn.disabled=false; exportBtn.textContent='Exportar Evaluaciones (CSV)'; exportBtn.classList.replace('bg-green-600','bg-blue-600'); }, 3000);
            } catch (error) {
                console.error("Error al exportar CSV:", error);
                alert('Error al exportar las evaluaciones.');
                exportBtn.disabled=false; exportBtn.textContent='Exportar Evaluaciones (CSV)';
            }
        };

        const setupUIHandlers = () => {};
        
    </script>
</head>
<body class="bg-gray-50">
    <div id="app-container" class="min-h-screen">
        <!-- Esqueleto de Carga Inicial -->
        <div class="flex justify-center items-center h-screen">
            <div class="text-xl text-gray-500 animate-pulse">Cargando Sistema de Evaluación...</div>
        </div>
    </div>
</body>
</html>
