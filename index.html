<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Evaluación de Carteles - Simposio Médico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .score-input { width:100%; padding:.5rem; border-radius:.5rem; border:1px solid #d1d5db; text-align:center; font-weight:600; transition:all .2s; }
        .score-input:focus { border-color:#059669; box-shadow:0 0 0 3px rgba(5,150,105,.2); }
        .score-option { background:#f3f4f6; border:2px solid transparent; cursor:pointer; }
        .score-option.selected { background:#d1fae5; border-color:#059669; color:#065f46; }
        .score-input.has-value { border-color:#059669; box-shadow:0 0 0 1px rgba(5,150,105,.5); }
        .password-container { position: relative; }
        .toggle-password { position:absolute; right:12px; top:50%; transform:translateY(-50%); cursor:pointer; color:#6b7280; transition:color .15s; }
        .toggle-password:hover { color:#10b981; }
    </style>

    <!-- Firebase: app + firestore -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, collection, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ------------------ CONFIGURA AQUÍ ------------------
        // Reemplaza null con tu objeto firebaseConfig si ya lo tienes.
        // EJEMPLO:
        // const firebaseConfig = {
        //   apiKey: "...",
        //   authDomain: "...",
        //   projectId: "...",
        //   storageBucket: "...",
        //   messagingSenderId: "...",
        //   appId: "..."
        // };
        const firebaseConfig = null;
        // ----------------------------------------------------

        // Variables globales
        let app = null;
        let db = null;
        let currentUserId = null;   // ahora usamos el ID del juez (p.ej. 'juez_a')
        let judgeData = null;
        const JUDGE_STORAGE_KEY = 'symposium_judge_data';
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'symposium-app';

        // Google Sheets web app URL (opcional)
        const GOOGLE_SHEETS_WEB_APP_URL = 'https://script.google.com/macros/s/YOUR_WEB_APP_ID/exec';

        // Usuarios predefinidos (tú defines nombres y contraseñas)
        const predefinedUsers = [
            { id: 'juez_a', user: 'juez1', pass: 'simposio2025', name: 'Dr. Héctor Hernández', role: 'judge' },
            { id: 'juez_b', user: 'juez2', pass: 'simposio2025', name: 'Dra. Georgina Álvarez', role: 'judge' },
            { id: 'admin',  user: 'admin',  pass: 'admin2025',     name: 'Administrador', role: 'admin' },
        ];

        // Trabajos de ejemplo
        const predefinedPosters = [
            { id: 'P001', title: 'Impacto de la Inteligencia Artificial en el Diagnóstico de Retinopatía Diabética', assignedTo: 'juez_a', status: 'Pendiente' },
            { id: 'P002', title: 'Análisis Multicéntrico de Terapias Combinadas en Hipertensión Resistente', assignedTo: 'juez_b', status: 'Pendiente' },
            { id: 'P003', title: 'Correlación entre el Estrés Crónico y Marcadores Inflamatorios en Estudiantes de Medicina', assignedTo: 'juez_a', status: 'Pendiente' },
            { id: 'P004', title: 'Eficacia de la Medicina de Precisión en Cáncer de Próstata', assignedTo: 'juez_b', status: 'Pendiente' },
            { id: 'P005', title: 'Revisión Sistemática sobre el Uso de miRNA como Biomarcadores', assignedTo: 'juez_a', status: 'Pendiente' },
        ];

        // ---------- Utilidades de localStorage ----------
        const saveJudgeDataToLocal = (data) => {
            try { localStorage.setItem(JUDGE_STORAGE_KEY, JSON.stringify(data)); }
            catch(e) { console.error("Error saving judge data:", e); }
        };
        const loadJudgeDataFromLocal = () => {
            try {
                const d = localStorage.getItem(JUDGE_STORAGE_KEY);
                if (!d) return null;
                return JSON.parse(d);
            } catch(e) { console.error("Error loading judge data:", e); return null; }
        };
        const clearJudgeDataLocal = () => {
            try { localStorage.removeItem(JUDGE_STORAGE_KEY); }
            catch(e) { console.error("Error clearing judge data:", e); }
        };
        // -----------------------------------------------

        // Inicializar Firebase (solo si firebaseConfig existe)
        const initFirebase = () => {
            if (!firebaseConfig) {
                console.warn("Firebase config no proporcionado. Firestore no estará disponible hasta configurarlo.");
                return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                console.log("Firebase inicializado correctamente.");
            } catch (err) {
                console.error("Error inicializando Firebase:", err);
            }
        };

        // Al cargar la página: usar sesión local si existe
        window.onload = () => {
            initFirebase();
            judgeData = loadJudgeDataFromLocal();
            if (judgeData && judgeData.id) {
                currentUserId = judgeData.id;
                showDashboard(currentUserId);
            } else {
                showLogin();
            }
            setupUIHandlers();
        };

        // ---------------- Autenticación local ----------------
        const handleLogin = async () => {
            const user = document.getElementById('username').value.trim();
            const pass = document.getElementById('password').value.trim();
            const loginBtn = document.getElementById('login-btn');
            const errorMsg = document.getElementById('login-error');

            errorMsg.textContent = '';
            loginBtn.disabled = true;
            loginBtn.textContent = 'Iniciando...';

            const userEntry = predefinedUsers.find(u => u.user === user && u.pass === pass);

            if (userEntry) {
                // No usamos Firebase Auth: la "sesión" es local
                const newJudgeData = {
                    id: userEntry.id,
                    name: userEntry.name,
                    role: userEntry.role,
                    pass: userEntry.pass,
                    lastLogin: new Date().toISOString()
                };
                judgeData = newJudgeData;
                currentUserId = newJudgeData.id;
                saveJudgeDataToLocal(newJudgeData);
                showDashboard(currentUserId);
                loginBtn.textContent = 'Éxito';
            } else {
                errorMsg.textContent = 'Usuario o contraseña incorrectos.';
                loginBtn.disabled = false;
                loginBtn.textContent = 'Iniciar Sesión';
            }
        };

        const handleLogout = async () => {
            clearJudgeDataLocal();
            judgeData = null;
            currentUserId = null;
            showLogin();
        };

        const togglePasswordVisibility = () => {
            const passwordInput = document.getElementById('password');
            const toggleIcon = document.getElementById('toggle-password-icon');
            if (!passwordInput) return;
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.innerHTML = '&#128065;'; // ojo
            } else {
                passwordInput.type = 'password';
                toggleIcon.innerHTML = '&#128584;';
            }
        };

        // ---------------- UI: Login & Dashboard ----------------
        const showLogin = () => {
            document.getElementById('app-container').innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4 bg-gray-100">
                    <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-2xl border-t-8 border-green-600">
                        <div class="text-center mb-6">
                            <div class="flex justify-center space-x-3 mb-4">
                                <img src="https://placehold.co/40x40/004080/FFFFFF/png?text=IPN" onerror="this.style.display='none'" alt="Logo IPN" class="rounded-full shadow-md">
                                <img src="https://placehold.co/40x40/00A39C/FFFFFF/png?text=ESM" onerror="this.style.display='none'" alt="Logo ESM" class="rounded-full shadow-md">
                                <img src="https://placehold.co/40x40/C0C0C0/333333/png?text=LICAM" onerror="this.style.display='none'" alt="Logo LICAM" class="rounded-full shadow-md">
                            </div>
                            <h1 class="text-3xl font-extrabold text-gray-800">Simposio Médico</h1>
                            <p class="text-gray-500">Evaluación de Carteles</p>
                        </div>
                        <div class="space-y-4">
                            <div>
                                <label for="username" class="block text-sm font-medium text-gray-700 mb-1">Usuario</label>
                                <input type="text" id="username" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500" value="juez1" placeholder="ej. juez1">
                            </div>
                            <div class="password-container">
                                <label for="password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                                <input type="password" id="password" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500 pr-10" value="simposio2025" placeholder="*******">
                                <span id="toggle-password-icon" class="toggle-password" title="Mostrar contraseña" style="user-select:none;">&#128584;</span>
                            </div>
                            <button id="login-btn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 transition duration-150 shadow-md">
                                Iniciar Sesión
                            </button>
                            <p id="login-error" class="text-sm text-red-600 text-center mt-2"></p>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('toggle-password-icon').addEventListener('click', togglePasswordVisibility);
        };

        const showDashboard = (userId) => {
            if (!judgeData) return showLogin();

            document.getElementById('app-container').innerHTML = `
                <div class="min-h-screen bg-gray-50">
                    <header class="bg-white shadow-md p-4 sticky top-0 z-10">
                        <div class="flex justify-between items-center max-w-6xl mx-auto">
                            <h1 class="text-xl font-bold text-gray-800">Evaluación de Carteles</h1>
                            <div class="flex items-center space-x-4">
                                <span class="hidden sm:inline text-sm text-gray-600">Juez: ${judgeData.name} (${judgeData.id})</span>
                                <button id="export-csv-btn" class="text-xs bg-blue-500 text-white px-3 py-1 rounded-full hover:bg-blue-600 transition shadow-sm">
                                    Exportar Evaluaciones (CSV)
                                </button>
                                <button id="logout-btn" class="text-sm bg-red-500 text-white px-3 py-1 rounded-full hover:bg-red-600 transition shadow-sm">Salir</button>
                            </div>
                        </div>
                    </header>
                    <main class="max-w-6xl mx-auto p-4 sm:p-6 lg:p-8">
                        <h2 class="text-2xl font-semibold text-gray-800 mb-6">Mis Trabajos Asignados</h2>
                        <div id="poster-list" class="space-y-4">
                            <!-- Lista de carteles cargada dinámicamente -->
                        </div>
                    </main>
                </div>
            `;

            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('export-csv-btn').addEventListener('click', exportEvaluationsToCSV);
            loadAssignedPosters(userId);
        };

        // ---------------- CARGAR TRABAJOS ASIGNADOS ----------------
        const loadAssignedPosters = (judgeId) => {
            const listContainer = document.getElementById('poster-list');
            listContainer.innerHTML = '<div class="text-center py-8 text-gray-500">Cargando trabajos...</div>';

            const staticJudgeId = judgeData?.id;
            if (!staticJudgeId) {
                listContainer.innerHTML = '<div class="text-center py-8 text-red-500">Error: No se encontró la ID de asignación del juez.</div>';
                return;
            }

            const assignedPosters = predefinedPosters.filter(p => p.assignedTo === staticJudgeId);
            if (assignedPosters.length === 0) {
                listContainer.innerHTML = '<div class="text-center py-8 text-gray-500">No tiene trabajos asignados para evaluar.</div>';
                return;
            }

            // Para cada póster, leer la evaluación (si existe) y mostrar tarjeta
            assignedPosters.forEach(poster => {
                // Doc path: artifacts/{appId}/users/{judgeId}/evaluations/{posterId}
                const docRef = (db && typeof doc === 'function') ? doc(db, `artifacts/${appId}/users/${staticJudgeId}/evaluations`, poster.id) : null;

                if (docRef && typeof onSnapshot === 'function') {
                    // Usar onSnapshot si Firestore está inicializado
                    onSnapshot(docRef, (docSnap) => {
                        const evaluationData = docSnap.exists() ? docSnap.data() : null;
                        renderOrUpdatePosterCard(poster, evaluationData);
                    }, (error) => {
                        console.warn(`Error fetching evaluation for poster ${poster.id}:`, error);
                        renderOrUpdatePosterCard(poster, null, true);
                    });
                } else {
                    // Firestore no configurado: mostramos tarjetas estáticas (sin puntuación guardada)
                    renderOrUpdatePosterCard(poster, null);
                }
            });
        };

        const renderOrUpdatePosterCard = (poster, evaluationData, hasError=false) => {
            const listContainer = document.getElementById('poster-list');
            if (!listContainer) return;

            const totalScore = evaluationData ? evaluationData.totalScore : 'N/A';
            const isEvaluated = !!evaluationData;
            const statusText = isEvaluated ? 'Finalizado' : (hasError ? 'Error' : 'Evaluar');
            const scoreColor = isEvaluated ? 'bg-green-600 text-white' : 'bg-yellow-100 text-yellow-800';

            let card = document.getElementById(`poster-card-${poster.id}`);
            if (!card) {
                const newCardHTML = `
                    <div id="poster-card-${poster.id}" class="bg-white p-5 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-start sm:items-center transition hover:shadow-xl ${isEvaluated ? 'border-l-4 border-green-600' : ''}">
                        <div>
                            <p class="text-sm font-medium text-gray-500">${poster.id}</p>
                            <h3 class="text-lg font-semibold text-gray-800">${poster.title}</h3>
                        </div>
                        <div class="mt-3 sm:mt-0 flex items-center space-x-4">
                            <span class="px-3 py-1 text-xs font-medium rounded-full ${scoreColor}">
                                Puntaje: ${totalScore} / 100
                            </span>
                            <button class="evaluate-btn text-white px-4 py-2 rounded-full font-medium transition ${isEvaluated ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}"
                                    data-poster-id="${poster.id}" 
                                    data-poster-title="${poster.title}" 
                                    data-evaluation='${JSON.stringify(evaluationData || {})}'
                                    ${isEvaluated ? 'disabled' : ''}>
                                ${statusText}
                            </button>
                        </div>
                    </div>
                `;
                if (listContainer.innerHTML.includes('Cargando trabajos...')) listContainer.innerHTML = '';
                listContainer.insertAdjacentHTML('beforeend', newCardHTML);
            } else {
                // actualizar
                card.className = `bg-white p-5 rounded-xl shadow-lg flex flex-col sm:flex-row justify-between items-start sm:items-center transition hover:shadow-xl ${isEvaluated ? 'border-l-4 border-green-600' : ''}`;
                const span = card.querySelector('span');
                if (span) {
                    span.className = `px-3 py-1 text-xs font-medium rounded-full ${scoreColor}`;
                    span.textContent = `Puntaje: ${totalScore} / 100`;
                }
                const btn = card.querySelector('.evaluate-btn');
                if (btn) {
                    btn.textContent = statusText;
                    btn.dataset.evaluation = JSON.stringify(evaluationData || {});
                    btn.disabled = isEvaluated;
                    if (isEvaluated) {
                        btn.classList.replace('bg-blue-600','bg-gray-400');
                        btn.classList.add('cursor-not-allowed');
                    } else {
                        btn.classList.replace('bg-gray-400','bg-blue-600');
                        btn.classList.remove('cursor-not-allowed');
                    }
                }
            }

            // reasignar manejadores
            document.querySelectorAll('.evaluate-btn').forEach(btn => {
                btn.removeEventListener('click', handleEvaluateClick);
                if (!btn.disabled) btn.addEventListener('click', handleEvaluateClick);
            });
        };

        // ---------------- Evaluación ----------------
        const handleEvaluateClick = (event) => {
            if (event.currentTarget.disabled) return;
            const posterId = event.currentTarget.dataset.posterId;
            const posterTitle = event.currentTarget.dataset.posterTitle;
            const evaluationData = JSON.parse(event.currentTarget.dataset.evaluation || '{}');
            showEvaluationForm(posterId, posterTitle, evaluationData);
        };

        const handleInputVisualFeedback = (event) => {
            const input = event.target;
            const name = input.name;
            if (input.type === 'radio') {
                document.querySelectorAll(`input[name="${name}"]`).forEach(radio => {
                    const label = document.querySelector(`label[for="${radio.id}"]`);
                    if (label) label.classList.remove('selected');
                });
            } else if (input.type === 'number') {
                input.classList.remove('has-value');
            }
            if (input.type === 'radio' && input.checked) {
                const label = document.querySelector(`label[for="${input.id}"]`);
                if (label) label.classList.add('selected');
            } else if (input.type === 'number') {
                const value = parseInt(input.value);
                if (!isNaN(value) && value >= 0 && value <= parseInt(input.max)) {
                    input.classList.add('has-value');
                }
            }
            calculateScore();
        };

        const showEvaluationForm = (posterId, title, evaluation = {}) => {
            const formContainer = document.getElementById('app-container');

            const criteria = [
                { id: 'titulo', category: 'I. Fondo (Contenido Científico)', max: 5, type: '3-point', options: [0,3,5], name: 'Título y Afiliación', desc: 'Claridad y correcta identificación. (0, 3, o 5 puntos)' },
                { id: 'introduccion', category: 'I. Fondo (Contenido Científico)', max: 5, type: '3-point', options: [0,3,5], name: 'Introducción y Antecedentes', desc: 'Contextualización, justificación y uso de referencias. (0,3,5)' },
                { id: 'metodologia', category: 'I. Fondo (Contenido Científico)', max: 10, type: 'full', name: 'Metodología', desc: 'Detalle del diseño, muestra y procedimientos éticos.' },
                { id: 'resultados', category: 'I. Fondo (Contenido Científico)', max: 10, type: 'full', name: 'Resultados', desc: 'Presentación objetiva de datos.' },
                { id: 'conclusiones', category: 'I. Fondo (Contenido Científico)', max: 5, type: '3-point', options: [0,3,5], name: 'Conclusiones', desc: 'Derivadas de los resultados.' },
                { id: 'banner', category: 'II. Forma (Diseño y Formato)', max: 5, type: '3-point', options: [0,3,5], name: 'Banner y Elementos Mandatorios', desc: 'Inclusión de logos y requisitos.' },
                { id: 'diseno', category: 'II. Forma (Diseño y Formato)', max: 10, type: 'full', name: 'Diseño y Congruencia Visual', desc: 'Equilibrio, tipografía legible.' },
                { id: 'graficas', category: 'II. Forma (Diseño y Formato)', max: 10, type: 'full', name: 'Uso de Tablas y Gráficas', desc: 'Claridad y calidad.' },
                { id: 'referencias', category: 'II. Forma (Diseño y Formato)', max: 5, type: '3-point', options: [0,3,5], name: 'Referencias Bibliográficas', desc: 'Cumplimiento con estilo.' },
                { id: 'innovacion', category: 'III. Novedad y Presentación', max: 15, type: 'bonus', name: 'Innovación y Originalidad', desc: 'Aporta nuevo conocimiento. (BONUS)' },
                { id: 'defensa', category: 'III. Novedad y Presentación', max: 10, type: 'full', name: 'Defensa y Síntesis', desc: 'Dominio del tema y claridad.' },
                { id: 'tiempo', category: 'III. Novedad y Presentación', max: 10, type: 'deduction', name: 'Manejo del Tiempo', desc: 'Excedió el tiempo (DEDUCCIÓN).' },
                { id: 'ortografia', category: 'III. Novedad y Presentación', max: 10, type: 'deduction', name: 'Redacción y Ortografía', desc: 'Errores significativos (DEDUCCIÓN).' },
                { id: 'impacto', category: 'III. Novedad y Presentación', max: 5, type: 'full', name: 'Impacto Potencial', desc: 'Trascendencia en práctica clínica.' },
            ];

            const categoryHeaders = criteria.reduce((acc,curr)=> { if(!acc.includes(curr.category)) acc.push(curr.category); return acc; }, []);

            let formHTML = `
                <div class="min-h-screen bg-gray-50 p-4 sm:p-6 lg:p-8">
                    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl">
                        <header class="mb-6 border-b pb-4">
                            <button id="back-to-dashboard" class="text-blue-600 hover:text-blue-800 flex items-center mb-4 text-sm font-medium">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                                </svg>
                                Volver al Panel
                            </button>
                            <h2 class="text-2xl font-bold text-gray-800">${title}</h2>
                            <p class="text-md text-gray-500">ID del Cartel: ${posterId}</p>
                        </header>

                        <form id="evaluation-form" data-poster-id="${posterId}">
                            <div id="criteria-list" class="space-y-6">
                                ${categoryHeaders.map(category => `
                                    <div class="border-t pt-4">
                                        <h3 class="text-xl font-semibold text-green-700 mb-4">${category}</h3>
                                        ${criteria.filter(c => c.category === category).map(c => {
                                            const savedScore = evaluation.scores?.[c.id] !== undefined ? evaluation.scores[c.id] : '';
                                            const maxScoreText = c.type === 'deduction' ? `DEDUCCIÓN (Máx: ${c.max})` : (c.type === 'bonus' ? `BONUS (Máx: ${c.max})` : `Máx: ${c.max}`);
                                            const isMarked = savedScore !== '';

                                            let inputField = '';
                                            if (c.type === '3-point' && c.options) {
                                                inputField = `
                                                    <div class="flex space-x-2">
                                                        ${c.options.map(option => {
                                                            const isChecked = savedScore == option;
                                                            return `
                                                            <div class="flex-1">
                                                                <input type="radio" id="${c.id}-score-${option}" name="${c.id}" value="${option}" class="hidden peer" ${isChecked ? 'checked' : ''} data-max="${c.max}" data-type="${c.type}" required />
                                                                <label for="${c.id}-score-${option}" class="score-option block p-3 text-center rounded-lg font-bold text-gray-700 hover:bg-green-50 peer-checked:selected transition duration-150 ${isChecked ? 'selected' : ''}">
                                                                    ${option} Pts
                                                                </label>
                                                            </div>
                                                        `;}).join('')}
                                                    </div>
                                                `;
                                            } else {
                                                inputField = `
                                                    <input type="number" id="${c.id}-score" name="${c.id}" class="score-input ${c.type === 'deduction' ? 'border-red-400 text-red-700' : 'border-green-400 text-green-700'} ${isMarked ? 'has-value' : ''}" 
                                                           min="0" max="${c.max}" value="${savedScore}" data-max="${c.max}" data-type="${c.type}" required />
                                                `;
                                            }

                                            return `
                                                <div class="p-4 bg-gray-50 rounded-lg shadow-inner">
                                                    <div class="flex justify-between items-center mb-2">
                                                        <h4 class="text-lg font-medium text-gray-700">${c.name}</h4>
                                                        <span class="text-sm font-semibold ${c.type === 'deduction' ? 'text-red-600' : (c.type === 'bonus' ? 'text-purple-600' : 'text-green-600')}">${maxScoreText}</span>
                                                    </div>
                                                    <p class="text-xs text-gray-500 mb-3">${c.desc}</p>
                                                    ${inputField}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `).join('')}
                            </div>

                            <div class="mt-8 pt-6 border-t border-gray-200">
                                <h3 class="text-xl font-bold text-gray-800 mb-4">Puntuación Total: <span id="total-score" class="text-3xl text-blue-600">${evaluation.totalScore || '0'}</span> / 100</h3>
                                <div class="bg-blue-50 p-4 rounded-lg text-sm text-blue-800 mb-6">
                                    <p>La Puntuación Total se calcula automáticamente:</p>
                                    <ul class="list-disc list-inside mt-2">
                                        <li>Criterios Regulares (Fondo y Forma): Suma de puntos (Base 70).</li>
                                        <li>Innovación y Defensa: Suma de puntos (Base 25).</li>
                                        <li>Impacto Potencial: Suma de puntos (Base 5).</li>
                                        <li>Manejo del Tiempo y Ortografía: DEDUCCIÓN (se restan del total base).</li>
                                        <li>Máximo Base: 100 puntos. Máximo Potencial con Bonus: 120 puntos.</li>
                                    </ul>
                                </div>
                                <label for="observations" class="block text-md font-medium text-gray-700 mb-2">Observaciones y Comentarios Adicionales (Opcional)</label>
                                <textarea id="observations" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-green-500 focus:border-green-500">${evaluation.observations || ''}</textarea>

                                <button type="submit" id="save-evaluation-btn" class="mt-6 w-full bg-green-600 text-white p-4 rounded-lg font-semibold text-lg hover:bg-green-700 transition duration-150 shadow-lg">
                                    Guardar Evaluación
                                </button>
                                <p id="save-status" class="text-center mt-3 text-sm font-medium"></p>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            formContainer.innerHTML = formHTML;
            setupFormHandlers(posterId);

            document.querySelectorAll('#criteria-list input').forEach(input => {
                if (input.type === 'number' && input.value !== "") input.classList.add('has-value');
            });
        };

        const calculateScore = () => {
            const form = document.getElementById('evaluation-form');
            if (!form) return 0;
            let totalScore = 0;
            const deductionMap = { 'tiempo': 10, 'ortografia': 10 };
            const currentScores = {};

            document.querySelectorAll('#criteria-list input').forEach(input => {
                const criteriaId = input.name;
                const criteriaType = input.dataset.type;
                let score = 0;
                if (input.type === 'radio') {
                    if (input.checked) { score = parseInt(input.value) || 0; currentScores[criteriaId] = { score, criteriaType, input }; }
                } else if (input.type === 'number') {
                    score = parseInt(input.value) || 0;
                    currentScores[criteriaId] = { score, criteriaType, input };
                }
            });

            for (const criteriaId in currentScores) {
                const { score, criteriaType, input } = currentScores[criteriaId];
                if (criteriaType === 'full' || criteriaType === '3-point' || criteriaType === 'bonus') {
                    const max = parseInt(input.dataset.max) || 0;
                    totalScore += Math.min(score, max);
                } else if (criteriaType === 'deduction') {
                    const maxDeduction = deductionMap[criteriaId] || parseInt(input.dataset.max) || 0;
                    totalScore -= Math.min(score, maxDeduction);
                }
            }

            document.getElementById('total-score').textContent = totalScore;
            return totalScore;
        };

        // Enviar a Google Sheets (opcional)
        const sendDataToGoogleSheets = async (evaluationData) => {
            if (!GOOGLE_SHEETS_WEB_APP_URL || GOOGLE_SHEETS_WEB_APP_URL.includes('YOUR_WEB_APP_ID')) {
                console.warn("URL de Google Sheets no configurada (opcional).");
                return;
            }
            try {
                await fetch(GOOGLE_SHEETS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(evaluationData),
                });
            } catch (error) {
                console.error("Error enviando a Google Sheets:", error);
            }
        };

        const saveEvaluation = async (event) => {
            event.preventDefault();
            const posterId = document.getElementById('evaluation-form').dataset.posterId;
            const saveBtn = document.getElementById('save-evaluation-btn');
            const statusMsg = document.getElementById('save-status');

            if (!judgeData || !judgeData.id) {
                statusMsg.textContent = 'Error: No se ha detectado el usuario juez. Inicia sesión nuevamente.';
                statusMsg.className = 'text-center mt-3 text-sm font-medium text-red-600';
                return;
            }

            // Recolectar puntuaciones
            const scores = {};
            document.querySelectorAll('#criteria-list input').forEach(input => {
                const criteriaId = input.name;
                if (input.type === 'radio') {
                    if (input.checked) scores[criteriaId] = parseInt(input.value);
                } else if (input.type === 'number') {
                    scores[criteriaId] = parseInt(input.value) || 0;
                }
            });

            const totalScore = calculateScore();
            const observations = document.getElementById('observations').value.trim();

            const evaluationData = {
                judgeId: judgeData.id,
                judgeName: judgeData.name,
                posterId: posterId,
                posterTitle: (predefinedPosters.find(p=>p.id===posterId)?.title) || 'Título Desconocido',
                totalScore,
                scores,
                observations,
                timestamp: new Date().toISOString()
            };

            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            statusMsg.textContent = '';

            try {
                if (db && typeof setDoc === 'function') {
                    const docRef = doc(db, `artifacts/${appId}/users/${judgeData.id}/evaluations`, posterId);
                    await setDoc(docRef, evaluationData);
                } else {
                    console.warn("Firestore no inicializado. La evaluación no se guardará en la nube.");
                }

                // Intentar enviar a Google Sheets (no bloqueante)
                await sendDataToGoogleSheets(evaluationData);

                statusMsg.textContent = 'Evaluación guardada y enviada exitosamente.';
                statusMsg.className = 'text-center mt-3 text-sm font-medium text-green-600';
                saveBtn.textContent = 'Guardado';

                // Volver al dashboard
                setTimeout(()=> showDashboard(judgeData.id), 1200);
            } catch (error) {
                console.error("Error guardando evaluación:", error);
                statusMsg.textContent = 'Error al guardar la evaluación. Reintente.';
                statusMsg.className = 'text-center mt-3 text-sm font-medium text-red-600';
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Evaluación';
            }
        };

        const setupFormHandlers = (posterId) => {
            const backBtn = document.getElementById('back-to-dashboard');
            if (backBtn) backBtn.addEventListener('click', ()=> showDashboard(judgeData.id));
            document.querySelectorAll('#criteria-list input').forEach(input => {
                input.addEventListener('input', handleInputVisualFeedback);
                input.addEventListener('change', handleInputVisualFeedback);
            });
            const form = document.getElementById('evaluation-form');
            if (form) form.addEventListener('submit', saveEvaluation);
            calculateScore();
        };

        // ---------------- Exportar CSV ----------------
        const exportEvaluationsToCSV = async () => {
            if (!judgeData || !judgeData.id) { alert('Debe iniciar sesión para exportar datos.'); return; }
            const exportBtn = document.getElementById('export-csv-btn');
            exportBtn.disabled = true; exportBtn.textContent = 'Generando CSV...';

            const criteria = [
                { id: 'titulo', name: 'Titulo_Afiliacion' },
                { id: 'introduccion', name: 'Introduccion_Antecedentes' },
                { id: 'metodologia', name: 'Metodologia' },
                { id: 'resultados', name: 'Resultados' },
                { id: 'conclusiones', name: 'Conclusiones' },
                { id: 'banner', name: 'Banner_Elementos' },
                { id: 'diseno', name: 'Diseno_Visual' },
                { id: 'graficas', name: 'Tablas_Graficas' },
                { id: 'referencias', name: 'Referencias' },
                { id: 'innovacion', name: 'Innovacion_BONUS' },
                { id: 'defensa', name: 'Defensa_Sintesis' },
                { id: 'tiempo', name: 'Manejo_Tiempo_DEDUCCION' },
                { id: 'ortografia', name: 'Redaccion_Ortografia_DEDUCCION' },
                { id: 'impacto', name: 'Impacto_Potencial' },
            ];

            let csvContent = "data:text/csv;charset=utf-8,";
            let headers = ['Judge_ID','Judge_Name','Poster_ID','Poster_Title','Total_Score','Observations', ...criteria.map(c=>c.name)];
            csvContent += headers.join(',') + '\r\n';

            try {
                if (db && typeof collection === 'function' && typeof getDocs === 'function') {
                    const evaluationsColRef = collection(db, `artifacts/${appId}/users/${judgeData.id}/evaluations`);
                    const querySnapshot = await getDocs(evaluationsColRef);
                    querySnapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        const poster = predefinedPosters.find(p => p.id === data.posterId);
                        const posterTitle = poster ? poster.title.replace(/,/g,'') : 'Unknown Title';
                        let row = [
                            data.judgeId,
                            `"${data.judgeName.replace(/"/g,'""')}"`,
                            data.posterId,
                            `"${posterTitle}"`,
                            data.totalScore,
                            `"${(data.observations||'').replace(/"/g,'""').replace(/(\r\n|\n|\r)/gm,' ')}"`
                        ];
                        criteria.forEach(c => { row.push(data.scores?.[c.id] || 0); });
                        csvContent += row.join(',') + '\r\n';
                    });
                } else {
                    alert('Firestore no configurado: no hay datos para exportar.');
                }

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `evaluaciones_${judgeData.id}_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                exportBtn.textContent = 'Exportación Exitosa';
                exportBtn.classList.replace('bg-blue-500','bg-green-500');
                setTimeout(()=>{ exportBtn.disabled=false; exportBtn.textContent='Exportar Evaluaciones (CSV)'; exportBtn.classList.replace('bg-green-500','bg-blue-500'); }, 2000);
            } catch (error) {
                console.error("Error al exportar CSV:", error);
                alert('Error al exportar las evaluaciones.');
                exportBtn.disabled=false; exportBtn.textContent='Exportar Evaluaciones (CSV)';
            }
        };

        const setupUIHandlers = () => {
            // Espacio para handlers globales futuros
        };
    </script>
</head>
<body class="bg-gray-50">
    <div id="app-container" class="min-h-screen">
        <div class="flex justify-center items-center h-screen">
            <div class="text-xl text-gray-500">Iniciando aplicación...</div>
        </div>
    </div>
</body>
</html>
